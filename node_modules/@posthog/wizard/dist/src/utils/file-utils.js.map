{"version":3,"file":"file-utils.js","sourceRoot":"","sources":["../../../src/utils/file-utils.ts"],"names":[],"mappings":"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","sourcesContent":["import path from 'path';\nimport fs from 'fs';\nimport type { CloudRegion, FileChange, WizardOptions } from './types';\nimport clack from './clack';\nimport z from 'zod';\nimport { query } from './query';\nimport fg from 'fast-glob';\nimport { analytics } from './analytics';\nimport { Integration } from '../lib/constants';\nimport { abort } from './clack-utils';\nimport { INTEGRATION_CONFIG } from '../lib/config';\nimport {\n  baseFilterFilesPromptTemplate,\n  baseGenerateFileChangesPromptTemplate,\n} from '../lib/prompts';\n\nexport const GLOBAL_IGNORE_PATTERN = [\n  'node_modules',\n  'dist',\n  'build',\n  'public',\n  'static',\n  '.git',\n  '.next',\n];\nexport async function getAllFilesInProject(dir: string): Promise<string[]> {\n  let results: string[] = [];\n\n  const entries = await fs.promises.readdir(dir, { withFileTypes: true });\n\n  for (const entry of entries) {\n    const fullPath = path.join(dir, entry.name);\n\n    if (GLOBAL_IGNORE_PATTERN.some((pattern) => fullPath.includes(pattern))) {\n      continue;\n    }\n\n    if (entry.isDirectory()) {\n      // Recursively get files from subdirectories\n      const subDirFiles = await getAllFilesInProject(fullPath);\n      results = results.concat(subDirFiles);\n    } else {\n      results.push(fullPath);\n    }\n  }\n\n  return results;\n}\n\nexport function getDotGitignore({\n  installDir,\n}: Pick<WizardOptions, 'installDir'>) {\n  const gitignorePath = path.join(installDir, '.gitignore');\n  const gitignoreExists = fs.existsSync(gitignorePath);\n\n  if (gitignoreExists) {\n    return gitignorePath;\n  }\n\n  return undefined;\n}\n\nexport async function updateFile(\n  change: FileChange,\n  { installDir }: Pick<WizardOptions, 'installDir'>,\n) {\n  const dir = path.dirname(path.join(installDir, change.filePath));\n  await fs.promises.mkdir(dir, { recursive: true });\n  await fs.promises.writeFile(\n    path.join(installDir, change.filePath),\n    change.newContent,\n  );\n}\n\nexport async function getFilesToChange({\n  integration,\n  relevantFiles,\n  documentation,\n  accessToken,\n  cloudRegion,\n  projectId,\n}: {\n  integration: Integration;\n  relevantFiles: string[];\n  documentation: string;\n  accessToken: string;\n  cloudRegion: CloudRegion;\n  projectId: number;\n}) {\n  const filterFilesSpinner = clack.spinner();\n\n  filterFilesSpinner.start('Selecting files to change...');\n\n  const filterFilesResponseSchmea = z.object({\n    files: z.array(z.string()),\n  });\n\n  const prompt = await baseFilterFilesPromptTemplate.format({\n    documentation,\n    file_list: relevantFiles.join('\\n'),\n    integration_name: integration,\n    integration_rules: INTEGRATION_CONFIG[integration].filterFilesRules,\n  });\n\n  const filterFilesResponse = await query({\n    message: prompt,\n    schema: filterFilesResponseSchmea,\n    accessToken,\n    region: cloudRegion,\n    projectId,\n  });\n\n  const filesToChange = filterFilesResponse.files;\n\n  filterFilesSpinner.stop(`Found ${filesToChange.length} files to change`);\n\n  analytics.capture('wizard interaction', {\n    action: 'detected files to change',\n    integration,\n    files: filesToChange,\n  });\n\n  return filesToChange;\n}\n\nexport async function generateFileContent({\n  prompt,\n  accessToken,\n  cloudRegion,\n  projectId,\n}: {\n  prompt: string;\n  accessToken: string;\n  cloudRegion: CloudRegion;\n  projectId: number;\n}) {\n  const response = await query({\n    message: prompt,\n    schema: z.object({\n      newContent: z.string(),\n    }),\n    accessToken: accessToken,\n    region: cloudRegion,\n    projectId,\n  });\n\n  return response.newContent;\n}\n\nexport async function generateFileChangesForIntegration({\n  integration,\n  filesToChange,\n  accessToken,\n  documentation,\n  installDir,\n  cloudRegion,\n  projectId,\n}: {\n  integration: Integration;\n  filesToChange: string[];\n  accessToken: string;\n  documentation: string;\n  installDir: string;\n  cloudRegion: CloudRegion;\n  projectId: number;\n}) {\n  const changes: FileChange[] = [];\n\n  for (const filePath of filesToChange) {\n    const fileChangeSpinner = clack.spinner();\n\n    analytics.capture('wizard interaction', {\n      action: 'processing file',\n      integration,\n      file: filePath,\n    });\n\n    try {\n      let oldContent = undefined;\n      try {\n        oldContent = await fs.promises.readFile(\n          path.join(installDir, filePath),\n          'utf8',\n        );\n      } catch (readError) {\n        if (readError.code !== 'ENOENT') {\n          await abort(`Error reading file ${filePath}`);\n          continue;\n        }\n      }\n\n      fileChangeSpinner.start(\n        `${oldContent ? 'Updating' : 'Creating'} file ${filePath}`,\n      );\n\n      const unchangedFiles = filesToChange.filter(\n        (filePath) => !changes.some((change) => change.filePath === filePath),\n      );\n\n      const prompt = await baseGenerateFileChangesPromptTemplate.format({\n        file_content: oldContent,\n        file_path: filePath,\n        documentation,\n        integration_name: INTEGRATION_CONFIG[integration].name,\n        integration_rules: INTEGRATION_CONFIG[integration].generateFilesRules,\n        changed_files: changes\n          .map((change) => `${change.filePath}\\n${change.newContent}`)\n          .join('\\n'),\n        unchanged_files: unchangedFiles,\n      });\n\n      const newContent = await generateFileContent({\n        prompt,\n        accessToken,\n        cloudRegion,\n        projectId,\n      });\n\n      if (newContent !== oldContent) {\n        await updateFile({ filePath, oldContent, newContent }, { installDir });\n        changes.push({ filePath, oldContent, newContent });\n      }\n\n      fileChangeSpinner.stop(\n        `${oldContent ? 'Updated' : 'Created'} file ${filePath}`,\n      );\n\n      analytics.capture('wizard interaction', {\n        action: 'processed file',\n        integration,\n        file: filePath,\n      });\n    } catch (error) {\n      await abort(`Error processing file ${filePath}`);\n    }\n  }\n\n  analytics.capture('wizard interaction', {\n    action: 'completed file changes',\n    integration,\n    files: filesToChange,\n  });\n\n  return changes;\n}\n\nexport async function getRelevantFilesForIntegration({\n  installDir,\n  integration,\n}: Pick<WizardOptions, 'installDir'> & {\n  integration: Integration;\n}) {\n  const filterPatterns = INTEGRATION_CONFIG[integration].filterPatterns;\n  const ignorePatterns = INTEGRATION_CONFIG[integration].ignorePatterns;\n\n  const filteredFiles = await fg(filterPatterns, {\n    cwd: installDir,\n    ignore: ignorePatterns,\n  });\n\n  analytics.capture('wizard interaction', {\n    action: 'detected relevant files',\n    integration,\n    number_of_files: filteredFiles.length,\n  });\n\n  return filteredFiles;\n}\n"]}