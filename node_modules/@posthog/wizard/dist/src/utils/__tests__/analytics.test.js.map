{"version":3,"file":"analytics.test.js","sourceRoot":"","sources":["../../../../src/utils/__tests__/analytics.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { Analytics } from '../analytics';\nimport { PostHog } from 'posthog-node';\nimport { v4 as uuidv4 } from 'uuid';\n\njest.mock('posthog-node');\njest.mock('uuid');\n\nconst mockUuidv4 = uuidv4 as jest.MockedFunction<typeof uuidv4>;\nconst MockedPostHog = PostHog as jest.MockedClass<typeof PostHog>;\n\ndescribe('Analytics', () => {\n  let analytics: Analytics;\n  let mockPostHogInstance: jest.Mocked<PostHog>;\n\n  beforeEach(() => {\n    jest.clearAllMocks();\n    mockUuidv4.mockReturnValue('test-uuid' as any);\n\n    mockPostHogInstance = {\n      capture: jest.fn(),\n      captureException: jest.fn(),\n      alias: jest.fn(),\n      shutdown: jest.fn().mockResolvedValue(undefined),\n    } as any;\n\n    MockedPostHog.mockImplementation(() => mockPostHogInstance);\n\n    analytics = new Analytics();\n  });\n\n  describe('captureException', () => {\n    it('should capture exception with error object and properties', () => {\n      const error = new Error('Test error');\n      const properties = { integration: 'nextjs' };\n\n      analytics.captureException(error, properties);\n\n      expect(mockPostHogInstance.captureException).toHaveBeenCalledWith(\n        error,\n        'test-uuid',\n        {\n          team: 'growth',\n          $app_name: 'wizard',\n          ...properties,\n        },\n      );\n    });\n\n    it('should capture exception with tags included in properties', () => {\n      const error = new Error('Test error');\n      const properties = { integration: 'nextjs' };\n\n      analytics.setTag('testTag', 'testValue');\n      analytics.captureException(error, properties);\n\n      expect(mockPostHogInstance.captureException).toHaveBeenCalledWith(\n        error,\n        'test-uuid',\n        {\n          team: 'growth',\n          $app_name: 'wizard',\n          testTag: 'testValue',\n          ...properties,\n        },\n      );\n    });\n\n    it('should capture exception with distinct ID when set', () => {\n      const error = new Error('Test error');\n      const distinctId = 'user-123';\n\n      analytics.setDistinctId(distinctId);\n      analytics.captureException(error);\n\n      expect(mockPostHogInstance.captureException).toHaveBeenCalledWith(\n        error,\n        distinctId,\n        {\n          team: 'growth',\n          $app_name: 'wizard',\n        },\n      );\n    });\n\n    it('should capture exception without properties when not provided', () => {\n      const error = new Error('Test error');\n\n      analytics.captureException(error);\n\n      expect(mockPostHogInstance.captureException).toHaveBeenCalledWith(\n        error,\n        'test-uuid',\n        {\n          team: 'growth',\n          $app_name: 'wizard',\n        },\n      );\n    });\n\n    it('should merge tags with provided properties', () => {\n      const error = new Error('Test error');\n      const properties = { integration: 'nextjs', step: 'installation' };\n\n      analytics.setTag('environment', 'test');\n      analytics.setTag('version', '1.0.0');\n      analytics.captureException(error, properties);\n\n      expect(mockPostHogInstance.captureException).toHaveBeenCalledWith(\n        error,\n        'test-uuid',\n        {\n          team: 'growth',\n          $app_name: 'wizard',\n          environment: 'test',\n          version: '1.0.0',\n          integration: 'nextjs',\n          step: 'installation',\n        },\n      );\n    });\n\n    it('should override tags with properties when keys conflict', () => {\n      const error = new Error('Test error');\n      const properties = { integration: 'react' };\n\n      analytics.setTag('integration', 'nextjs');\n      analytics.captureException(error, properties);\n\n      expect(mockPostHogInstance.captureException).toHaveBeenCalledWith(\n        error,\n        'test-uuid',\n        {\n          team: 'growth',\n          $app_name: 'wizard',\n          integration: 'react',\n        },\n      );\n    });\n\n    it('should always include team:growth property in exceptions', () => {\n      const error = new Error('Test error');\n\n      analytics.captureException(error);\n\n      expect(mockPostHogInstance.captureException).toHaveBeenCalledWith(\n        error,\n        'test-uuid',\n        {\n          team: 'growth',\n          $app_name: 'wizard',\n        },\n      );\n    });\n  });\n\n  describe('integration with other methods', () => {\n    it('should work correctly with setTag and captureException', () => {\n      const error = new Error('Test error');\n\n      analytics.setTag('integration', 'nextjs');\n      analytics.setTag('forceInstall', true);\n      analytics.setTag('debug', false);\n\n      analytics.captureException(error, {\n        arguments: JSON.stringify({ installDir: '/test' }),\n        step: 'wizard-execution',\n      });\n\n      expect(mockPostHogInstance.captureException).toHaveBeenCalledWith(\n        error,\n        'test-uuid',\n        {\n          team: 'growth',\n          $app_name: 'wizard',\n          integration: 'nextjs',\n          forceInstall: true,\n          debug: false,\n          arguments: JSON.stringify({ installDir: '/test' }),\n          step: 'wizard-execution',\n        },\n      );\n    });\n\n    it('should work correctly with setDistinctId and captureException', () => {\n      const error = new Error('Test error');\n      const distinctId = 'user-456';\n\n      analytics.setDistinctId(distinctId);\n      analytics.setTag('integration', 'svelte');\n      analytics.captureException(error);\n\n      expect(mockPostHogInstance.captureException).toHaveBeenCalledWith(\n        error,\n        distinctId,\n        {\n          team: 'growth',\n          $app_name: 'wizard',\n          integration: 'svelte',\n        },\n      );\n    });\n  });\n});\n"]}