{"version":3,"file":"package-manager.js","sourceRoot":"","sources":["../../../src/utils/package-manager.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-disable @typescript-eslint/typedef */\nimport * as fs from 'fs';\nimport * as path from 'path';\nimport { traceStep } from '../telemetry';\nimport { getPackageDotJson, updatePackageDotJson } from './clack-utils';\nimport { analytics } from './analytics';\nimport type { WizardOptions } from './types';\n\nexport interface PackageManager {\n  name: string;\n  label: string;\n  installCommand: string;\n  buildCommand: string;\n  /* The command that the package manager uses to run a script from package.json */\n  runScriptCommand: string;\n  flags: string;\n  forceInstallFlag: string;\n  detect: ({ installDir }: Pick<WizardOptions, 'installDir'>) => boolean;\n  addOverride: (\n    pkgName: string,\n    pkgVersion: string,\n    { installDir }: Pick<WizardOptions, 'installDir'>,\n  ) => Promise<void>;\n}\n\nexport const BUN: PackageManager = {\n  name: 'bun',\n  label: 'Bun',\n  installCommand: 'bun add',\n  buildCommand: 'bun run build',\n  runScriptCommand: 'bun run',\n  flags: '',\n  forceInstallFlag: '--force',\n  detect: ({ installDir }: Pick<WizardOptions, 'installDir'>) =>\n    ['bun.lockb', 'bun.lock'].some((lockFile) =>\n      fs.existsSync(path.join(installDir, lockFile)),\n    ),\n  addOverride: async (\n    pkgName,\n    pkgVersion,\n    { installDir }: Pick<WizardOptions, 'installDir'>,\n  ): Promise<void> => {\n    const packageDotJson = await getPackageDotJson({ installDir });\n    const overrides = packageDotJson.overrides || {};\n\n    await updatePackageDotJson(\n      {\n        ...packageDotJson,\n        overrides: {\n          ...overrides,\n          [pkgName]: pkgVersion,\n        },\n      },\n      { installDir: installDir },\n    );\n  },\n};\nexport const YARN_V1: PackageManager = {\n  name: 'yarn',\n  label: 'Yarn V1',\n  installCommand: 'yarn add',\n  buildCommand: 'yarn build',\n  runScriptCommand: 'yarn',\n  flags: '--ignore-workspace-root-check',\n  forceInstallFlag: '--force',\n  detect: ({ installDir }: Pick<WizardOptions, 'installDir'>) => {\n    try {\n      return fs\n        .readFileSync(path.join(installDir, 'yarn.lock'), 'utf-8')\n        .slice(0, 500)\n        .includes('yarn lockfile v1');\n    } catch (e) {\n      return false;\n    }\n  },\n  addOverride: async (\n    pkgName,\n    pkgVersion,\n    { installDir }: Pick<WizardOptions, 'installDir'>,\n  ): Promise<void> => {\n    const packageDotJson = await getPackageDotJson({ installDir });\n    const resolutions = packageDotJson.resolutions || {};\n\n    await updatePackageDotJson(\n      {\n        ...packageDotJson,\n        resolutions: {\n          ...resolutions,\n          [pkgName]: pkgVersion,\n        },\n      },\n      { installDir },\n    );\n  },\n};\n/** YARN V2/3/4 */\nexport const YARN_V2: PackageManager = {\n  name: 'yarn',\n  label: 'Yarn V2/3/4',\n  installCommand: 'yarn add',\n  buildCommand: 'yarn build',\n  runScriptCommand: 'yarn',\n  flags: '',\n  forceInstallFlag: '--force',\n  detect: ({ installDir }: Pick<WizardOptions, 'installDir'>) => {\n    try {\n      return fs\n        .readFileSync(path.join(installDir, 'yarn.lock'), 'utf-8')\n        .slice(0, 500)\n        .includes('__metadata');\n    } catch (e) {\n      return false;\n    }\n  },\n  addOverride: async (\n    pkgName,\n    pkgVersion,\n    { installDir }: Pick<WizardOptions, 'installDir'>,\n  ): Promise<void> => {\n    const packageDotJson = await getPackageDotJson({ installDir });\n    const resolutions = packageDotJson.resolutions || {};\n\n    await updatePackageDotJson(\n      {\n        ...packageDotJson,\n        resolutions: {\n          ...resolutions,\n          [pkgName]: pkgVersion,\n        },\n      },\n      { installDir },\n    );\n  },\n};\nexport const PNPM: PackageManager = {\n  name: 'pnpm',\n  label: 'pnpm',\n  installCommand: 'pnpm add',\n  buildCommand: 'pnpm build',\n  runScriptCommand: 'pnpm',\n  flags: '--ignore-workspace-root-check',\n  forceInstallFlag: '--force',\n  detect: ({ installDir }: Pick<WizardOptions, 'installDir'>) =>\n    fs.existsSync(path.join(installDir, 'pnpm-lock.yaml')),\n  addOverride: async (\n    pkgName,\n    pkgVersion,\n    { installDir }: Pick<WizardOptions, 'installDir'>,\n  ): Promise<void> => {\n    const packageDotJson = await getPackageDotJson({ installDir });\n    const pnpm = packageDotJson.pnpm || {};\n    const overrides = pnpm.overrides || {};\n\n    await updatePackageDotJson(\n      {\n        ...packageDotJson,\n        pnpm: {\n          ...pnpm,\n          overrides: {\n            ...overrides,\n            [pkgName]: pkgVersion,\n          },\n        },\n      },\n      { installDir },\n    );\n  },\n};\nexport const NPM: PackageManager = {\n  name: 'npm',\n  label: 'npm',\n  installCommand: 'npm add',\n  buildCommand: 'npm run build',\n  runScriptCommand: 'npm run',\n  flags: '',\n  forceInstallFlag: '--force',\n  detect: ({ installDir }: Pick<WizardOptions, 'installDir'>) =>\n    fs.existsSync(path.join(installDir, 'package-lock.json')),\n  addOverride: async (\n    pkgName,\n    pkgVersion,\n    { installDir }: Pick<WizardOptions, 'installDir'>,\n  ): Promise<void> => {\n    const packageDotJson = await getPackageDotJson({ installDir });\n    const overrides = packageDotJson.overrides || {};\n\n    await updatePackageDotJson(\n      {\n        ...packageDotJson,\n        overrides: {\n          ...overrides,\n          [pkgName]: pkgVersion,\n        },\n      },\n      { installDir },\n    );\n  },\n};\n\nexport const EXPO: PackageManager = {\n  name: 'expo',\n  label: 'Expo',\n  installCommand: 'npx expo install',\n  buildCommand: 'npx expo build',\n  runScriptCommand: 'npx expo run',\n  flags: '',\n  forceInstallFlag: '--force',\n  detect: () => false,\n  addOverride: async (\n    pkgName,\n    pkgVersion,\n    { installDir }: Pick<WizardOptions, 'installDir'>,\n  ): Promise<void> => {\n    const packageDotJson = await getPackageDotJson({ installDir });\n    const overrides = packageDotJson.overrides || {};\n\n    await updatePackageDotJson(\n      {\n        ...packageDotJson,\n        overrides: {\n          ...overrides,\n          [pkgName]: pkgVersion,\n        },\n      },\n      { installDir },\n    );\n  },\n};\n\nexport const packageManagers = [BUN, YARN_V1, YARN_V2, PNPM, NPM, EXPO];\n\nexport function detectAllPackageManagers({\n  installDir,\n}: Pick<WizardOptions, 'installDir'>): PackageManager[] {\n  return traceStep('detect-package-manager', () => {\n    const detectedManagers: PackageManager[] = [];\n    for (const packageManager of packageManagers) {\n      if (packageManager.detect({ installDir })) {\n        detectedManagers.push(packageManager);\n      }\n    }\n\n    if (detectedManagers.length === 0) {\n      analytics.setTag('package-manager', 'not-detected');\n    }\n    return detectedManagers;\n  });\n}\n"]}