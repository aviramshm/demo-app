{"version":3,"file":"query.js","sourceRoot":"","sources":["../../../src/utils/query.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,kDAA0B;AAE1B,2DAAqD;AAErD,iCAA+C;AAC/C,2CAAwC;AACxC,iCAAmC;AACnC,mCAAgC;AAChC,qCAA0C;AAC1C,oDAAsC;AAEtC,MAAM,eAAe,GAAG,GAAG,EAAE;IAC3B,MAAM,WAAW,GAAG,MAAM,CAAC,WAAW,CAAC,EAAE,CAAC,CAAC;IAC3C,OAAO,MAAM,CAAC,UAAU,CAAC,QAAQ,CAAC,CAAC,MAAM,CAAC,WAAW,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;AACvE,CAAC,CAAC;AAEF,MAAM,QAAQ,GAAG,eAAe,EAAE,CAAC;AAW5B,MAAM,KAAK,GAAG,KAAK,EAAK,EAC7B,OAAO,EACP,KAAK,GAAG,SAAS,EACjB,MAAM,EACN,MAAM,EACN,WAAW,EACX,SAAS,EAAE,CAAC,EAAE,iFAAiF;EAC/E,EAAc,EAAE;IAChC,MAAM,UAAU,GAAG,IAAA,oCAAe,EAAC,MAAM,EAAE,QAAQ,CAAC,CAAC;IACrD,MAAM,UAAU,GAAG,UAAU,CAAC,WAAW,CAAC;IAE1C,IAAA,aAAK,EAAC,cAAc,EAAE,IAAI,CAAC,SAAS,CAAC,UAAU,EAAE,IAAI,EAAE,CAAC,CAAC,CAAC,CAAC;IAC3D,IAAA,aAAK,EAAC,gBAAgB,EAAE;QACtB,GAAG,EAAE,GAAG,IAAA,4BAAqB,EAAC,MAAM,CAAC,mBAAmB;QACxD,WAAW;QACX,OAAO,EAAE,OAAO,CAAC,SAAS,CAAC,CAAC,EAAE,GAAG,CAAC,GAAG,KAAK;QAC1C,WAAW,EAAE,EAAE,GAAG,UAAU,EAAE,IAAI,EAAE,QAAQ,EAAE,MAAM,EAAE,IAAI,EAAE;KAC7D,CAAC,CAAC;IAEH,MAAM,QAAQ,GAAG,MAAM,eAAK;SACzB,IAAI,CACH,GAAG,IAAA,4BAAqB,EAAC,MAAM,CAAC,mBAAmB,EACnD;QACE,OAAO;QACP,KAAK;QACL,WAAW,EAAE,EAAE,GAAG,UAAU,EAAE,IAAI,EAAE,QAAQ,EAAE,MAAM,EAAE,IAAI,EAAE;KAC7D,EACD;QACE,OAAO,EAAE;YACP,aAAa,EAAE,UAAU,WAAW,EAAE;YACtC,oBAAoB,EAAE,QAAQ;YAC9B,GAAG,CAAC,OAAO,CAAC,GAAG,CAAC,eAAe,KAAK,MAAM;gBACxC,CAAC,CAAC,EAAE,qCAAqC,EAAE,IAAI,EAAE;gBACjD,CAAC,CAAC,EAAE,CAAC;SACR;KACF,CACF;SACA,KAAK,CAAC,CAAC,KAAK,EAAE,EAAE;QACf,IAAA,aAAK,EAAC,cAAc,EAAE,KAAK,CAAC,CAAC;QAE7B,IAAI,KAAK,YAAY,kBAAU,EAAE,CAAC;YAChC,qBAAS,CAAC,gBAAgB,CAAC,KAAK,EAAE;gBAChC,oBAAoB,EAAE,KAAK,CAAC,QAAQ,EAAE,MAAM;gBAC5C,OAAO;gBACP,KAAK;gBACL,WAAW,EAAE,UAAU;gBACvB,IAAI,EAAE,oBAAoB;aAC3B,CAAC,CAAC;YAEH,IAAI,KAAK,CAAC,QAAQ,EAAE,MAAM,KAAK,GAAG,EAAE,CAAC;gBACnC,MAAM,IAAI,uBAAc,EAAE,CAAC;YAC7B,CAAC;QACH,CAAC;QAED,MAAM,KAAK,CAAC;IACd,CAAC,CAAC,CAAC;IAEL,IAAA,aAAK,EAAC,iBAAiB,EAAE;QACvB,MAAM,EAAE,QAAQ,CAAC,MAAM;QACvB,IAAI,EAAE,QAAQ,CAAC,IAAI;KACpB,CAAC,CAAC;IAEH,MAAM,UAAU,GAAG,MAAM,CAAC,SAAS,CAAC,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;IAExD,IAAI,CAAC,UAAU,CAAC,OAAO,EAAE,CAAC;QACxB,IAAA,aAAK,EAAC,mBAAmB,EAAE,UAAU,CAAC,KAAK,CAAC,CAAC;QAC7C,MAAM,IAAI,KAAK,CACb,iCAAiC,UAAU,CAAC,KAAK,CAAC,OAAO,EAAE,CAC5D,CAAC;IACJ,CAAC;IAED,IAAI,OAAO,CAAC,GAAG,CAAC,QAAQ,KAAK,MAAM,EAAE,CAAC;QACpC,MAAM,EAAE,cAAc,EAAE,GAAG,MAAM,MAAM,CACrC,0CAA0C,CAC3C,CAAC;QAEF,MAAM,WAAW,GAAG,IAAI,CAAC,SAAS,CAAC;YACjC,OAAO;YACP,KAAK;YACL,WAAW,EAAE,EAAE,GAAG,UAAU,EAAE,IAAI,EAAE,QAAQ,EAAE,MAAM,EAAE,IAAI,EAAE;SAC7D,CAAC,CAAC;QAEH,cAAc,CAAC,gBAAgB,CAAC,WAAW,EAAE,UAAU,CAAC,IAAI,CAAC,CAAC;IAChE,CAAC;IAED,OAAO,UAAU,CAAC,IAAI,CAAC;AACzB,CAAC,CAAC;AAtFW,QAAA,KAAK,SAsFhB","sourcesContent":["import axios from 'axios';\nimport type { ZodSchema } from 'zod';\nimport { zodToJsonSchema } from 'zod-to-json-schema';\nimport type { AIModel, CloudRegion } from './types';\nimport { getCloudUrlFromRegion } from './urls';\nimport { analytics } from './analytics';\nimport { AxiosError } from 'axios';\nimport { debug } from './debug';\nimport { RateLimitError } from './errors';\nimport * as crypto from 'node:crypto';\n\nconst generateTraceId = () => {\n  const randomBytes = crypto.randomBytes(32);\n  return crypto.createHash('sha256').update(randomBytes).digest('hex');\n};\n\nconst TRACE_ID = generateTraceId();\n\nexport interface QueryOptions<S> {\n  message: string;\n  model?: AIModel;\n  region: CloudRegion;\n  schema: ZodSchema<S>;\n  accessToken: string;\n  projectId: number;\n}\n\nexport const query = async <S>({\n  message,\n  model = 'o4-mini',\n  region,\n  schema,\n  accessToken,\n  projectId: _, // TODO: Use this to switch the wizard query endpoint over to the new LLM Gateway\n}: QueryOptions<S>): Promise<S> => {\n  const fullSchema = zodToJsonSchema(schema, 'schema');\n  const jsonSchema = fullSchema.definitions;\n\n  debug('Full schema:', JSON.stringify(fullSchema, null, 2));\n  debug('Query request:', {\n    url: `${getCloudUrlFromRegion(region)}/api/wizard/query`,\n    accessToken,\n    message: message.substring(0, 100) + '...',\n    json_schema: { ...jsonSchema, name: 'schema', strict: true },\n  });\n\n  const response = await axios\n    .post<{ data: unknown }>(\n      `${getCloudUrlFromRegion(region)}/api/wizard/query`,\n      {\n        message,\n        model,\n        json_schema: { ...jsonSchema, name: 'schema', strict: true },\n      },\n      {\n        headers: {\n          Authorization: `Bearer ${accessToken}`,\n          'X-PostHog-Trace-Id': TRACE_ID,\n          ...(process.env.RECORD_FIXTURES === 'true'\n            ? { 'X-PostHog-Wizard-Fixture-Generation': true }\n            : {}),\n        },\n      },\n    )\n    .catch((error) => {\n      debug('Query error:', error);\n\n      if (error instanceof AxiosError) {\n        analytics.captureException(error, {\n          response_status_code: error.response?.status,\n          message,\n          model,\n          json_schema: jsonSchema,\n          type: 'wizard_query_error',\n        });\n\n        if (error.response?.status === 429) {\n          throw new RateLimitError();\n        }\n      }\n\n      throw error;\n    });\n\n  debug('Query response:', {\n    status: response.status,\n    data: response.data,\n  });\n\n  const validation = schema.safeParse(response.data.data);\n\n  if (!validation.success) {\n    debug('Validation error:', validation.error);\n    throw new Error(\n      `Invalid response from wizard: ${validation.error.message}`,\n    );\n  }\n\n  if (process.env.NODE_ENV === 'test') {\n    const { fixtureTracker } = await import(\n      '../../e2e-tests/mocks/fixture-tracker.js'\n    );\n\n    const requestBody = JSON.stringify({\n      message,\n      model,\n      json_schema: { ...jsonSchema, name: 'schema', strict: true },\n    });\n\n    fixtureTracker.saveQueryFixture(requestBody, validation.data);\n  }\n\n  return validation.data;\n};\n"]}