{"version":3,"file":"run.js","sourceRoot":"","sources":["../../src/run.ts"],"names":[],"mappings":"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","sourcesContent":["import { abortIfCancelled, getPackageDotJson } from './utils/clack-utils';\n\nimport { runNextjsWizard } from './nextjs/nextjs-wizard';\nimport { runNextjsWizardAgent } from './nextjs/nextjs-wizard-agent';\nimport type { CloudRegion, WizardOptions } from './utils/types';\n\nimport {\n  getIntegrationDescription,\n  Integration,\n  FeatureFlagDefinition,\n  WizardVariant,\n} from './lib/constants';\nimport { readEnvironment } from './utils/environment';\nimport clack from './utils/clack';\nimport path from 'path';\nimport { INTEGRATION_CONFIG, INTEGRATION_ORDER } from './lib/config';\nimport { runReactWizard } from './react/react-wizard';\nimport { analytics } from './utils/analytics';\nimport { runSvelteWizard } from './svelte/svelte-wizard';\nimport { runReactNativeWizard } from './react-native/react-native-wizard';\nimport { runAstroWizard } from './astro/astro-wizard';\nimport { EventEmitter } from 'events';\nimport chalk from 'chalk';\nimport { RateLimitError } from './utils/errors';\nimport { getPackageVersion } from './utils/package-json';\nimport * as semver from 'semver';\n\nEventEmitter.defaultMaxListeners = 50;\n\ntype Args = {\n  integration?: Integration;\n  debug?: boolean;\n  forceInstall?: boolean;\n  installDir?: string;\n  region?: CloudRegion;\n  default?: boolean;\n  signup?: boolean;\n};\n\nexport async function runWizard(argv: Args) {\n  const finalArgs = {\n    ...argv,\n    ...readEnvironment(),\n  };\n\n  let resolvedInstallDir: string;\n  if (finalArgs.installDir) {\n    if (path.isAbsolute(finalArgs.installDir)) {\n      resolvedInstallDir = finalArgs.installDir;\n    } else {\n      resolvedInstallDir = path.join(process.cwd(), finalArgs.installDir);\n    }\n  } else {\n    resolvedInstallDir = process.cwd();\n  }\n\n  const wizardOptions: WizardOptions = {\n    debug: finalArgs.debug ?? false,\n    forceInstall: finalArgs.forceInstall ?? false,\n    installDir: resolvedInstallDir,\n    cloudRegion: finalArgs.region ?? undefined,\n    default: finalArgs.default ?? false,\n    signup: finalArgs.signup ?? false,\n  };\n\n  clack.intro(`Welcome to the PostHog setup wizard âœ¨`);\n\n  const integration =\n    finalArgs.integration ?? (await getIntegrationForSetup(wizardOptions));\n\n  analytics.setTag('integration', integration);\n\n  try {\n    switch (integration) {\n      case Integration.nextjs:\n        await chooseNextjsWizard(wizardOptions);\n        break;\n      case Integration.react:\n        await runReactWizard(wizardOptions);\n        break;\n      case Integration.svelte:\n        await runSvelteWizard(wizardOptions);\n        break;\n      case Integration.reactNative:\n        await runReactNativeWizard(wizardOptions);\n        break;\n      case Integration.astro:\n        await runAstroWizard(wizardOptions);\n        break;\n      default:\n        clack.log.error('No setup wizard selected!');\n    }\n  } catch (error) {\n    analytics.captureException(error as Error, {\n      integration,\n      arguments: JSON.stringify(finalArgs),\n    });\n\n    await analytics.shutdown('error');\n\n    if (error instanceof RateLimitError) {\n      clack.log.error('Wizard usage limit reached. Please try again later.');\n    } else {\n      clack.log.error(\n        `Something went wrong. You can read the documentation at ${chalk.cyan(\n          `${INTEGRATION_CONFIG[integration].docsUrl}`,\n        )} to set up PostHog manually.`,\n      );\n    }\n    process.exit(1);\n  }\n}\n\nasync function detectIntegration(\n  options: Pick<WizardOptions, 'installDir'>,\n): Promise<Integration | undefined> {\n  const integrationConfigs = Object.entries(INTEGRATION_CONFIG).sort(\n    ([a], [b]) =>\n      INTEGRATION_ORDER.indexOf(a as Integration) -\n      INTEGRATION_ORDER.indexOf(b as Integration),\n  );\n\n  for (const [integration, config] of integrationConfigs) {\n    const detected = await config.detect(options);\n    if (detected) {\n      return integration as Integration;\n    }\n  }\n}\n\nasync function getIntegrationForSetup(\n  options: Pick<WizardOptions, 'installDir'>,\n) {\n  const detectedIntegration = await detectIntegration(options);\n\n  if (detectedIntegration) {\n    clack.log.success(\n      `Detected integration: ${getIntegrationDescription(detectedIntegration)}`,\n    );\n    return detectedIntegration;\n  }\n\n  const integration: Integration = await abortIfCancelled(\n    clack.select({\n      message: 'What do you want to set up?',\n      options: [\n        { value: Integration.nextjs, label: 'Next.js' },\n        { value: Integration.astro, label: 'Astro' },\n        { value: Integration.react, label: 'React' },\n        { value: Integration.svelte, label: 'Svelte' },\n        { value: Integration.reactNative, label: 'React Native' },\n      ],\n    }),\n  );\n\n  return integration;\n}\n\nasync function chooseNextjsWizard(options: WizardOptions): Promise<void> {\n  try {\n    const packageJson = await getPackageDotJson(options);\n    const nextVersion = getPackageVersion('next', packageJson);\n\n    // If Next.js < 15, use legacy wizard\n    if (nextVersion) {\n      const coercedVersion = semver.coerce(nextVersion);\n      if (coercedVersion && semver.lt(coercedVersion, '15.3.0')) {\n        await runNextjsWizard(options);\n        return;\n      }\n    }\n\n    // Next.js >= 15 - check feature flag to determine which wizard to use\n    const flagValue = await analytics.getFeatureFlag(\n      FeatureFlagDefinition.NextV2,\n    );\n\n    if (flagValue === WizardVariant.Agent) {\n      await runNextjsWizardAgent(options);\n    } else {\n      await runNextjsWizard(options);\n    }\n  } catch (error) {\n    await runNextjsWizard(options);\n  }\n}\n"]}