{"version":3,"file":"event-setup.js","sourceRoot":"","sources":["../../../src/nextjs/event-setup.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  abort,\n  getOrAskForProjectData,\n  askForCloudRegion,\n  getPackageDotJson,\n  getUncommittedOrUntrackedFiles,\n  isInGitRepo,\n  abortIfCancelled,\n} from '../utils/clack-utils';\nimport clack from '../utils/clack';\nimport { WizardOptions } from '../utils/types';\nimport * as fs from 'fs/promises';\nimport * as path from 'path';\nimport chalk from 'chalk';\nimport { query } from '../utils/query';\nimport { z } from 'zod';\nimport { getAllFilesInProject, updateFile } from '../utils/file-utils';\nimport { getPackageVersion, hasPackageInstalled } from '../utils/package-json';\nimport * as semver from 'semver';\nimport { enableDebugLogs, debug } from '../utils/debug';\nimport { analytics } from '../utils/analytics';\n\n// Analytics constants\nconst WIZARD_INTERACTION = 'wizard interaction';\nconst INTEGRATION_NAME = 'event-setup';\n\n// Schema for file selection from AI\nconst FileSelectionSchema = z.object({\n  files: z.array(z.string()).max(10),\n});\n\n// Schema for enhanced file with events\nconst EnhancedFileSchema = z.object({\n  filePath: z.string(),\n  content: z.string(),\n  events: z.array(\n    z.object({\n      name: z.string(),\n      description: z.string(),\n    }),\n  ),\n});\n\nexport async function runEventSetupWizard(\n  options: WizardOptions,\n): Promise<void> {\n  if (options.debug) {\n    enableDebugLogs();\n  }\n\n  clack.intro(\n    `Let's do a first pass on PostHog event tracking for your project.\n    \n    We'll start by analyzing your project structure, then choose up to ten files to enhance. Use git to discard any events you're not happy with.\n\n    This will give you a starting point, then you can add any events that we missed.\n    `,\n  );\n\n  // Check for uncommitted changes\n  if (isInGitRepo()) {\n    const uncommittedOrUntrackedFiles = getUncommittedOrUntrackedFiles();\n    if (uncommittedOrUntrackedFiles.length) {\n      clack.log.warn(\n        `You have uncommitted or untracked files in your repo:\n\n${uncommittedOrUntrackedFiles.join('\\n')}\n\nThe event setup wizard will modify multiple files. For the best experience, commit or stash your changes first.`,\n      );\n      const continueWithDirtyRepo = await abortIfCancelled(\n        clack.confirm({\n          message: 'Do you want to continue anyway?',\n        }),\n      );\n      if (!continueWithDirtyRepo) {\n        analytics.capture(WIZARD_INTERACTION, {\n          action: 'aborted due to uncommitted changes',\n          integration: INTEGRATION_NAME,\n        });\n        return abort('Please commit your changes and try again.', 0);\n      }\n      analytics.capture(WIZARD_INTERACTION, {\n        action: 'continued with uncommitted changes',\n        integration: INTEGRATION_NAME,\n      });\n    }\n  }\n\n  const cloudRegion = options.cloudRegion ?? (await askForCloudRegion());\n\n  const { accessToken, projectId } = await getOrAskForProjectData({\n    ...options,\n    cloudRegion,\n  });\n\n  // Check if this is a Next.js 15.3+ project with instrumentation-client\n  const packageJson = await getPackageDotJson(options);\n  const isNextJs = hasPackageInstalled('next', packageJson);\n\n  if (!isNextJs) {\n    return abort('This feature is only available for Next.js projects.');\n  }\n\n  const nextVersion = getPackageVersion('next', packageJson);\n  const isNext15_3Plus = nextVersion && semver.gte(nextVersion, '15.3.0');\n\n  analytics.setTag('nextjs-version', nextVersion);\n\n  if (!isNext15_3Plus) {\n    analytics.capture(WIZARD_INTERACTION, {\n      action: 'aborted due to nextjs version',\n      integration: INTEGRATION_NAME,\n      nextjsVersion: nextVersion,\n    });\n    return abort('This feature requires Next.js 15.3.0 or higher.');\n  }\n\n  // Check for instrumentation-client file\n  const allFiles = await getAllFilesInProject(options.installDir);\n  const instrumentationFiles = allFiles.filter(\n    (f) =>\n      f.includes('instrumentation') &&\n      (f.endsWith('.ts') || f.endsWith('.js')) &&\n      (f.includes('client') || f.includes('Client')),\n  );\n\n  if (instrumentationFiles.length === 0) {\n    analytics.capture(WIZARD_INTERACTION, {\n      action: 'aborted due to missing instrumentation-client',\n      integration: INTEGRATION_NAME,\n    });\n    return abort(\n      'No instrumentation-client file found. Please set up Next.js instrumentation-client first. Try using this wizard to do it!',\n    );\n  }\n\n  analytics.capture(WIZARD_INTERACTION, {\n    action: 'started event setup',\n    integration: INTEGRATION_NAME,\n    instrumentationFilesCount: instrumentationFiles.length,\n  });\n\n  // Get the project file tree\n  const s = clack.spinner();\n  s.start('Analyzing your project structure');\n\n  const projectFiles = await getAllFilesInProject(options.installDir);\n  const relativeFiles = projectFiles\n    .map((f) => path.relative(options.installDir, f))\n    .filter((f) => {\n      // Exclude instrumentation files and next.config\n      const isInstrumentation =\n        f.includes('instrumentation') &&\n        (f.endsWith('.ts') || f.endsWith('.js'));\n      const isNextConfig = f.startsWith('next.config.') || f === 'next.config';\n      return !isInstrumentation && !isNextConfig;\n    });\n\n  debug('Total files found:', projectFiles.length);\n  debug('Files after filtering:', relativeFiles.length);\n  s.stop('Project structure analyzed');\n\n  analytics.capture(WIZARD_INTERACTION, {\n    action: 'analyzed project structure',\n    integration: INTEGRATION_NAME,\n    totalFiles: projectFiles.length,\n    eligibleFiles: relativeFiles.length,\n  });\n\n  // Send file tree to AI to get 10 most useful files\n  s.start('Selecting some files to enhance with events...');\n\n  const fileSelectionPrompt = `Given this Next.js 15.3+ project structure and package.json, select up to 10 CLIENT-SIDE FILES for adding PostHog analytics events.\n  \n  IMPORTANT: Only select files that:\n  - Have \"use client\" directive at the top, OR\n  - Use React hooks (useState, useEffect, etc.), OR  \n  - Have event handlers (onClick, onSubmit, onChange)\n  \n  DO NOT select:\n  - API routes (files in /api/ or route.ts/route.js files)\n  - Server Components (files without \"use client\" and no hooks/handlers)\n  - Layout files (layout.tsx/layout.js)\n  - Configuration files\n  - Pure utility files\n  \n  Focus on:\n  - User interaction points (buttons, forms, navigation)\n  - Key user flows (auth, checkout, main features)\n  - Business-critical paths\n  - Files that represent important user actions\n  \n  Package.json:\n  ${JSON.stringify(packageJson, null, 2)}\n  \n  Project files:\n  ${relativeFiles.join('\\n')}\n  \n  Return file paths for client-side files ONLY that would benefit most from analytics tracking. If there are fewer than 10 suitable client files, return only those.`;\n\n  let selectedFiles: string[] = [];\n  try {\n    const response = await query({\n      message: fileSelectionPrompt,\n      model: 'gemini-2.5-flash',\n      region: cloudRegion,\n      schema: FileSelectionSchema,\n      accessToken,\n      projectId,\n    });\n    selectedFiles = response.files;\n    s.stop(`Selected ${selectedFiles.length} files for event tracking`);\n    analytics.capture(WIZARD_INTERACTION, {\n      action: 'selected files for tracking',\n      integration: INTEGRATION_NAME,\n      filesSelected: selectedFiles.length,\n    });\n  } catch (error) {\n    s.stop('Failed to select files');\n    analytics.capture(WIZARD_INTERACTION, {\n      action: 'file selection failed',\n      integration: INTEGRATION_NAME,\n      error: error instanceof Error ? error.message : 'Unknown error',\n    });\n    return abort('Could not analyze project structure. Please try again.');\n  }\n\n  // Read the selected files and enhance them with events\n  clack.log.info('Files selected for event tracking:');\n  selectedFiles.forEach((file, index) => {\n    clack.log.info(`  ${index + 1}. ${file}`);\n  });\n\n  const enhancedFiles: Array<{\n    filePath: string;\n    events: Array<{ name: string; description: string }>;\n  }> = [];\n\n  clack.log.info(\n    \"\\nEnhancing files with event tracking. Changes will be applied as they come in. Use your git interface to review new events. Feel free to toss anything you don't like...\",\n  );\n\n  for (const filePath of selectedFiles) {\n    const fileSpinner = clack.spinner();\n    fileSpinner.start(`Analyzing ${filePath}`);\n\n    try {\n      const fullPath = path.join(options.installDir, filePath);\n      const fileContent = await fs.readFile(fullPath, 'utf8');\n\n      const enhancePrompt = `You are enhancing a REAL production, client-side Next.js file with PostHog analytics. This is NOT an example or tutorial - add events to the ACTUAL code provided.\n      \n      - REQUIRED: import posthog from 'posthog-js'\n      - Track events with: posthog.capture('event-name', { property: 'value' })\n      - NEVER import PostHogClient from '@/app/posthog'\n      - NEVER create functions with 'use server'\n\n      CRITICAL INSTRUCTIONS:\n      - This is a REAL file from a production codebase\n      - DO NOT add placeholder comments like \"// In a real app...\" or \"// This is an example...\"\n      - DO NOT modify the existing business logic or add simulation code\n      - DO NOT add any tutorial-style comments\n      - ONLY add PostHog event tracking to the existing, real functionality\n      - DO NOT create wrapper functions around existing functions just to add tracking\n      - Add tracking code directly inside existing functions where appropriate\n      - NEVER import new packages or libraries that aren't already used in the file\n      - ONLY use imports that already exist in the file or the PostHog imports specified\n      - DO NOT assume any authentication library (Clerk, Auth.js, etc.) is available\n      \n      FORBIDDEN - NEVER DO THESE:\n      - NEVER add 'use client' or 'use server' directives at the top of the file, or in functions\n      - NEVER define new server actions (functions with \"use server\") in Client Components\n      - NEVER create inline \"use server\" functions in files that have \"use client\"\n      - NEVER use useEffect to track page views or component renders\n      - NEVER track events like \"page_viewed\", \"form_viewed\", \"component_rendered\", \"flow_started\", \"page_opened\" etc\n      - NEVER track that someone simply arrived at or viewed a page\n      - NEVER change the file's existing client/server architecture\n      - NEVER add events on component mount or render - only on actual user interactions\n      - Track events on user interactions like clicks, form submissions, etc.\n      \n      Technical Rules:\n      - This is a client-side file suitable for event tracking\n      - REQUIRED IMPORT: import posthog from 'posthog-js'\n      - Use the existing posthog instance for all tracking\n      - Example: posthog.capture('button-clicked', { buttonId: 'submit' })\n      - Focus on tracking user interactions in the UI components\n      - Track events like button clicks, form submissions, navigation, etc.\n      - Add 1-2 high-value events that track the ACTUAL user actions in this file\n      - Use descriptive event names (lowercase-hyphenated) based on what the code ACTUALLY does\n      - Include properties that capture REAL data from the existing code\n      - For user identification: ONLY use user data that's already available in the code\n      - DO NOT add code to fetch user IDs or authentication state if not already available in the file\n      - Do not change the formatting of the file; only add events\n      - Do not set timestamps on events; PostHog will do this automatically\n      - Always return the entire file content, not just the changes\n      - NEVER add events that correspond to page views; PostHog tracks these automatically\n      - NEVER INSERT \"use client\" or \"use server\" directives\n      \n      File path: ${filePath}\n      File content:\n      ${fileContent}\n      \n      IMPORTANT: If this file only renders UI without any user interactions (no buttons, forms, or actions), \n      or if the only possible events would be pageview-like (e.g., \"form-viewed\", \"page-opened\", \"flow-started\"),\n      then SKIP THIS FILE by returning the original content unchanged. We only want to track actual user actions,\n      not that someone looked at a page.\n      \n      Return the enhanced file with PostHog tracking added to the EXISTING functionality. List the events you added.`;\n\n      const response = await query({\n        message: enhancePrompt,\n        model: 'gemini-2.5-pro',\n        region: cloudRegion,\n        schema: EnhancedFileSchema,\n        accessToken,\n        projectId,\n      });\n\n      // Apply changes immediately\n      if (response.content !== fileContent) {\n        await updateFile(\n          {\n            filePath,\n            oldContent: fileContent,\n            newContent: response.content,\n          },\n          options,\n        );\n\n        enhancedFiles.push({\n          filePath,\n          events: response.events,\n        });\n\n        fileSpinner.stop(\n          `✓ Enhanced ${filePath} with ${response.events.length} events`,\n        );\n        analytics.capture(WIZARD_INTERACTION, {\n          action: 'enhanced file',\n          integration: INTEGRATION_NAME,\n          filePath,\n          eventsAdded: response.events.length,\n        });\n      } else {\n        fileSpinner.stop(`No changes needed for ${filePath}`);\n        analytics.capture(WIZARD_INTERACTION, {\n          action: 'file skipped',\n          integration: INTEGRATION_NAME,\n          filePath,\n          reason: 'no events to add',\n        });\n      }\n    } catch (error) {\n      fileSpinner.stop(`✗ Failed to enhance ${filePath}`);\n      debug('Error enhancing file:', error);\n      analytics.capture(WIZARD_INTERACTION, {\n        action: 'file enhancement failed',\n        integration: INTEGRATION_NAME,\n        filePath,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      });\n    }\n  }\n\n  // Generate event tracking report\n  const generateMarkdown = () => {\n    let md = `# Event tracking report\\n\\n`;\n    md += `This document lists all PostHog events that have been automatically added to your Next.js application.\\n\\n`;\n    md += `## Events by File\\n\\n`;\n\n    enhancedFiles.forEach((file) => {\n      if (file.events.length > 0) {\n        md += `### ${file.filePath}\\n\\n`;\n        file.events.forEach((event) => {\n          md += `- **${event.name}**: ${event.description}\\n`;\n        });\n        md += `\\n`;\n      }\n    });\n\n    md += `\\n## Events still awaiting implementation\\n`;\n    md += `- (human: you can fill these in)`;\n\n    md += `\\n---\\n\\n`;\n    md += `## Next Steps\\n\\n`;\n    md += `1. Review the changes made to your files\\n`;\n    md += `2. Test that events are being captured correctly\\n`;\n    md += `3. Create insights and dashboards in PostHog\\n`;\n    md += `4. Make a list of events we missed above. Knock them out yourself, or give this file to an agent.\\n\\n`;\n    md += `Learn more about what to measure with PostHog and why: https://posthog.com/docs/new-to-posthog/getting-hogpilled\\n`;\n    return md;\n  };\n\n  const markdownContent = generateMarkdown();\n  const fileName = 'event-tracking-report.md';\n  const filePath = path.join(options.installDir, fileName);\n\n  await fs.writeFile(filePath, markdownContent);\n\n  // Summary\n  const totalEvents = enhancedFiles.reduce(\n    (sum, file) => sum + file.events.length,\n    0,\n  );\n\n  analytics.capture(WIZARD_INTERACTION, {\n    action: 'event setup completed',\n    integration: INTEGRATION_NAME,\n    totalEvents,\n    filesEnhanced: enhancedFiles.length,\n    filesProcessed: selectedFiles.length,\n  });\n\n  analytics.setTag('event-setup-total-events', totalEvents);\n  analytics.setTag('event-setup-files-enhanced', enhancedFiles.length);\n\n  clack.outro(\n    `Success! Added ${chalk.bold(\n      totalEvents.toString(),\n    )} events across ${chalk.bold(enhancedFiles.length.toString())} files.\n    \n    Event tracking plan saved to: ${chalk.cyan(fileName)}\n    \n    Next steps:\n    1. Review changes with your favorite git tool\n    2. Revert unwanted changes with ${chalk.bold('git checkout <file>')}\n    3. Test that events are being captured in your PostHog project\n    4. Create insights in PostHog\n    `,\n  );\n}\n"]}