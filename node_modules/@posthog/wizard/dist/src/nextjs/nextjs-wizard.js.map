{"version":3,"file":"nextjs-wizard.js","sourceRoot":"","sources":["../../../src/nextjs/nextjs-wizard.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-disable max-lines */\nimport {\n  abort,\n  askForAIConsent,\n  confirmContinueIfNoOrDirtyGitRepo,\n  ensurePackageIsInstalled,\n  getOrAskForProjectData,\n  getPackageDotJson,\n  getPackageManager,\n  installPackage,\n  isUsingTypeScript,\n  printWelcome,\n} from '../utils/clack-utils';\nimport { getPackageVersion, hasPackageInstalled } from '../utils/package-json';\nimport {\n  getNextJsRouter,\n  getNextJsRouterName,\n  getNextJsVersionBucket,\n  NextJsRouter,\n} from './utils';\nimport clack from '../utils/clack';\nimport { Integration } from '../lib/constants';\nimport {\n  getNextjsAppRouterDocs,\n  getNextjsPagesRouterDocs,\n  getModernNextjsDocs,\n} from './docs';\nimport { analytics } from '../utils/analytics';\nimport {\n  generateFileChangesForIntegration,\n  getFilesToChange,\n  getRelevantFilesForIntegration,\n} from '../utils/file-utils';\nimport type { WizardOptions } from '../utils/types';\nimport { askForCloudRegion } from '../utils/clack-utils';\nimport { getOutroMessage } from '../lib/messages';\nimport {\n  addEditorRulesStep,\n  addOrUpdateEnvironmentVariablesStep,\n  runPrettierStep,\n  addMCPServerToClientsStep,\n  uploadEnvironmentVariablesStep,\n} from '../steps';\n\nimport * as semver from 'semver';\n\nexport async function runNextjsWizard(options: WizardOptions): Promise<void> {\n  printWelcome({\n    wizardName: 'PostHog Next.js wizard',\n  });\n\n  const aiConsent = await askForAIConsent(options);\n\n  if (!aiConsent) {\n    await abort(\n      'The Next.js wizard requires AI to get setup right now. Please view the docs to setup Next.js manually instead: https://posthog.com/docs/libraries/next-js',\n      0,\n    );\n  }\n\n  const cloudRegion = options.cloudRegion ?? (await askForCloudRegion());\n\n  const typeScriptDetected = isUsingTypeScript(options);\n\n  await confirmContinueIfNoOrDirtyGitRepo(options);\n\n  const packageJson = await getPackageDotJson(options);\n\n  await ensurePackageIsInstalled(packageJson, 'next', 'Next.js');\n\n  const nextVersion = getPackageVersion('next', packageJson);\n\n  analytics.setTag('nextjs-version', getNextJsVersionBucket(nextVersion));\n\n  const { projectApiKey, accessToken, host, projectId } =\n    await getOrAskForProjectData({\n      ...options,\n      cloudRegion,\n    });\n\n  const sdkAlreadyInstalled = hasPackageInstalled('posthog-js', packageJson);\n\n  analytics.setTag('sdk-already-installed', sdkAlreadyInstalled);\n\n  const { packageManager: packageManagerFromInstallStep } =\n    await installPackage({\n      packageName: 'posthog-js',\n      packageNameDisplayLabel: 'posthog-js',\n      alreadyInstalled: !!packageJson?.dependencies?.['posthog-js'],\n      forceInstall: options.forceInstall,\n      askBeforeUpdating: false,\n      installDir: options.installDir,\n      integration: Integration.nextjs,\n    });\n\n  await installPackage({\n    packageName: 'posthog-node',\n    packageNameDisplayLabel: 'posthog-node',\n    packageManager: packageManagerFromInstallStep,\n    alreadyInstalled: !!packageJson?.dependencies?.['posthog-node'],\n    forceInstall: options.forceInstall,\n    askBeforeUpdating: false,\n    installDir: options.installDir,\n    integration: Integration.nextjs,\n  });\n\n  const relevantFiles = await getRelevantFilesForIntegration({\n    installDir: options.installDir,\n    integration: Integration.nextjs,\n  });\n\n  let installationDocumentation; // Documentation for the installation of the PostHog SDK\n\n  if (instrumentationFileAvailable(nextVersion)) {\n    installationDocumentation = getModernNextjsDocs({\n      host,\n      language: typeScriptDetected ? 'typescript' : 'javascript',\n    });\n\n    clack.log.info(`Reviewing PostHog documentation for Next.js`);\n  } else {\n    const router = await getNextJsRouter(options);\n\n    installationDocumentation = getInstallationDocumentation({\n      router,\n      host,\n      language: typeScriptDetected ? 'typescript' : 'javascript',\n    });\n\n    clack.log.info(\n      `Reviewing PostHog documentation for ${getNextJsRouterName(router)}`,\n    );\n  }\n\n  const filesToChange = await getFilesToChange({\n    integration: Integration.nextjs,\n    relevantFiles,\n    documentation: installationDocumentation,\n    accessToken,\n    cloudRegion,\n    projectId,\n  });\n\n  await generateFileChangesForIntegration({\n    integration: Integration.nextjs,\n    filesToChange,\n    accessToken,\n    installDir: options.installDir,\n    documentation: installationDocumentation,\n    cloudRegion,\n    projectId,\n  });\n\n  const packageManagerForOutro =\n    packageManagerFromInstallStep ?? (await getPackageManager(options));\n\n  await runPrettierStep({\n    installDir: options.installDir,\n    integration: Integration.nextjs,\n  });\n\n  const { relativeEnvFilePath, addedEnvVariables } =\n    await addOrUpdateEnvironmentVariablesStep({\n      variables: {\n        NEXT_PUBLIC_POSTHOG_KEY: projectApiKey,\n        NEXT_PUBLIC_POSTHOG_HOST: host,\n      },\n      installDir: options.installDir,\n      integration: Integration.nextjs,\n    });\n\n  const uploadedEnvVars = await uploadEnvironmentVariablesStep(\n    {\n      NEXT_PUBLIC_POSTHOG_KEY: projectApiKey,\n      NEXT_PUBLIC_POSTHOG_HOST: host,\n    },\n    {\n      integration: Integration.nextjs,\n      options,\n    },\n  );\n\n  const addedEditorRules = await addEditorRulesStep({\n    rulesName: 'next-rules.md',\n    installDir: options.installDir,\n    integration: Integration.nextjs,\n  });\n\n  await addMCPServerToClientsStep({\n    cloudRegion,\n    integration: Integration.nextjs,\n  });\n\n  const outroMessage = getOutroMessage({\n    options,\n    integration: Integration.nextjs,\n    cloudRegion,\n    addedEditorRules,\n    packageManager: packageManagerForOutro,\n    envFileChanged: addedEnvVariables ? relativeEnvFilePath : undefined,\n    uploadedEnvVars,\n  });\n\n  clack.outro(outroMessage);\n\n  clack.outro(\n    'Want to try our experimental event instrumentation? Run the wizard again with this argument: npx @posthog/wizard@latest event-setup',\n  );\n\n  await analytics.shutdown('success');\n}\n\nfunction instrumentationFileAvailable(\n  nextVersion: string | undefined,\n): boolean {\n  const minimumVersion = '15.3.0'; //instrumentation-client.js|ts was introduced in 15.3\n\n  if (!nextVersion) {\n    return false;\n  }\n  const coercedNextVersion = semver.coerce(nextVersion);\n  if (!coercedNextVersion) {\n    return false; // Unable to parse nextVersion\n  }\n  return semver.gte(coercedNextVersion, minimumVersion);\n}\n\nfunction getInstallationDocumentation({\n  router,\n  host,\n  language,\n}: {\n  router: NextJsRouter;\n  host: string;\n  language: 'typescript' | 'javascript';\n}) {\n  if (router === NextJsRouter.PAGES_ROUTER) {\n    return getNextjsPagesRouterDocs({ host, language });\n  }\n\n  return getNextjsAppRouterDocs({ host, language });\n}\n"]}