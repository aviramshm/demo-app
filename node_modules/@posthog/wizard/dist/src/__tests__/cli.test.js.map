{"version":3,"file":"cli.test.js","sourceRoot":"","sources":["../../../src/__tests__/cli.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Mock functions must be defined before imports\nconst mockRunWizard = jest.fn();\nconst mockRunMCPInstall = jest.fn();\nconst mockRunMCPRemove = jest.fn();\n\njest.mock('../run', () => ({ runWizard: mockRunWizard }));\njest.mock('../mcp', () => ({\n  runMCPInstall: mockRunMCPInstall,\n  runMCPRemove: mockRunMCPRemove,\n}));\njest.mock('semver', () => ({ satisfies: () => true }));\n\ndescribe('CLI argument parsing', () => {\n  const originalArgv = process.argv;\n  // eslint-disable-next-line @typescript-eslint/unbound-method\n  const originalExit = process.exit;\n  const originalEnv = { ...process.env };\n\n  beforeEach(() => {\n    jest.clearAllMocks();\n\n    // Reset environment\n    process.env = { ...originalEnv };\n    delete process.env.POSTHOG_WIZARD_REGION;\n    delete process.env.POSTHOG_WIZARD_DEFAULT;\n\n    // Mock process.exit to prevent test runner from exiting\n    process.exit = jest.fn() as any;\n  });\n\n  afterEach(() => {\n    process.argv = originalArgv;\n    process.exit = originalExit;\n    process.env = originalEnv;\n    jest.resetModules();\n  });\n\n  /**\n   * Helper to run the CLI with given arguments\n   */\n  async function runCLI(args: string[]) {\n    process.argv = ['node', 'bin.ts', ...args];\n\n    jest.isolateModules(() => {\n      require('../../bin.ts');\n    });\n\n    // Allow yargs to process\n    await new Promise((resolve) => setImmediate(resolve));\n  }\n\n  /**\n   * Helper to get the arguments passed to a mock function\n   */\n  function getLastCallArgs(mockFn: jest.Mock) {\n    expect(mockFn).toHaveBeenCalled();\n    return mockFn.mock.calls[mockFn.mock.calls.length - 1][0];\n  }\n\n  describe('--default flag', () => {\n    test('defaults to true when not specified', async () => {\n      await runCLI([]);\n\n      const args = getLastCallArgs(mockRunWizard);\n      expect(args.default).toBe(true);\n    });\n\n    test('can be explicitly set to false with --no-default', async () => {\n      await runCLI(['--no-default']);\n\n      const args = getLastCallArgs(mockRunWizard);\n      expect(args.default).toBe(false);\n    });\n\n    test('can be explicitly set to true', async () => {\n      await runCLI(['--default']);\n\n      const args = getLastCallArgs(mockRunWizard);\n      expect(args.default).toBe(true);\n    });\n  });\n\n  describe('--region flag', () => {\n    test('is undefined when not specified', async () => {\n      await runCLI([]);\n\n      const args = getLastCallArgs(mockRunWizard);\n      expect(args.region).toBeUndefined();\n    });\n\n    test.each(['us', 'eu'])(\n      'accepts \"%s\" as a valid region',\n      async (region) => {\n        await runCLI(['--region', region]);\n\n        const args = getLastCallArgs(mockRunWizard);\n        expect(args.region).toBe(region);\n      },\n    );\n  });\n\n  describe('environment variables', () => {\n    test('respects POSTHOG_WIZARD_REGION', async () => {\n      process.env.POSTHOG_WIZARD_REGION = 'eu';\n\n      await runCLI([]);\n\n      const args = getLastCallArgs(mockRunWizard);\n      expect(args.region).toBe('eu');\n    });\n\n    test('respects POSTHOG_WIZARD_DEFAULT', async () => {\n      process.env.POSTHOG_WIZARD_DEFAULT = 'false';\n\n      await runCLI([]);\n\n      const args = getLastCallArgs(mockRunWizard);\n      expect(args.default).toBe(false);\n    });\n\n    test('CLI args override environment variables', async () => {\n      process.env.POSTHOG_WIZARD_REGION = 'us';\n      process.env.POSTHOG_WIZARD_DEFAULT = 'false';\n\n      await runCLI(['--region', 'eu', '--default']);\n\n      const args = getLastCallArgs(mockRunWizard);\n      expect(args.region).toBe('eu');\n      expect(args.default).toBe(true);\n    });\n\n    test('region is undefined when no env var or CLI arg', async () => {\n      await runCLI([]);\n\n      const args = getLastCallArgs(mockRunWizard);\n      expect(args.region).toBeUndefined();\n    });\n  });\n\n  describe('backward compatibility', () => {\n    test('all existing flags continue to work', async () => {\n      await runCLI([\n        '--debug',\n        '--signup',\n        '--force-install',\n        '--install-dir',\n        '/custom/path',\n        '--integration',\n        'nextjs',\n      ]);\n\n      const args = getLastCallArgs(mockRunWizard);\n\n      // Existing flags\n      expect(args.debug).toBe(true);\n      expect(args.signup).toBe(true);\n      expect(args['force-install']).toBe(true);\n      expect(args['install-dir']).toBe('/custom/path');\n      expect(args.integration).toBe('nextjs');\n\n      // New defaults\n      expect(args.default).toBe(true);\n      expect(args.region).toBeUndefined();\n    });\n  });\n\n  describe('mcp commands', () => {\n    test('mcp add region is undefined when not specified', async () => {\n      await runCLI(['mcp', 'add']);\n\n      const args = getLastCallArgs(mockRunMCPInstall);\n      expect(args.region).toBeUndefined();\n    });\n\n    test('mcp add respects --region flag', async () => {\n      await runCLI(['mcp', 'add', '--region', 'eu']);\n\n      const args = getLastCallArgs(mockRunMCPInstall);\n      expect(args.region).toBe('eu');\n    });\n\n    test('mcp commands inherit global flags', async () => {\n      await runCLI(['mcp', 'add', '--no-default', '--debug']);\n\n      const args = getLastCallArgs(mockRunMCPInstall);\n      expect(args.default).toBe(false);\n      expect(args.debug).toBe(true);\n    });\n  });\n});\n"]}