{"version":3,"file":"agent-interface.js","sourceRoot":"","sources":["../../../src/lib/agent-interface.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Shared agent interface for PostHog wizards\n * Provides common agent initialization and event handling\n */\n\n// @ts-ignore - posthog-agent is ESM, wizard is CommonJS. Works at runtime via local link.\nimport { Agent, PermissionMode, type AgentEvent } from '@posthog/agent';\nimport clack from '../utils/clack';\nimport { debug } from '../utils/debug';\nimport type { WizardOptions } from '../utils/types';\nimport { analytics } from '../utils/analytics';\nimport { WIZARD_INTERACTION_EVENT_NAME } from './constants';\n\n// TODO: Remove these if/when posthog/agent exports an enum for events\nconst EventType = {\n  RAW_SDK_EVENT: 'raw_sdk_event',\n  TOKEN: 'token',\n  TOOL_CALL: 'tool_call',\n  TOOL_RESULT: 'tool_result',\n  ERROR: 'error',\n  DONE: 'done',\n} as const;\n\nexport type AgentConfig = {\n  workingDirectory: string;\n  posthogMcpUrl: string;\n  posthogApiKey: string;\n  debug?: boolean;\n};\n\n/**\n * Initialize a PostHog Agent instance with the provided configuration\n */\nexport function initializeAgent(\n  config: AgentConfig,\n  options: WizardOptions,\n  spinner: ReturnType<typeof clack.spinner>,\n): Agent {\n  clack.log.step('Initializing PostHog agent...');\n\n  try {\n    const agentConfig = {\n      workingDirectory: config.workingDirectory,\n      posthogMcpUrl: config.posthogMcpUrl,\n      posthogApiKey: config.posthogApiKey,\n      onEvent: (event: AgentEvent) => {\n        handleAgentEvent(event, options, spinner);\n      },\n      debug: config.debug ?? false,\n    };\n\n    if (options.debug) {\n      debug('Agent config:', {\n        workingDirectory: agentConfig.workingDirectory,\n        posthogMcpUrl: agentConfig.posthogMcpUrl,\n        posthogApiKeyPresent: !!agentConfig.posthogApiKey,\n      });\n    }\n\n    const agent = new Agent(agentConfig);\n    clack.log.success(\"Agent initialized. Let's get cooking!\");\n    return agent;\n  } catch (error) {\n    clack.log.error(`Failed to initialize agent: ${(error as Error).message}`);\n    debug('Agent initialization error:', error);\n    throw error;\n  }\n}\n\n/**\n * Handle agent events and provide user feedback\n * This function processes events from the agent SDK and provides appropriate\n * user feedback through the CLI spinner and logging\n */\nfunction handleAgentEvent(\n  event: AgentEvent,\n  options: WizardOptions,\n  spinner: ReturnType<typeof clack.spinner>,\n): void {\n  if (options.debug) {\n    debug(`Event type: ${event.type}`, JSON.stringify(event, null, 2));\n  }\n\n  // Only show [STATUS] events to the user - everything else goes to debug log\n  switch (event.type) {\n    case EventType.RAW_SDK_EVENT:\n      if (event.sdkMessage?.type === 'assistant') {\n        const message = event.sdkMessage.message;\n        if (message?.content && Array.isArray(message.content)) {\n          const textContent = message.content\n            .filter((block: any) => block.type === 'text')\n            .map((block: any) => block.text)\n            .join('\\n');\n\n          // Check if the text contains a [STATUS] marker\n          const statusMatch = textContent.match(/^.*\\[STATUS\\]\\s*(.+?)$/m);\n          if (statusMatch) {\n            // Stop spinner, log the status step, restart spinner\n            // This creates the progress list as the agent proceeds\n            spinner.stop(statusMatch[1].trim());\n            spinner.start('Integrating PostHog...');\n          }\n        }\n      }\n      break;\n\n    case EventType.TOKEN:\n      if (options.debug) {\n        debug(event.content);\n      }\n      break;\n\n    case EventType.TOOL_CALL:\n      if (options.debug) {\n        debug(`Tool: ${event.toolName}`);\n        debug('  Args:', JSON.stringify(event.args, null, 2));\n      }\n      break;\n\n    case EventType.TOOL_RESULT:\n      if (options.debug) {\n        debug(`âœ… ${event.toolName} completed`);\n        const resultStr: string =\n          typeof event.result === 'string'\n            ? event.result\n            : JSON.stringify(event.result, null, 2);\n        const truncated =\n          resultStr.length > 500\n            ? `${resultStr.substring(0, 500)}...`\n            : resultStr;\n        debug('  Result:', truncated);\n      }\n      break;\n\n    case EventType.ERROR:\n      // Always show errors to user\n      clack.log.error(`Error: ${event.message}`);\n      if (options.debug && event.error) {\n        debug('Error details:', event.error);\n      }\n      if (event.error instanceof Error) {\n        analytics.captureException(event.error, {\n          event_type: event.type,\n          message: event.message,\n        });\n      }\n      break;\n\n    case EventType.DONE:\n      if (event.durationMs) {\n        if (options.debug) {\n          debug(`Completed in ${Math.round(event.durationMs / 1000)}s`);\n        }\n        analytics.capture(WIZARD_INTERACTION_EVENT_NAME, {\n          action: 'agent integration completed',\n          duration_ms: event.durationMs,\n          duration_seconds: Math.round(event.durationMs / 1000),\n        });\n      }\n      break;\n  }\n}\n\n/**\n * Execute an agent with the provided prompt and options\n * Handles the full lifecycle: spinner, execution, error handling\n */\nexport async function runAgent(\n  agent: Agent,\n  prompt: string,\n  options: WizardOptions,\n  spinner: ReturnType<typeof clack.spinner>,\n  config?: {\n    estimatedDurationMinutes?: number;\n    spinnerMessage?: string;\n    successMessage?: string;\n    errorMessage?: string;\n  },\n): Promise<void> {\n  const {\n    estimatedDurationMinutes = 8,\n    spinnerMessage = 'Customizing your PostHog setup...',\n    successMessage = 'PostHog integration complete',\n    errorMessage = 'Integration failed',\n  } = config ?? {};\n\n  clack.log.step(\n    `This whole process should take about ${estimatedDurationMinutes} minutes including error checking and fixes.\\n\\nGrab some coffee!`,\n  );\n\n  spinner.start(spinnerMessage);\n\n  try {\n    await agent.run(prompt, {\n      repositoryPath: options.installDir,\n      permissionMode: PermissionMode.ACCEPT_EDITS,\n    });\n    spinner.stop(successMessage);\n  } catch (error) {\n    spinner.stop(errorMessage);\n    clack.log.error(`Error: ${(error as Error).message}`);\n    debug('Full error:', error);\n    throw error;\n  }\n}\n"]}