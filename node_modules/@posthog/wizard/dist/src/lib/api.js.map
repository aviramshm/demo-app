{"version":3,"file":"api.js","sourceRoot":"","sources":["../../../src/lib/api.ts"],"names":[],"mappings":"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","sourcesContent":["import axios, { AxiosError } from 'axios';\nimport { z } from 'zod';\nimport { analytics } from '../utils/analytics';\n\nexport const ApiUserSchema = z.object({\n  distinct_id: z.string(),\n  organizations: z.array(\n    z.object({\n      id: z.string().uuid(),\n    }),\n  ),\n  team: z.object({\n    id: z.number(),\n    organization: z.string().uuid(),\n  }),\n  organization: z.object({\n    id: z.string().uuid(),\n  }),\n});\n\nexport const ApiProjectSchema = z.object({\n  id: z.number(),\n  uuid: z.string().uuid(),\n  organization: z.string().uuid(),\n  api_token: z.string(),\n  name: z.string(),\n});\n\nexport type ApiUser = z.infer<typeof ApiUserSchema>;\nexport type ApiProject = z.infer<typeof ApiProjectSchema>;\n\nclass ApiError extends Error {\n  constructor(\n    message: string,\n    public readonly statusCode?: number,\n    public readonly endpoint?: string,\n  ) {\n    super(message);\n    this.name = 'ApiError';\n  }\n}\n\nexport async function fetchUserData(\n  accessToken: string,\n  baseUrl: string,\n): Promise<ApiUser> {\n  try {\n    const response = await axios.get(`${baseUrl}/api/users/@me/`, {\n      headers: {\n        Authorization: `Bearer ${accessToken}`,\n      },\n    });\n\n    return ApiUserSchema.parse(response.data);\n  } catch (error) {\n    const apiError = handleApiError(error, 'fetch user data');\n    analytics.captureException(apiError, {\n      endpoint: '/api/users/@me/',\n      baseUrl,\n    });\n    throw apiError;\n  }\n}\n\nexport async function fetchProjectData(\n  accessToken: string,\n  projectId: number,\n  baseUrl: string,\n): Promise<ApiProject> {\n  try {\n    const response = await axios.get(`${baseUrl}/api/projects/${projectId}/`, {\n      headers: {\n        Authorization: `Bearer ${accessToken}`,\n      },\n    });\n\n    return ApiProjectSchema.parse(response.data);\n  } catch (error) {\n    const apiError = handleApiError(error, 'fetch project data');\n    analytics.captureException(apiError, {\n      endpoint: `/api/projects/${projectId}/`,\n      baseUrl,\n      projectId,\n    });\n    throw apiError;\n  }\n}\n\nfunction handleApiError(error: unknown, operation: string): ApiError {\n  if (axios.isAxiosError(error)) {\n    const axiosError = error as AxiosError<{ detail?: string }>;\n    const status = axiosError.response?.status;\n    const detail = axiosError.response?.data?.detail;\n    const endpoint = axiosError.config?.url;\n\n    if (status === 401) {\n      return new ApiError(\n        `Authentication failed while trying to ${operation}`,\n        status,\n        endpoint,\n      );\n    }\n\n    if (status === 403) {\n      return new ApiError(\n        `Access denied while trying to ${operation}`,\n        status,\n        endpoint,\n      );\n    }\n\n    if (status === 404) {\n      return new ApiError(\n        `Resource not found while trying to ${operation}`,\n        status,\n        endpoint,\n      );\n    }\n\n    const message = detail || `Failed to ${operation}`;\n    return new ApiError(message, status, endpoint);\n  }\n\n  if (error instanceof z.ZodError) {\n    return new ApiError(`Invalid response format while trying to ${operation}`);\n  }\n\n  return new ApiError(\n    `Unexpected error while trying to ${operation}: ${\n      error instanceof Error ? error.message : 'Unknown error'\n    }`,\n  );\n}\n"]}