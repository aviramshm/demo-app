{"version":3,"file":"add-or-update-environment-variables.js","sourceRoot":"","sources":["../../../src/steps/add-or-update-environment-variables.ts"],"names":[],"mappings":"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","sourcesContent":["import chalk from 'chalk';\nimport type { Integration } from '../lib/constants';\nimport { traceStep } from '../telemetry';\nimport { analytics } from '../utils/analytics';\nimport clack from '../utils/clack';\nimport { getDotGitignore } from '../utils/file-utils';\nimport * as fs from 'fs';\nimport path from 'path';\n\nexport async function addOrUpdateEnvironmentVariablesStep({\n  installDir,\n  variables,\n  integration,\n}: {\n  installDir: string;\n  variables: Record<string, string>;\n  integration: Integration;\n}): Promise<{\n  relativeEnvFilePath: string;\n  addedEnvVariables: boolean;\n  addedGitignore: boolean;\n}> {\n  return traceStep('add-or-update-environment-variables', async () => {\n    const envVarContent = Object.entries(variables)\n      .map(([key, value]) => `${key}=${value}`)\n      .join('\\n');\n\n    const dotEnvLocalFilePath = path.join(installDir, '.env.local');\n    const dotEnvFilePath = path.join(installDir, '.env');\n    const targetEnvFilePath = fs.existsSync(dotEnvLocalFilePath)\n      ? dotEnvLocalFilePath\n      : dotEnvFilePath;\n\n    const dotEnvFileExists = fs.existsSync(targetEnvFilePath);\n\n    const relativeEnvFilePath = path.relative(installDir, targetEnvFilePath);\n\n    let addedGitignore = false;\n    let addedEnvVariables = false;\n\n    if (dotEnvFileExists) {\n      try {\n        let dotEnvFileContent = fs.readFileSync(targetEnvFilePath, 'utf8');\n        let updated = false;\n\n        for (const [key, value] of Object.entries(variables)) {\n          const regex = new RegExp(`^${key}=.*$`, 'm');\n\n          if (dotEnvFileContent.match(regex)) {\n            dotEnvFileContent = dotEnvFileContent.replace(\n              regex,\n              `${key}=${value}`,\n            );\n            updated = true;\n          } else {\n            if (!dotEnvFileContent.endsWith('\\n')) {\n              dotEnvFileContent += '\\n';\n            }\n            dotEnvFileContent += `${key}=${value}\\n`;\n            updated = true;\n          }\n        }\n\n        if (updated) {\n          await fs.promises.writeFile(targetEnvFilePath, dotEnvFileContent, {\n            encoding: 'utf8',\n            flag: 'w',\n          });\n          clack.log.success(\n            `Updated environment variables in ${chalk.bold.cyan(\n              relativeEnvFilePath,\n            )}`,\n          );\n        } else {\n          clack.log.success(\n            `${chalk.bold.cyan(\n              relativeEnvFilePath,\n            )} already has the necessary environment variables.`,\n          );\n        }\n\n        addedEnvVariables = true;\n      } catch (error) {\n        clack.log.warning(\n          `Failed to update environment variables in ${chalk.bold.cyan(\n            relativeEnvFilePath,\n          )}. Please update them manually.`,\n        );\n\n        analytics.capture('wizard interaction', {\n          action: 'failed to update environment variables',\n          integration,\n          error: error instanceof Error ? error.message : 'Unknown error',\n        });\n\n        return {\n          relativeEnvFilePath,\n          addedEnvVariables,\n          addedGitignore,\n        };\n      }\n    } else {\n      try {\n        await fs.promises.writeFile(targetEnvFilePath, envVarContent, {\n          encoding: 'utf8',\n          flag: 'w',\n        });\n        clack.log.success(\n          `Created ${chalk.bold.cyan(\n            relativeEnvFilePath,\n          )} with environment variables.`,\n        );\n\n        addedEnvVariables = true;\n      } catch (error) {\n        clack.log.warning(\n          `Failed to create ${chalk.bold.cyan(\n            relativeEnvFilePath,\n          )} with environment variables. Please add them manually.`,\n        );\n\n        analytics.capture('wizard interaction', {\n          action: 'failed to create environment variables',\n          integration,\n          error: error instanceof Error ? error.message : 'Unknown error',\n        });\n\n        return {\n          relativeEnvFilePath,\n          addedEnvVariables,\n          addedGitignore,\n        };\n      }\n    }\n\n    const gitignorePath = getDotGitignore({ installDir });\n\n    const envFileName = path.basename(targetEnvFilePath);\n\n    const envFiles = [envFileName];\n\n    if (gitignorePath) {\n      const gitignoreContent = fs.readFileSync(gitignorePath, 'utf8');\n      const missingEnvFiles = envFiles.filter(\n        (file) => !gitignoreContent.includes(file),\n      );\n\n      if (missingEnvFiles.length > 0) {\n        try {\n          const newGitignoreContent = `${gitignoreContent}\\n${missingEnvFiles.join(\n            '\\n',\n          )}`;\n          await fs.promises.writeFile(gitignorePath, newGitignoreContent, {\n            encoding: 'utf8',\n            flag: 'w',\n          });\n          clack.log.success(\n            `Updated ${chalk.bold.cyan(\n              '.gitignore',\n            )} to include ${chalk.bold.cyan(envFileName)}.`,\n          );\n          addedGitignore = true;\n        } catch (error) {\n          clack.log.warning(\n            `Failed to update ${chalk.bold.cyan(\n              '.gitignore',\n            )} to include ${chalk.bold.cyan(envFileName)}.`,\n          );\n\n          analytics.capture('wizard interaction', {\n            action: 'failed to update gitignore',\n            integration,\n            error: error instanceof Error ? error.message : 'Unknown error',\n          });\n\n          return {\n            relativeEnvFilePath,\n            addedEnvVariables,\n            addedGitignore,\n          };\n        }\n      }\n    } else {\n      try {\n        const newGitignoreContent = `${envFiles.join('\\n')}\\n`;\n        await fs.promises.writeFile(\n          path.join(installDir, '.gitignore'),\n          newGitignoreContent,\n          {\n            encoding: 'utf8',\n            flag: 'w',\n          },\n        );\n        clack.log.success(\n          `Created ${chalk.bold.cyan('.gitignore')} with environment files.`,\n        );\n        addedGitignore = true;\n      } catch (error) {\n        clack.log.warning(\n          `Failed to create ${chalk.bold.cyan(\n            '.gitignore',\n          )} with environment files.`,\n        );\n\n        analytics.capture('wizard interaction', {\n          action: 'failed to create gitignore',\n          integration,\n          error: error instanceof Error ? error.message : 'Unknown error',\n        });\n\n        return {\n          relativeEnvFilePath,\n          addedEnvVariables,\n          addedGitignore,\n        };\n      }\n    }\n\n    analytics.capture('wizard interaction', {\n      action: 'added environment variables',\n      integration,\n    });\n\n    return {\n      relativeEnvFilePath,\n      addedEnvVariables,\n      addedGitignore,\n    };\n  });\n}\n"]}