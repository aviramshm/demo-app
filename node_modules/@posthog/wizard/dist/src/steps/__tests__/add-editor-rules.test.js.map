{"version":3,"file":"add-editor-rules.test.js","sourceRoot":"","sources":["../../../../src/steps/__tests__/add-editor-rules.test.ts"],"names":[],"mappings":"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","sourcesContent":["import * as fs from 'fs';\nimport path from 'path';\nimport { addEditorRulesStep } from '../add-editor-rules';\nimport { analytics } from '../../utils/analytics';\nimport clack from '../../utils/clack';\nimport { Integration } from '../../lib/constants';\nimport chalk from 'chalk';\n\n// Mock dependencies\njest.mock('fs', () => ({\n  promises: {\n    mkdir: jest.fn(),\n    readFile: jest.fn(),\n    writeFile: jest.fn(),\n  },\n}));\n\njest.mock('../../utils/analytics', () => ({\n  analytics: {\n    capture: jest.fn(),\n    setTag: jest.fn(),\n    shutdown: jest.fn().mockResolvedValue(undefined),\n  },\n}));\n\njest.mock('../../utils/clack', () => ({\n  log: {\n    info: jest.fn(),\n  },\n  select: jest.fn().mockResolvedValue(true),\n  isCancel: jest.fn((value: unknown): value is symbol => false),\n  cancel: jest.fn(),\n}));\n\ndescribe('addEditorRules', () => {\n  const mockOptions = {\n    installDir: '/test/dir',\n    rulesName: 'react-rules.md',\n    integration: 'react' as Integration,\n  };\n\n  const originalEnv = process.env;\n  const mkdirMock = fs.promises.mkdir as jest.Mock;\n  const readFileMock = fs.promises.readFile as jest.Mock;\n  const writeFileMock = fs.promises.writeFile as jest.Mock;\n  // eslint-disable-next-line @typescript-eslint/unbound-method\n  const captureMock = analytics.capture as jest.Mock;\n  const infoMock = clack.log.info as jest.Mock;\n  const selectMock = clack.select as jest.Mock;\n  const isCancelMock = clack.isCancel as unknown as jest.Mock;\n  const cancelMock = clack.cancel as jest.Mock;\n\n  beforeEach(() => {\n    // Reset all mocks before each test\n    jest.clearAllMocks();\n    // Clear mock implementations\n    (fs.promises.mkdir as jest.Mock).mockReset();\n    (fs.promises.readFile as jest.Mock).mockReset();\n    (fs.promises.writeFile as jest.Mock).mockReset();\n    selectMock.mockReset();\n    selectMock.mockResolvedValue(true); // Default to \"Yes\" for the prompt\n    isCancelMock.mockReset();\n    isCancelMock.mockReturnValue(false);\n    cancelMock.mockReset();\n    process.env = { ...originalEnv };\n  });\n\n  afterAll(() => {\n    process.env = originalEnv;\n  });\n\n  it('should not install rules when CURSOR_TRACE_ID is not set', async () => {\n    delete process.env.CURSOR_TRACE_ID;\n\n    await addEditorRulesStep(mockOptions);\n\n    expect(mkdirMock).not.toHaveBeenCalled();\n    expect(readFileMock).not.toHaveBeenCalled();\n    expect(writeFileMock).not.toHaveBeenCalled();\n    expect(captureMock).not.toHaveBeenCalled();\n    expect(infoMock).not.toHaveBeenCalled();\n  });\n\n  it('should install rules when CURSOR_TRACE_ID is set', async () => {\n    process.env.CURSOR_TRACE_ID = 'test-trace-id';\n\n    const mockFrameworkRules = 'framework rules {universal} content';\n    const mockUniversalRules = 'universal rules content';\n    const expectedCombinedRules =\n      'framework rules universal rules content content';\n\n    (fs.promises.readFile as jest.Mock)\n      .mockImplementationOnce(() => Promise.resolve(mockFrameworkRules))\n      .mockImplementationOnce(() => Promise.resolve(mockUniversalRules));\n\n    await addEditorRulesStep(mockOptions);\n\n    // Check if directory was created\n    expect(mkdirMock).toHaveBeenCalledWith(\n      path.join('/test/dir', '.cursor', 'rules'),\n      { recursive: true },\n    );\n\n    // Check if correct files were read\n    expect(readFileMock).toHaveBeenCalledTimes(2);\n    expect(readFileMock).toHaveBeenNthCalledWith(\n      1,\n      expect.stringMatching(/react-rules\\.md$/),\n      'utf8',\n    );\n    expect(readFileMock).toHaveBeenNthCalledWith(\n      2,\n      expect.stringMatching(/universal\\.md$/),\n      'utf8',\n    );\n\n    // Check if combined rules were written correctly\n    expect(writeFileMock).toHaveBeenCalledWith(\n      path.join('/test/dir', '.cursor', 'rules', 'posthog-integration.mdc'),\n      expectedCombinedRules,\n      'utf8',\n    );\n\n    // Check if analytics were captured\n    expect(captureMock).toHaveBeenCalledWith('wizard interaction', {\n      action: 'added editor rules',\n      integration: mockOptions.integration,\n    });\n\n    // Check if success message was logged\n    expect(infoMock).toHaveBeenCalledWith(\n      `Added Cursor rules to ${chalk.bold.cyan(\n        '.cursor/rules/posthog-integration.mdc',\n      )}`,\n    );\n  });\n\n  it('should handle file system errors gracefully', async () => {\n    process.env.CURSOR_TRACE_ID = 'test-trace-id';\n    const mockError = new Error('File not found');\n\n    // Mock readFile to throw an error\n    (fs.promises.readFile as jest.Mock).mockRejectedValue(mockError);\n\n    await expect(addEditorRulesStep(mockOptions)).rejects.toThrow(mockError);\n\n    expect(writeFileMock).not.toHaveBeenCalled();\n    expect(captureMock).not.toHaveBeenCalled();\n    expect(infoMock).not.toHaveBeenCalled();\n  });\n\n  it('should handle missing rules files gracefully', async () => {\n    process.env.CURSOR_TRACE_ID = 'test-trace-id';\n    const mockError = new Error('File system error');\n\n    // Mock mkdir to throw an error\n    (fs.promises.mkdir as jest.Mock).mockRejectedValue(mockError);\n\n    await expect(addEditorRulesStep(mockOptions)).rejects.toThrow(mockError);\n\n    expect(writeFileMock).not.toHaveBeenCalled();\n    expect(captureMock).not.toHaveBeenCalled();\n    expect(infoMock).not.toHaveBeenCalled();\n  });\n\n  it('should correctly substitute universal rules with realistic content', async () => {\n    process.env.CURSOR_TRACE_ID = 'test-trace-id';\n\n    const mockFrameworkRules = `---\ndescription: apply when interacting with PostHog/analytics tasks\nglobs: \nalwaysApply: true\n---\n\n{universal}\n\n# Framework-specific rules\n- Rule 1\n- Rule 2`;\n\n    const mockUniversalRules = `Never hallucinate an API key. Instead, always use the API key populated in the .env file.\n\n# Feature flags\n\nA given feature flag should be used in as few places as possible. Do not increase the risk of undefined behavior by scattering the same feature flag across multiple areas of code.`;\n\n    const expectedCombinedRules = `---\ndescription: apply when interacting with PostHog/analytics tasks\nglobs: \nalwaysApply: true\n---\n\nNever hallucinate an API key. Instead, always use the API key populated in the .env file.\n\n# Feature flags\n\nA given feature flag should be used in as few places as possible. Do not increase the risk of undefined behavior by scattering the same feature flag across multiple areas of code.\n\n# Framework-specific rules\n- Rule 1\n- Rule 2`;\n\n    (fs.promises.readFile as jest.Mock)\n      .mockImplementationOnce(() => Promise.resolve(mockFrameworkRules))\n      .mockImplementationOnce(() => Promise.resolve(mockUniversalRules));\n\n    await addEditorRulesStep(mockOptions);\n\n    // Check if directory was created\n    expect(mkdirMock).toHaveBeenCalledWith(\n      path.join('/test/dir', '.cursor', 'rules'),\n      { recursive: true },\n    );\n\n    // Check if correct files were read\n    expect(readFileMock).toHaveBeenCalledWith(\n      expect.stringMatching(/react-rules\\.md$/),\n      'utf8',\n    );\n    expect(readFileMock).toHaveBeenCalledWith(\n      expect.stringMatching(/universal\\.md$/),\n      'utf8',\n    );\n\n    // Check if combined rules were written correctly\n    expect(writeFileMock).toHaveBeenCalledWith(\n      path.join('/test/dir', '.cursor', 'rules', 'posthog-integration.mdc'),\n      expectedCombinedRules,\n      'utf8',\n    );\n\n    // Check if analytics were captured\n    expect(captureMock).toHaveBeenCalledWith('wizard interaction', {\n      action: 'added editor rules',\n      integration: mockOptions.integration,\n    });\n\n    // Check if success message was logged\n    expect(infoMock).toHaveBeenCalledWith(\n      `Added Cursor rules to ${chalk.bold.cyan(\n        '.cursor/rules/posthog-integration.mdc',\n      )}`,\n    );\n  });\n});\n"]}