{"version":3,"file":"run-prettier.js","sourceRoot":"","sources":["../../../src/steps/run-prettier.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAaA,0CA+DC;AA3ED,4CAAyC;AACzC,kDAA+C;AAC/C,2DAAmC;AACnC,sDAI8B;AAC9B,wDAA4D;AAE5D,iEAAmD;AAE5C,KAAK,UAAU,eAAe,CAAC,EACpC,UAAU,EACV,WAAW,GAGZ;IACC,OAAO,IAAA,qBAAS,EAAC,cAAc,EAAE,KAAK,IAAI,EAAE;QAC1C,IAAI,CAAC,IAAA,yBAAW,GAAE,EAAE,CAAC;YACnB,qFAAqF;YACrF,wFAAwF;YACxF,OAAO;QACT,CAAC;QAED,MAAM,uBAAuB,GAAG,IAAA,4CAA8B,GAAE;aAC7D,GAAG,CAAC,CAAC,QAAQ,EAAE,EAAE;YAChB,OAAO,QAAQ,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC;QAClE,CAAC,CAAC;aACD,IAAI,CAAC,GAAG,CAAC,CAAC;QAEb,IAAI,CAAC,uBAAuB,CAAC,MAAM,EAAE,CAAC;YACpC,+FAA+F;YAC/F,OAAO;QACT,CAAC;QAED,MAAM,WAAW,GAAG,MAAM,IAAA,+BAAiB,EAAC,EAAE,UAAU,EAAE,CAAC,CAAC;QAC5D,MAAM,iBAAiB,GAAG,IAAA,kCAAmB,EAAC,UAAU,EAAE,WAAW,CAAC,CAAC;QAEvE,qBAAS,CAAC,MAAM,CAAC,oBAAoB,EAAE,iBAAiB,CAAC,CAAC;QAE1D,IAAI,CAAC,iBAAiB,EAAE,CAAC;YACvB,OAAO;QACT,CAAC;QAED,MAAM,eAAe,GAAG,eAAK,CAAC,OAAO,EAAE,CAAC;QACxC,eAAe,CAAC,KAAK,CAAC,iCAAiC,CAAC,CAAC;QAEzD,IAAI,CAAC;YACH,MAAM,IAAI,OAAO,CAAO,CAAC,OAAO,EAAE,MAAM,EAAE,EAAE;gBAC1C,YAAY,CAAC,IAAI,CACf,yCAAyC,uBAAuB,EAAE,EAClE,CAAC,GAAG,EAAE,EAAE;oBACN,IAAI,GAAG,EAAE,CAAC;wBACR,MAAM,CAAC,GAAG,CAAC,CAAC;oBACd,CAAC;yBAAM,CAAC;wBACN,OAAO,EAAE,CAAC;oBACZ,CAAC;gBACH,CAAC,CACF,CAAC;YACJ,CAAC,CAAC,CAAC;QACL,CAAC;QAAC,OAAO,CAAC,EAAE,CAAC;YACX,eAAe,CAAC,IAAI,CAClB,sEAAsE,CACvE,CAAC;YACF,OAAO;QACT,CAAC;QAED,eAAe,CAAC,IAAI,CAAC,oCAAoC,CAAC,CAAC;QAE3D,qBAAS,CAAC,OAAO,CAAC,oBAAoB,EAAE;YACtC,MAAM,EAAE,cAAc;YACtB,WAAW;SACZ,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;AACL,CAAC","sourcesContent":["import type { Integration } from '../lib/constants';\nimport { traceStep } from '../telemetry';\nimport { analytics } from '../utils/analytics';\nimport clack from '../utils/clack';\nimport {\n  getPackageDotJson,\n  getUncommittedOrUntrackedFiles,\n  isInGitRepo,\n} from '../utils/clack-utils';\nimport { hasPackageInstalled } from '../utils/package-json';\nimport type { WizardOptions } from '../utils/types';\nimport * as childProcess from 'node:child_process';\n\nexport async function runPrettierStep({\n  installDir,\n  integration,\n}: Pick<WizardOptions, 'installDir'> & {\n  integration: Integration;\n}): Promise<void> {\n  return traceStep('run-prettier', async () => {\n    if (!isInGitRepo()) {\n      // We only run formatting on changed files. If we're not in a git repo, we can't find\n      // changed files. So let's early-return without showing any formatting-related messages.\n      return;\n    }\n\n    const changedOrUntrackedFiles = getUncommittedOrUntrackedFiles()\n      .map((filename) => {\n        return filename.startsWith('- ') ? filename.slice(2) : filename;\n      })\n      .join(' ');\n\n    if (!changedOrUntrackedFiles.length) {\n      // Likewise, if we can't find changed or untracked files, there's no point in running Prettier.\n      return;\n    }\n\n    const packageJson = await getPackageDotJson({ installDir });\n    const prettierInstalled = hasPackageInstalled('prettier', packageJson);\n\n    analytics.setTag('prettier-installed', prettierInstalled);\n\n    if (!prettierInstalled) {\n      return;\n    }\n\n    const prettierSpinner = clack.spinner();\n    prettierSpinner.start('Running Prettier on your files.');\n\n    try {\n      await new Promise<void>((resolve, reject) => {\n        childProcess.exec(\n          `npx prettier --ignore-unknown --write ${changedOrUntrackedFiles}`,\n          (err) => {\n            if (err) {\n              reject(err);\n            } else {\n              resolve();\n            }\n          },\n        );\n      });\n    } catch (e) {\n      prettierSpinner.stop(\n        'Prettier failed to run. You may want to format the changes manually.',\n      );\n      return;\n    }\n\n    prettierSpinner.stop('Prettier has formatted your files.');\n\n    analytics.capture('wizard interaction', {\n      action: 'ran prettier',\n      integration,\n    });\n  });\n}\n"]}