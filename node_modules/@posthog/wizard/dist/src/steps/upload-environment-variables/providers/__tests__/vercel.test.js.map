{"version":3,"file":"vercel.test.js","sourceRoot":"","sources":["../../../../../../src/steps/upload-environment-variables/providers/__tests__/vercel.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { VercelEnvironmentProvider } from '../vercel';\nimport * as fs from 'fs';\nimport * as child_process from 'child_process';\n\njest.mock('fs');\njest.mock('child_process');\n\nconst mockOptions = { installDir: '/tmp/project' };\n\ndescribe('VercelEnvironmentProvider', () => {\n  let provider: VercelEnvironmentProvider;\n\n  beforeEach(() => {\n    provider = new VercelEnvironmentProvider(mockOptions as any);\n    jest.clearAllMocks();\n  });\n\n  it('should detect Vercel CLI, project link, and authentication', async () => {\n    (child_process.execSync as jest.Mock).mockReturnValue(undefined);\n    (fs.existsSync as jest.Mock).mockImplementation((p: string) => {\n      if (p.endsWith('.vercel')) return true;\n      if (p.endsWith('project.json')) return true;\n      return false;\n    });\n    (child_process.spawnSync as jest.Mock).mockReturnValue({\n      stdout: 'testuser',\n      stderr: '',\n      status: 0,\n    });\n\n    await expect(provider.detect()).resolves.toBe(true);\n  });\n\n  it('should return false if Vercel CLI is missing', async () => {\n    (child_process.execSync as jest.Mock).mockImplementation(() => {\n      throw new Error();\n    });\n    await expect(provider.detect()).resolves.toBe(false);\n  });\n\n  it('should return false if project is not linked', async () => {\n    (child_process.execSync as jest.Mock).mockReturnValue(undefined);\n    (fs.existsSync as jest.Mock).mockReturnValue(false);\n    await expect(provider.detect()).resolves.toBe(false);\n  });\n\n  it('should return false if not authenticated', async () => {\n    (child_process.execSync as jest.Mock).mockReturnValue(undefined);\n    (fs.existsSync as jest.Mock).mockReturnValue(true);\n    (child_process.spawnSync as jest.Mock).mockReturnValue({\n      stdout: 'Log in to Vercel',\n      stderr: '',\n      status: 0,\n    });\n    await expect(provider.detect()).resolves.toBe(false);\n  });\n\n  it('should return false if env var already exists', async () => {\n    const stdinMock = { write: jest.fn(), end: jest.fn() };\n    let closeCallback: ((code: number) => void) | undefined;\n    const onMock = jest.fn((event, cb) => {\n      if (event === 'close') closeCallback = cb;\n    });\n\n    // Simulate a process with a writable stderr stream\n    let stderrListener: ((data: Buffer | string) => void) | undefined;\n    const stderr = {\n      on: jest.fn((event, cb) => {\n        if (event === 'data') stderrListener = cb;\n      }),\n    };\n\n    (child_process.spawn as jest.Mock).mockReturnValue({\n      stdin: stdinMock,\n      on: onMock,\n      stderr,\n    });\n\n    const uploadPromise = provider.uploadEnvVars({ FOO: 'bar' });\n\n    // Simulate \"already exists\" error on stderr, then process close\n    stderrListener && stderrListener('already exists');\n    closeCallback && closeCallback(1);\n\n    await expect(uploadPromise).resolves.toEqual({ FOO: false });\n  });\n\n  it('should attempt to upload environment variables', async () => {\n    (child_process.spawn as jest.Mock).mockReturnValue({});\n\n    await provider.uploadEnvVars({ FOO: 'bar' });\n\n    expect(child_process.spawn).toHaveBeenCalledWith(\n      'vercel',\n      ['env', 'add', 'FOO', 'production'],\n      expect.objectContaining({ stdio: ['pipe', 'pipe', 'pipe'] }),\n    );\n  });\n});\n"]}