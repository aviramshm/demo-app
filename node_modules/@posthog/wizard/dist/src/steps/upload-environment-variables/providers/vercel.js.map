{"version":3,"file":"vercel.js","sourceRoot":"","sources":["../../../../../src/steps/upload-environment-variables/providers/vercel.ts"],"names":[],"mappings":"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","sourcesContent":["import { execSync, spawn, spawnSync } from 'child_process';\nimport { EnvironmentProvider } from '../EnvironmentProvider';\nimport * as fs from 'fs';\nimport * as path from 'path';\nimport type { WizardOptions } from '../../../utils/types';\nimport clack from '../../../utils/clack';\nimport chalk from 'chalk';\nimport { analytics } from '../../../utils/analytics';\n\nexport class VercelEnvironmentProvider extends EnvironmentProvider {\n  name = 'Vercel';\n  environments = ['production', 'preview', 'development'];\n\n  constructor(options: WizardOptions) {\n    super(options);\n  }\n\n  // eslint-disable-next-line @typescript-eslint/require-await\n  async detect(): Promise<boolean> {\n    const vercelDetected =\n      this.hasVercelCli() && this.isProjectLinked() && this.isAuthenticated();\n\n    analytics.setTag('vercel-detected', vercelDetected);\n\n    return vercelDetected;\n  }\n\n  hasDotVercelDir(): boolean {\n    const dotVercelDir = path.join(this.options.installDir, '.vercel');\n    return fs.existsSync(dotVercelDir);\n  }\n\n  hasVercelCli(): boolean {\n    try {\n      execSync('vercel --version', { stdio: 'ignore' });\n      analytics.setTag('vercel-cli-installed', true);\n      return true;\n    } catch {\n      analytics.setTag('vercel-cli-installed', false);\n      return false;\n    }\n  }\n\n  isProjectLinked(): boolean {\n    const isProjectLinked = fs.existsSync(\n      path.join(this.options.installDir, '.vercel', 'project.json'),\n    );\n\n    analytics.setTag('vercel-project-linked', isProjectLinked);\n\n    return isProjectLinked;\n  }\n\n  isAuthenticated(): boolean {\n    const result = spawnSync('vercel', ['whoami'], {\n      encoding: 'utf-8',\n      stdio: ['pipe', 'pipe', 'pipe'], // suppress prompts\n      env: {\n        ...process.env,\n        FORCE_COLOR: '0', // avoid ANSI formatting\n        CI: '1', // hint to CLI that it's a non-interactive env\n      },\n    });\n\n    const output = (\n      String(result.stdout) + String(result.stderr)\n    ).toLowerCase();\n\n    if (\n      output.includes('log in to vercel') ||\n      output.includes('vercel login') ||\n      result.status !== 0\n    ) {\n      analytics.setTag('vercel-authenticated', false);\n      return false;\n    }\n\n    analytics.setTag('vercel-authenticated', true);\n\n    return true;\n  }\n\n  async uploadEnvironmentVariable(\n    key: string,\n    value: string,\n    environment: string,\n  ): Promise<void> {\n    await new Promise<void>((resolve, reject) => {\n      const proc = spawn('vercel', ['env', 'add', key, environment], {\n        stdio: ['pipe', 'pipe', 'pipe'],\n      });\n\n      let stderr = '';\n      proc.stderr.on('data', (data) => {\n        stderr += data.toString();\n      });\n\n      proc.stdin.write(value);\n      proc.stdin.end();\n\n      proc.on('close', (code) => {\n        if (\n          stderr.includes('already exists') ||\n          stderr.includes('already been added') ||\n          stderr.includes('vercel env rm')\n        ) {\n          reject(\n            new Error(\n              `❌ Environment variable ${chalk.cyan(key)} already exists in ${\n                this.name\n              }. Please upload it manually.`,\n            ),\n          );\n        } else if (code === 0) {\n          resolve();\n        } else {\n          reject(\n            new Error(\n              `❌ Failed to upload environment variable ${chalk.cyan(key)} to ${\n                this.name\n              }. Please upload it manually.`,\n            ),\n          );\n        }\n      });\n    });\n  }\n\n  async uploadEnvVars(\n    vars: Record<string, string>,\n  ): Promise<Record<string, boolean>> {\n    const results: Record<string, boolean> = {};\n\n    for (const [key, value] of Object.entries(vars)) {\n      const spinner = clack.spinner();\n\n      spinner.start(`Uploading ${chalk.cyan(key)} to ${this.name}...`);\n      await Promise.all(\n        this.environments.map((environment) =>\n          this.uploadEnvironmentVariable(key, value, environment),\n        ),\n      )\n        .then(() => {\n          spinner.stop(`✅ Uploaded ${chalk.cyan(key)} to ${this.name}`);\n          results[key] = true;\n        })\n        .catch((err) => {\n          spinner.stop(\n            err instanceof Error\n              ? err.message\n              : `❌ Failed to upload environment variables to ${this.name}. Please upload it manually.`,\n          );\n          results[key] = false;\n        });\n    }\n\n    return results;\n  }\n}\n"]}