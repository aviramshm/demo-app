{"version":3,"file":"MCPClient.js","sourceRoot":"","sources":["../../../../src/steps/add-mcp-server-to-clients/MCPClient.ts"],"names":[],"mappings":"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","sourcesContent":["import * as fs from 'fs';\nimport * as path from 'path';\nimport * as jsonc from 'jsonc-parser';\nimport { getDefaultServerConfig } from './defaults';\n\nexport abstract class MCPClient {\n  name: string;\n  abstract getConfigPath(): Promise<string>;\n  abstract getServerPropertyName(): string;\n  abstract isServerInstalled(local?: boolean): Promise<boolean>;\n  abstract addServer(\n    apiKey: string,\n    selectedFeatures?: string[],\n    local?: boolean,\n  ): Promise<{ success: boolean }>;\n  abstract removeServer(local?: boolean): Promise<{ success: boolean }>;\n  abstract isClientSupported(): Promise<boolean>;\n}\n\nexport abstract class DefaultMCPClient extends MCPClient {\n  name = 'Default';\n\n  constructor() {\n    super();\n  }\n\n  getServerPropertyName(): string {\n    return 'mcpServers';\n  }\n\n  getServerConfig(\n    apiKey: string,\n    type: 'sse' | 'streamable-http',\n    selectedFeatures?: string[],\n    local?: boolean,\n  ) {\n    return getDefaultServerConfig(apiKey, type, selectedFeatures, local);\n  }\n\n  async isServerInstalled(local?: boolean): Promise<boolean> {\n    try {\n      const configPath = await this.getConfigPath();\n\n      if (!fs.existsSync(configPath)) {\n        return false;\n      }\n\n      const configContent = await fs.promises.readFile(configPath, 'utf8');\n      const config = jsonc.parse(configContent) as Record<string, any>;\n      const serverPropertyName = this.getServerPropertyName();\n      const serverName = local ? 'posthog-local' : 'posthog';\n\n      return (\n        serverPropertyName in config && serverName in config[serverPropertyName]\n      );\n    } catch {\n      return false;\n    }\n  }\n\n  async addServer(\n    apiKey: string,\n    selectedFeatures?: string[],\n    local?: boolean,\n  ): Promise<{ success: boolean }> {\n    return this._addServerType(apiKey, 'sse', selectedFeatures, local);\n  }\n\n  async _addServerType(\n    apiKey: string,\n    type: 'sse' | 'streamable-http',\n    selectedFeatures?: string[],\n    local?: boolean,\n  ): Promise<{ success: boolean }> {\n    try {\n      const configPath = await this.getConfigPath();\n      const configDir = path.dirname(configPath);\n\n      await fs.promises.mkdir(configDir, { recursive: true });\n\n      const serverPropertyName = this.getServerPropertyName();\n      let configContent = '';\n      let existingConfig = {};\n\n      if (fs.existsSync(configPath)) {\n        configContent = await fs.promises.readFile(configPath, 'utf8');\n        existingConfig = jsonc.parse(configContent) || {};\n      }\n\n      const newServerConfig = this.getServerConfig(\n        apiKey,\n        type,\n        selectedFeatures,\n        local,\n      );\n      const typedConfig = existingConfig as Record<string, any>;\n      if (!typedConfig[serverPropertyName]) {\n        typedConfig[serverPropertyName] = {};\n      }\n      const serverName = local ? 'posthog-local' : 'posthog';\n      typedConfig[serverPropertyName][serverName] = newServerConfig;\n\n      const edits = jsonc.modify(\n        configContent,\n        [serverPropertyName, serverName],\n        newServerConfig,\n        {\n          formattingOptions: {\n            tabSize: 2,\n            insertSpaces: true,\n          },\n        },\n      );\n\n      const modifiedContent = jsonc.applyEdits(configContent, edits);\n\n      await fs.promises.writeFile(configPath, modifiedContent, 'utf8');\n\n      return { success: true };\n    } catch {\n      return { success: false };\n    }\n  }\n\n  async removeServer(local?: boolean): Promise<{ success: boolean }> {\n    try {\n      const configPath = await this.getConfigPath();\n\n      if (!fs.existsSync(configPath)) {\n        return { success: false };\n      }\n\n      const configContent = await fs.promises.readFile(configPath, 'utf8');\n      const config = jsonc.parse(configContent) as Record<string, any>;\n      const serverPropertyName = this.getServerPropertyName();\n\n      const serverName = local ? 'posthog-local' : 'posthog';\n\n      if (\n        serverPropertyName in config &&\n        serverName in config[serverPropertyName]\n      ) {\n        const edits = jsonc.modify(\n          configContent,\n          [serverPropertyName, serverName],\n          undefined,\n          {\n            formattingOptions: {\n              tabSize: 2,\n              insertSpaces: true,\n            },\n          },\n        );\n\n        const modifiedContent = jsonc.applyEdits(configContent, edits);\n\n        await fs.promises.writeFile(configPath, modifiedContent, 'utf8');\n\n        return { success: true };\n      }\n    } catch {\n      //\n    }\n\n    return { success: false };\n  }\n}\n"]}