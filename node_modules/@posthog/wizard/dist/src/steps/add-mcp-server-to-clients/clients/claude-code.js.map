{"version":3,"file":"claude-code.js","sourceRoot":"","sources":["../../../../../src/steps/add-mcp-server-to-clients/clients/claude-code.ts"],"names":[],"mappings":"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","sourcesContent":["import { DefaultMCPClient } from '../MCPClient';\nimport { DefaultMCPClientConfig } from '../defaults';\nimport { z } from 'zod';\nimport { execSync } from 'child_process';\nimport { analytics } from '../../../utils/analytics';\nimport { debug } from '../../../utils/debug';\nimport * as os from 'os';\nimport * as path from 'path';\nimport * as fs from 'fs';\n\nexport const ClaudeCodeMCPConfig = DefaultMCPClientConfig;\n\nexport type ClaudeCodeMCPConfig = z.infer<typeof DefaultMCPClientConfig>;\n\nexport class ClaudeCodeMCPClient extends DefaultMCPClient {\n  name = 'Claude Code';\n  private claudeBinaryPath: string | null = null;\n\n  constructor() {\n    super();\n  }\n\n  private findClaudeBinary(): string | null {\n    if (this.claudeBinaryPath) {\n      return this.claudeBinaryPath;\n    }\n\n    // Common installation paths for Claude Code CLI\n    const possiblePaths = [\n      path.join(os.homedir(), '.claude', 'local', 'claude'),\n      '/usr/local/bin/claude',\n      '/opt/homebrew/bin/claude',\n    ];\n\n    for (const claudePath of possiblePaths) {\n      if (fs.existsSync(claudePath)) {\n        debug(`  Found claude binary at: ${claudePath}`);\n        this.claudeBinaryPath = claudePath;\n        return claudePath;\n      }\n    }\n\n    // Try PATH as fallback\n    try {\n      execSync('command -v claude', { stdio: 'pipe' });\n      debug('  Found claude in PATH');\n      this.claudeBinaryPath = 'claude';\n      return 'claude';\n    } catch {\n      // Not in PATH\n    }\n\n    return null;\n  }\n\n  isClientSupported(): Promise<boolean> {\n    try {\n      debug('  Checking for Claude Code...');\n      const claudeBinary = this.findClaudeBinary();\n\n      if (!claudeBinary) {\n        debug('  Claude Code not found. Installation paths checked:');\n        debug(`    - ${path.join(os.homedir(), '.claude', 'local', 'claude')}`);\n        debug(`    - /usr/local/bin/claude`);\n        debug(`    - /opt/homebrew/bin/claude`);\n        debug(`    - PATH`);\n        return Promise.resolve(false);\n      }\n\n      const output = execSync(`${claudeBinary} --version`, { stdio: 'pipe' });\n      const version = output.toString().trim();\n      debug(`  Claude Code detected: ${version}`);\n      return Promise.resolve(true);\n    } catch (error) {\n      debug(\n        `  Claude Code check failed: ${\n          error instanceof Error ? error.message : String(error)\n        }`,\n      );\n      return Promise.resolve(false);\n    }\n  }\n\n  isServerInstalled(local?: boolean): Promise<boolean> {\n    try {\n      const claudeBinary = this.findClaudeBinary();\n      if (!claudeBinary) {\n        return Promise.resolve(false);\n      }\n\n      // check if specific server name exists in output\n      const output = execSync(`${claudeBinary} mcp list`, {\n        stdio: 'pipe',\n      });\n\n      const outputStr = output.toString();\n      const serverName = local ? 'posthog-local' : 'posthog';\n\n      if (outputStr.includes(serverName)) {\n        return Promise.resolve(true);\n      }\n    } catch {\n      //\n    }\n\n    return Promise.resolve(false);\n  }\n\n  getConfigPath(): Promise<string> {\n    throw new Error('Not implemented');\n  }\n\n  addServer(\n    apiKey: string,\n    selectedFeatures?: string[],\n    local?: boolean,\n  ): Promise<{ success: boolean }> {\n    const claudeBinary = this.findClaudeBinary();\n    if (!claudeBinary) {\n      return Promise.resolve({ success: false });\n    }\n\n    // Build Claude Code-specific config\n    // Based on getDefaultServerConfig() but with fixes for Claude Code bugs\n    const config = this.buildClaudeCodeConfig(apiKey, selectedFeatures, local);\n    const serverName = local ? 'posthog-local' : 'posthog';\n\n    const command = `${claudeBinary} mcp add-json ${serverName} -s user '${JSON.stringify(\n      config,\n    )}'`;\n\n    try {\n      execSync(command);\n    } catch (error) {\n      analytics.captureException(\n        new Error(\n          `Failed to add server to Claude Code: ${\n            error instanceof Error ? error.message : String(error)\n          }`,\n        ),\n      );\n      return Promise.resolve({ success: false });\n    }\n\n    return Promise.resolve({ success: true });\n  }\n\n  private buildClaudeCodeConfig(\n    apiKey: string,\n    selectedFeatures?: string[],\n    local?: boolean,\n  ) {\n    // Replicate getDefaultServerConfig() logic but with Claude Code fixes:\n    // 1. Add https:// protocol (mcp-remote requires valid URLs)\n    // 2. Embed token directly in Authorization header (env var expansion broken)\n    //\n    // Claude Code bugs:\n    // - https://github.com/anthropics/claude-code/issues/6204\n    // - https://github.com/anthropics/claude-code/issues/9427\n    // - https://github.com/anthropics/claude-code/issues/10955\n\n    const protocol = local ? 'http://' : 'https://';\n    const host = local ? 'localhost:8787' : 'mcp.posthog.com';\n    const baseUrl = `${protocol}${host}/sse`;\n\n    const ALL_FEATURE_VALUES = [\n      'dashboards',\n      'insights',\n      'experiments',\n      'llm-analytics',\n      'error-tracking',\n      'flags',\n      'workspace',\n      'docs',\n    ];\n\n    const isAllFeaturesSelected =\n      selectedFeatures &&\n      selectedFeatures.length === ALL_FEATURE_VALUES.length &&\n      ALL_FEATURE_VALUES.every((feature) => selectedFeatures.includes(feature));\n\n    const urlWithFeatures =\n      selectedFeatures && selectedFeatures.length > 0 && !isAllFeaturesSelected\n        ? `${baseUrl}?features=${selectedFeatures.join(',')}`\n        : baseUrl;\n\n    return {\n      command: 'npx',\n      args: [\n        '-y',\n        'mcp-remote@latest',\n        urlWithFeatures,\n        '--header',\n        `Authorization:Bearer ${apiKey}`, // Embed token directly (not ${VAR})\n      ],\n      // Keep env block for backward compatibility if bugs get fixed\n      env: {\n        POSTHOG_AUTH_HEADER: `Bearer ${apiKey}`,\n      },\n    };\n  }\n\n  removeServer(local?: boolean): Promise<{ success: boolean }> {\n    const claudeBinary = this.findClaudeBinary();\n    if (!claudeBinary) {\n      return Promise.resolve({ success: false });\n    }\n\n    const serverName = local ? 'posthog-local' : 'posthog';\n    const command = `${claudeBinary} mcp remove --scope user ${serverName}`;\n\n    try {\n      execSync(command);\n    } catch (error) {\n      analytics.captureException(\n        new Error(\n          `Failed to remove server from Claude Code: ${\n            error instanceof Error ? error.message : String(error)\n          }`,\n        ),\n      );\n      return Promise.resolve({ success: false });\n    }\n\n    return Promise.resolve({ success: true });\n  }\n}\n"]}