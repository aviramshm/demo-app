{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../src/steps/add-mcp-server-to-clients/index.ts"],"names":[],"mappings":"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","sourcesContent":["import type { Integration } from '../../lib/constants';\nimport { traceStep } from '../../telemetry';\nimport { analytics } from '../../utils/analytics';\nimport clack from '../../utils/clack';\nimport chalk from 'chalk';\nimport { abortIfCancelled, askForCloudRegion } from '../../utils/clack-utils';\nimport { MCPClient } from './MCPClient';\nimport { CursorMCPClient } from './clients/cursor';\nimport { ClaudeMCPClient } from './clients/claude';\nimport { getPersonalApiKey } from '../../mcp';\nimport type { CloudRegion } from '../../utils/types';\nimport { ClaudeCodeMCPClient } from './clients/claude-code';\nimport { VisualStudioCodeClient } from './clients/visual-studio-code';\nimport { ZedClient } from './clients/zed';\nimport { CodexMCPClient } from './clients/codex';\nimport { AVAILABLE_FEATURES, ALL_FEATURE_VALUES } from './defaults';\nimport { debug } from '../../utils/debug';\n\nexport const getSupportedClients = async (): Promise<MCPClient[]> => {\n  const allClients = [\n    new CursorMCPClient(),\n    new ClaudeMCPClient(),\n    new ClaudeCodeMCPClient(),\n    new VisualStudioCodeClient(),\n    new ZedClient(),\n    new CodexMCPClient(),\n  ];\n  const supportedClients: MCPClient[] = [];\n\n  debug('Checking for supported MCP clients...');\n  for (const client of allClients) {\n    const isSupported = await client.isClientSupported();\n    debug(`${client.name}: ${isSupported ? '✓ supported' : '✗ not supported'}`);\n    if (isSupported) {\n      supportedClients.push(client);\n    }\n  }\n  debug(\n    `Found ${supportedClients.length} supported client(s): ${supportedClients\n      .map((c) => c.name)\n      .join(', ')}`,\n  );\n\n  return supportedClients;\n};\n\nexport const addMCPServerToClientsStep = async ({\n  integration,\n  cloudRegion,\n  askPermission = true,\n  local = false,\n}: {\n  integration?: Integration;\n  cloudRegion?: CloudRegion;\n  askPermission?: boolean;\n  local?: boolean;\n}): Promise<string[]> => {\n  const region = cloudRegion ?? (await askForCloudRegion());\n\n  const hasPermission = askPermission\n    ? await abortIfCancelled(\n        clack.select({\n          message: local\n            ? 'Would you like to install the local development MCP server?'\n            : 'Would you like to install the MCP server to use PostHog in your editor?',\n          options: [\n            { value: true, label: 'Yes' },\n            { value: false, label: 'No' },\n          ],\n        }),\n        integration,\n      )\n    : true;\n\n  if (!hasPermission) {\n    return [];\n  }\n\n  const { groupMultiselect } = await import('@clack/prompts');\n  const selectedFeatures = await abortIfCancelled(\n    groupMultiselect({\n      message: `Select which PostHog features to enable as tools: ${chalk.dim(\n        '(Toggle: Space, Confirm: Enter, Toggle All: A, Cancel: CTRL + C)',\n      )}`,\n      options: AVAILABLE_FEATURES,\n      initialValues: [...ALL_FEATURE_VALUES],\n      required: false,\n    }),\n    integration,\n  );\n\n  const supportedClients = await getSupportedClients();\n\n  const { multiselect } = await import('@clack/prompts');\n  const selectedClientNames = await abortIfCancelled(\n    multiselect({\n      message: `Select which MCP clients to install the MCP server to: ${chalk.dim(\n        '(Toggle: Space, Confirm: Enter, Toggle All: A, Cancel: CTRL + C)',\n      )}`,\n      options: supportedClients.map((client) => ({\n        value: client.name,\n        label: client.name,\n      })),\n      initialValues: supportedClients.map((client) => client.name),\n      required: true,\n    }),\n    integration,\n  );\n\n  const clients = supportedClients.filter((client) =>\n    selectedClientNames.includes(client.name),\n  );\n\n  // Only check for existing installations in the clients the user selected\n  const installedClients = [];\n  for (const client of clients) {\n    if (await client.isServerInstalled(local)) {\n      installedClients.push(client);\n    }\n  }\n\n  if (installedClients.length > 0) {\n    clack.log.warn(\n      `The MCP server is already configured for:\n  ${installedClients.map((c) => `- ${c.name}`).join('\\n  ')}`,\n    );\n\n    const reinstall = await abortIfCancelled(\n      clack.select({\n        message: 'Would you like to reinstall it?',\n        options: [\n          {\n            value: true,\n            label: 'Yes',\n            hint: 'Reinstall the MCP server',\n          },\n          {\n            value: false,\n            label: 'No',\n            hint: 'Keep the existing installation',\n          },\n        ],\n      }),\n      integration,\n    );\n\n    if (!reinstall) {\n      analytics.capture('wizard interaction', {\n        action: 'declined to reinstall mcp servers',\n        clients: installedClients.map((c) => c.name),\n        integration,\n      });\n\n      return [];\n    }\n\n    await removeMCPServer(installedClients, local);\n    clack.log.info('Removed existing installation.');\n  }\n\n  const personalApiKey = await getPersonalApiKey({ cloudRegion: region });\n\n  await traceStep('adding mcp servers', async () => {\n    await addMCPServer(clients, personalApiKey, selectedFeatures, local);\n  });\n\n  clack.log.success(\n    `Added the MCP server to:\n  ${clients.map((c) => `- ${c.name}`).join('\\n  ')} `,\n  );\n\n  analytics.capture('wizard interaction', {\n    action: 'added mcp servers',\n    clients: clients.map((c) => c.name),\n    integration,\n  });\n\n  return clients.map((c) => c.name);\n};\n\nexport const removeMCPServerFromClientsStep = async ({\n  integration,\n  local = false,\n}: {\n  integration?: Integration;\n  local?: boolean;\n}): Promise<string[]> => {\n  const installedClients = await getInstalledClients(local);\n  if (installedClients.length === 0) {\n    analytics.capture('wizard interaction', {\n      action: 'no mcp servers to remove',\n      integration,\n    });\n    return [];\n  }\n\n  const { multiselect } = await import('@clack/prompts');\n  const selectedClientNames = await abortIfCancelled(\n    multiselect({\n      message: `Select which clients to remove the MCP server from: ${chalk.dim(\n        '(Toggle: Space, Confirm: Enter, Toggle All: A, Cancel: CTRL + C)',\n      )}`,\n      options: installedClients.map((client) => ({\n        value: client.name,\n        label: client.name,\n      })),\n      initialValues: installedClients.map((client) => client.name),\n    }),\n    integration,\n  );\n\n  const clientsToRemove = installedClients.filter((client) =>\n    selectedClientNames.includes(client.name),\n  );\n\n  if (clientsToRemove.length === 0) {\n    analytics.capture('wizard interaction', {\n      action: 'no mcp servers selected for removal',\n      integration,\n    });\n    return [];\n  }\n\n  const results = await traceStep('removing mcp servers', async () => {\n    await removeMCPServer(clientsToRemove, local);\n    return clientsToRemove.map((c) => c.name);\n  });\n\n  analytics.capture('wizard interaction', {\n    action: 'removed mcp servers',\n    clients: results,\n    integration,\n  });\n\n  return results;\n};\n\nexport const getInstalledClients = async (\n  local?: boolean,\n): Promise<MCPClient[]> => {\n  const clients = await getSupportedClients();\n  const installedClients: MCPClient[] = [];\n\n  for (const client of clients) {\n    if (await client.isServerInstalled(local)) {\n      installedClients.push(client);\n    }\n  }\n\n  return installedClients;\n};\n\nexport const addMCPServer = async (\n  clients: MCPClient[],\n  personalApiKey: string,\n  selectedFeatures?: string[],\n  local?: boolean,\n): Promise<void> => {\n  for (const client of clients) {\n    await client.addServer(personalApiKey, selectedFeatures, local);\n  }\n};\n\nexport const removeMCPServer = async (\n  clients: MCPClient[],\n  local?: boolean,\n): Promise<void> => {\n  for (const client of clients) {\n    await client.removeServer(local);\n  }\n};\n"]}