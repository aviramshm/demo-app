{"version":3,"file":"prompt-builder.js","sources":["../../src/prompt-builder.ts"],"sourcesContent":["import type { Task, UrlMention, PostHogResource } from './types.js';\nimport type { TemplateVariables } from './template-manager.js';\nimport { Logger } from './utils/logger.js';\nimport { promises as fs } from 'fs';\nimport { join } from 'path';\n\nexport interface PromptBuilderDeps {\n  getTaskFiles: (taskId: string) => Promise<any[]>;\n  generatePlanTemplate: (vars: TemplateVariables) => Promise<string>;\n  posthogClient?: { fetchResourceByUrl: (mention: UrlMention) => Promise<PostHogResource> };\n  logger?: Logger;\n}\n\nexport class PromptBuilder {\n  private getTaskFiles: PromptBuilderDeps['getTaskFiles'];\n  private generatePlanTemplate: PromptBuilderDeps['generatePlanTemplate'];\n  private posthogClient?: PromptBuilderDeps['posthogClient'];\n  private logger: Logger;\n\n  constructor(deps: PromptBuilderDeps) {\n    this.getTaskFiles = deps.getTaskFiles;\n    this.generatePlanTemplate = deps.generatePlanTemplate;\n    this.posthogClient = deps.posthogClient;\n    this.logger = deps.logger || new Logger({ debug: false, prefix: '[PromptBuilder]' });\n  }\n\n  /**\n   * Extract file paths from XML tags in description\n   * Format: <file path=\"relative/path.ts\" />\n   */\n  private extractFilePaths(description: string): string[] {\n    const fileTagRegex = /<file\\s+path=\"([^\"]+)\"\\s*\\/>/g;\n    const paths: string[] = [];\n    let match: RegExpExecArray | null;\n\n    while ((match = fileTagRegex.exec(description)) !== null) {\n      paths.push(match[1]);\n    }\n\n    return paths;\n  }\n\n  /**\n   * Read file contents from repository\n   */\n  private async readFileContent(repositoryPath: string, filePath: string): Promise<string | null> {\n    try {\n      const fullPath = join(repositoryPath, filePath);\n      const content = await fs.readFile(fullPath, 'utf8');\n      return content;\n    } catch (error) {\n      this.logger.warn(`Failed to read referenced file: ${filePath}`, { error });\n      return null;\n    }\n  }\n\n  /**\n   * Extract URL mentions from XML tags in description\n   * Formats: <error id=\"...\" />, <experiment id=\"...\" />, <url href=\"...\" />\n   */\n  private extractUrlMentions(description: string): UrlMention[] {\n    const mentions: UrlMention[] = [];\n    \n    // PostHog resource mentions: <error id=\"...\" />, <experiment id=\"...\" />, etc.\n    const resourceRegex = /<(error|experiment|insight|feature_flag)\\s+id=\"([^\"]+)\"\\s*\\/>/g;\n    let match: RegExpExecArray | null;\n\n    while ((match = resourceRegex.exec(description)) !== null) {\n      const [, type, id] = match;\n      mentions.push({\n        url: '', // Will be reconstructed if needed\n        type: type as any,\n        id,\n        label: this.generateUrlLabel('', type as any),\n      });\n    }\n\n    // Generic URL mentions: <url href=\"...\" />\n    const urlRegex = /<url\\s+href=\"([^\"]+)\"\\s*\\/>/g;\n    while ((match = urlRegex.exec(description)) !== null) {\n      const [, url] = match;\n      mentions.push({\n        url,\n        type: 'generic',\n        label: this.generateUrlLabel(url, 'generic'),\n      });\n    }\n\n    return mentions;\n  }\n\n  /**\n   * Generate a display label for a URL mention\n   */\n  private generateUrlLabel(url: string, type: string): string {\n    try {\n      const urlObj = new URL(url);\n      switch (type) {\n        case 'error':\n          const errorMatch = url.match(/error_tracking\\/([a-f0-9-]+)/);\n          return errorMatch ? `Error ${errorMatch[1].slice(0, 8)}...` : 'Error';\n        case 'experiment':\n          const expMatch = url.match(/experiments\\/(\\d+)/);\n          return expMatch ? `Experiment #${expMatch[1]}` : 'Experiment';\n        case 'insight':\n          return 'Insight';\n        case 'feature_flag':\n          return 'Feature Flag';\n        default:\n          return urlObj.hostname;\n      }\n    } catch {\n      return 'URL';\n    }\n  }\n\n  /**\n   * Process URL references and fetch their content\n   */\n  private async processUrlReferences(\n    description: string\n  ): Promise<{ description: string; referencedResources: PostHogResource[] }> {\n    const urlMentions = this.extractUrlMentions(description);\n    const referencedResources: PostHogResource[] = [];\n\n    if (urlMentions.length === 0 || !this.posthogClient) {\n      return { description, referencedResources };\n    }\n\n    // Fetch all referenced resources\n    for (const mention of urlMentions) {\n      try {\n        const resource = await this.posthogClient.fetchResourceByUrl(mention);\n        referencedResources.push(resource);\n      } catch (error) {\n        this.logger.warn(`Failed to fetch resource from URL: ${mention.url}`, { error });\n        // Add a placeholder resource for failed fetches\n        referencedResources.push({\n          type: mention.type,\n          id: mention.id || '',\n          url: mention.url,\n          title: mention.label || 'Unknown Resource',\n          content: `Failed to fetch resource from ${mention.url}: ${error}`,\n          metadata: {},\n        });\n      }\n    }\n\n    // Replace URL tags with just the label for readability\n    let processedDescription = description;\n    for (const mention of urlMentions) {\n      if (mention.type === 'generic') {\n        // Generic URLs: <url href=\"...\" />\n        const escapedUrl = mention.url.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n        processedDescription = processedDescription.replace(\n          new RegExp(`<url\\\\s+href=\"${escapedUrl}\"\\\\s*/>`, 'g'),\n          `@${mention.label}`\n        );\n      } else {\n        // PostHog resources: <error id=\"...\" />, <experiment id=\"...\" />, etc.\n        const escapedType = mention.type.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n        const escapedId = mention.id ? mention.id.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&') : '';\n        processedDescription = processedDescription.replace(\n          new RegExp(`<${escapedType}\\\\s+id=\"${escapedId}\"\\\\s*/>`, 'g'),\n          `@${mention.label}`\n        );\n      }\n    }\n\n    return { description: processedDescription, referencedResources };\n  }\n\n  /**\n   * Process description to extract file tags and read contents\n   * Returns processed description and referenced file contents\n   */\n  private async processFileReferences(\n    description: string,\n    repositoryPath?: string\n  ): Promise<{ description: string; referencedFiles: Array<{ path: string; content: string }> }> {\n    const filePaths = this.extractFilePaths(description);\n    const referencedFiles: Array<{ path: string; content: string }> = [];\n\n    if (filePaths.length === 0 || !repositoryPath) {\n      return { description, referencedFiles };\n    }\n\n    // Read all referenced files\n    for (const filePath of filePaths) {\n      const content = await this.readFileContent(repositoryPath, filePath);\n      if (content !== null) {\n        referencedFiles.push({ path: filePath, content });\n      }\n    }\n\n    // Replace file tags with just the filename for readability\n    let processedDescription = description;\n    for (const filePath of filePaths) {\n      const fileName = filePath.split('/').pop() || filePath;\n      processedDescription = processedDescription.replace(\n        new RegExp(`<file\\\\s+path=\"${filePath.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&')}\"\\\\s*/>`, 'g'),\n        `@${fileName}`\n      );\n    }\n\n    return { description: processedDescription, referencedFiles };\n  }\n\n  async buildResearchPrompt(task: Task, repositoryPath?: string): Promise<string> {\n    // Process file references in description\n    const { description: descriptionAfterFiles, referencedFiles } = await this.processFileReferences(\n      task.description,\n      repositoryPath\n    );\n\n    // Process URL references in description  \n    const { description: processedDescription, referencedResources } = await this.processUrlReferences(\n      descriptionAfterFiles\n    );\n\n    let prompt = '';\n    prompt += `## Current Task\\n\\n**Task**: ${task.title}\\n**Description**: ${processedDescription}`;\n\n    if ((task as any).primary_repository) {\n      prompt += `\\n**Repository**: ${(task as any).primary_repository}`;\n    }\n\n    // Add referenced files from @ mentions\n    if (referencedFiles.length > 0) {\n      prompt += `\\n\\n## Referenced Files\\n\\n`;\n      for (const file of referencedFiles) {\n        prompt += `### ${file.path}\\n\\`\\`\\`\\n${file.content}\\n\\`\\`\\`\\n\\n`;\n      }\n    }\n\n    // Add referenced resources from URL mentions\n    if (referencedResources.length > 0) {\n      prompt += `\\n\\n## Referenced Resources\\n\\n`;\n      for (const resource of referencedResources) {\n        prompt += `### ${resource.title} (${resource.type})\\n**URL**: ${resource.url}\\n\\n${resource.content}\\n\\n`;\n      }\n    }\n\n    try {\n      const taskFiles = await this.getTaskFiles(task.id);\n      const contextFiles = taskFiles.filter((f: any) => f.type === 'context' || f.type === 'reference');\n      if (contextFiles.length > 0) {\n        prompt += `\\n\\n## Supporting Files`;\n        for (const file of contextFiles) {\n          prompt += `\\n\\n### ${file.name} (${file.type})\\n${file.content}`;\n        }\n      }\n    } catch (error) {\n      this.logger.debug('No existing task files found for research', { taskId: task.id });\n    }\n\n    prompt += `\\n\\nPlease explore the codebase thoroughly and generate 3-5 clarifying questions that will help guide the implementation of this task. Use the \\`create_plan\\` tool to create a research.md artifact with your questions in the markdown format specified in your system prompt.`;\n\n    return prompt;\n  }\n\n  async buildPlanningPrompt(task: Task, repositoryPath?: string): Promise<string> {\n    // Process file references in description\n    const { description: descriptionAfterFiles, referencedFiles } = await this.processFileReferences(\n      task.description,\n      repositoryPath\n    );\n\n    // Process URL references in description  \n    const { description: processedDescription, referencedResources } = await this.processUrlReferences(\n      descriptionAfterFiles\n    );\n\n    let prompt = '';\n    prompt += `## Current Task\\n\\n**Task**: ${task.title}\\n**Description**: ${processedDescription}`;\n\n    if ((task as any).primary_repository) {\n      prompt += `\\n**Repository**: ${(task as any).primary_repository}`;\n    }\n\n    // Add referenced files from @ mentions\n    if (referencedFiles.length > 0) {\n      prompt += `\\n\\n## Referenced Files\\n\\n`;\n      for (const file of referencedFiles) {\n        prompt += `### ${file.path}\\n\\`\\`\\`\\n${file.content}\\n\\`\\`\\`\\n\\n`;\n      }\n    }\n\n    // Add referenced resources from URL mentions\n    if (referencedResources.length > 0) {\n      prompt += `\\n\\n## Referenced Resources\\n\\n`;\n      for (const resource of referencedResources) {\n        prompt += `### ${resource.title} (${resource.type})\\n**URL**: ${resource.url}\\n\\n${resource.content}\\n\\n`;\n      }\n    }\n\n    try {\n      const taskFiles = await this.getTaskFiles(task.id);\n      const contextFiles = taskFiles.filter((f: any) => f.type === 'context' || f.type === 'reference');\n      if (contextFiles.length > 0) {\n        prompt += `\\n\\n## Supporting Files`;\n        for (const file of contextFiles) {\n          prompt += `\\n\\n### ${file.name} (${file.type})\\n${file.content}`;\n        }\n      }\n    } catch (error) {\n      this.logger.debug('No existing task files found for planning', { taskId: task.id });\n    }\n\n    const templateVariables = {\n      task_id: task.id,\n      task_title: task.title,\n      task_description: processedDescription,\n      date: new Date().toISOString().split('T')[0],\n      repository: ((task as any).primary_repository || '') as string,\n    };\n\n    const planTemplate = await this.generatePlanTemplate(templateVariables);\n\n    prompt += `\\n\\nPlease analyze the codebase and create a detailed implementation plan for this task. Use the following template structure for your plan:\\n\\n${planTemplate}\\n\\nFill in each section with specific, actionable information based on your analysis. Replace all placeholder content with actual details about this task.`;\n\n    return prompt;\n  }\n\n  async buildExecutionPrompt(task: Task, repositoryPath?: string): Promise<string> {\n    // Process file references in description\n    const { description: descriptionAfterFiles, referencedFiles } = await this.processFileReferences(\n      task.description,\n      repositoryPath\n    );\n\n    // Process URL references in description  \n    const { description: processedDescription, referencedResources } = await this.processUrlReferences(\n      descriptionAfterFiles\n    );\n\n    let prompt = '';\n    prompt += `## Current Task\\n\\n**Task**: ${task.title}\\n**Description**: ${processedDescription}`;\n\n    if ((task as any).primary_repository) {\n      prompt += `\\n**Repository**: ${(task as any).primary_repository}`;\n    }\n\n    // Add referenced files from @ mentions\n    if (referencedFiles.length > 0) {\n      prompt += `\\n\\n## Referenced Files\\n\\n`;\n      for (const file of referencedFiles) {\n        prompt += `### ${file.path}\\n\\`\\`\\`\\n${file.content}\\n\\`\\`\\`\\n\\n`;\n      }\n    }\n\n    // Add referenced resources from URL mentions\n    if (referencedResources.length > 0) {\n      prompt += `\\n\\n## Referenced Resources\\n\\n`;\n      for (const resource of referencedResources) {\n        prompt += `### ${resource.title} (${resource.type})\\n**URL**: ${resource.url}\\n\\n${resource.content}\\n\\n`;\n      }\n    }\n\n    try {\n      const taskFiles = await this.getTaskFiles(task.id);\n      const hasPlan = taskFiles.some((f: any) => f.type === 'plan');\n      if (taskFiles.length > 0) {\n        prompt += `\\n\\n## Context and Supporting Information`;\n        for (const file of taskFiles) {\n          if (file.type === 'plan') {\n            prompt += `\\n\\n### Execution Plan\\n${file.content}`;\n          } else {\n            prompt += `\\n\\n### ${file.name} (${file.type})\\n${file.content}`;\n          }\n        }\n      }\n      if (hasPlan) {\n        prompt += `\\n\\nPlease implement the changes described in the execution plan above. Follow the plan step-by-step and make the necessary file modifications. You must actually edit files and make changes - do not just analyze or review.`;\n      } else {\n        prompt += `\\n\\nPlease implement the changes described in the task above. You must actually edit files and make changes - do not just analyze or review.`;\n      }\n    } catch (error) {\n      this.logger.debug('No supporting files found for execution', { taskId: task.id });\n      prompt += `\\n\\nPlease implement the changes described in the task above.`;\n    }\n    return prompt;\n  }\n}\n\n\n"],"names":["fs"],"mappings":"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"}