{"version":3,"file":"file-manager.js","sources":["../../src/file-manager.ts"],"sourcesContent":["import { promises as fs } from 'fs';\nimport { join, dirname } from 'path';\nimport type { SupportingFile } from './types.js';\nimport { Logger } from './utils/logger.js';\n\nexport interface TaskFile {\n  name: string;\n  content: string;\n  type: 'plan' | 'context' | 'reference' | 'output' | 'artifact';\n}\n\nexport interface QuestionData {\n  id: string;\n  question: string;\n  options: string[];\n}\n\nexport interface AnswerData {\n  questionId: string;\n  selectedOption: string;\n  customInput?: string;\n}\n\nexport interface QuestionsFile {\n  questions: QuestionData[];\n  answered: boolean;\n  answers: AnswerData[] | null;\n}\n\nexport class PostHogFileManager {\n  private repositoryPath: string;\n  private logger: Logger;\n\n  constructor(repositoryPath: string, logger?: Logger) {\n    this.repositoryPath = repositoryPath;\n    this.logger = logger || new Logger({ debug: false, prefix: '[FileManager]' });\n  }\n\n  private getTaskDirectory(taskId: string): string {\n    return join(this.repositoryPath, '.posthog', taskId);\n  }\n\n  private getTaskFilePath(taskId: string, fileName: string): string {\n    return join(this.getTaskDirectory(taskId), fileName);\n  }\n\n  async ensureTaskDirectory(taskId: string): Promise<void> {\n    const taskDir = this.getTaskDirectory(taskId);\n    try {\n      await fs.access(taskDir);\n    } catch {\n      await fs.mkdir(taskDir, { recursive: true });\n    }\n  }\n\n  async writeTaskFile(taskId: string, file: TaskFile): Promise<void> {\n    await this.ensureTaskDirectory(taskId);\n    const filePath = this.getTaskFilePath(taskId, file.name);\n\n    this.logger.debug('Writing task file', {\n      filePath,\n      contentLength: file.content.length,\n      contentType: typeof file.content\n    });\n\n    await fs.writeFile(filePath, file.content, 'utf8');\n\n    this.logger.debug('File written successfully', { filePath });\n  }\n\n  async readTaskFile(taskId: string, fileName: string): Promise<string | null> {\n    try {\n      const filePath = this.getTaskFilePath(taskId, fileName);\n      return await fs.readFile(filePath, 'utf8');\n    } catch (error) {\n      if ((error as NodeJS.ErrnoException).code === 'ENOENT') {\n        return null;\n      }\n      throw error;\n    }\n  }\n\n  async listTaskFiles(taskId: string): Promise<string[]> {\n    try {\n      const taskDir = this.getTaskDirectory(taskId);\n      const files = await fs.readdir(taskDir);\n      return files.filter(file => !file.startsWith('.'));\n    } catch (error) {\n      if ((error as NodeJS.ErrnoException).code === 'ENOENT') {\n        return [];\n      }\n      throw error;\n    }\n  }\n\n  async deleteTaskFile(taskId: string, fileName: string): Promise<void> {\n    try {\n      const filePath = this.getTaskFilePath(taskId, fileName);\n      await fs.unlink(filePath);\n    } catch (error) {\n      if ((error as NodeJS.ErrnoException).code !== 'ENOENT') {\n        throw error;\n      }\n    }\n  }\n\n  async taskDirectoryExists(taskId: string): Promise<boolean> {\n    try {\n      const taskDir = this.getTaskDirectory(taskId);\n      await fs.access(taskDir);\n      return true;\n    } catch {\n      return false;\n    }\n  }\n\n  async cleanupTaskDirectory(taskId: string): Promise<void> {\n    try {\n      const taskDir = this.getTaskDirectory(taskId);\n      await fs.rm(taskDir, { recursive: true, force: true });\n    } catch (error) {\n      if ((error as NodeJS.ErrnoException).code !== 'ENOENT') {\n        throw error;\n      }\n    }\n  }\n\n  // Convenience methods for common file types\n  async writePlan(taskId: string, plan: string): Promise<void> {\n    this.logger.debug('Writing plan', {\n      taskId,\n      planLength: plan.length,\n      contentPreview: plan.substring(0, 200)\n    });\n\n    await this.writeTaskFile(taskId, {\n      name: 'plan.md',\n      content: plan,\n      type: 'plan'\n    });\n\n    this.logger.info('Plan file written', { taskId });\n  }\n\n  async readPlan(taskId: string): Promise<string | null> {\n    return await this.readTaskFile(taskId, 'plan.md');\n  }\n\n  async writeContext(taskId: string, context: string): Promise<void> {\n    await this.writeTaskFile(taskId, {\n      name: 'context.md',\n      content: context,\n      type: 'context'\n    });\n  }\n\n  async readContext(taskId: string): Promise<string | null> {\n    return await this.readTaskFile(taskId, 'context.md');\n  }\n\n  async writeRequirements(taskId: string, requirements: string): Promise<void> {\n    await this.writeTaskFile(taskId, {\n      name: 'requirements.md',\n      content: requirements,\n      type: 'reference'\n    });\n  }\n\n  async readRequirements(taskId: string): Promise<string | null> {\n    return await this.readTaskFile(taskId, 'requirements.md');\n  }\n\n  async writeResearch(taskId: string, content: string): Promise<void> {\n    this.logger.debug('Writing research', {\n      taskId,\n      contentLength: content.length,\n      contentPreview: content.substring(0, 200)\n    });\n\n    await this.writeTaskFile(taskId, {\n      name: 'research.md',\n      content: content,\n      type: 'artifact'\n    });\n\n    this.logger.info('Research file written', { taskId });\n  }\n\n  async readResearch(taskId: string): Promise<string | null> {\n    return await this.readTaskFile(taskId, 'research.md');\n  }\n\n  async writeQuestions(taskId: string, data: QuestionsFile): Promise<void> {\n    this.logger.debug('Writing questions', {\n      taskId,\n      questionCount: data.questions.length,\n      answered: data.answered,\n    });\n\n    await this.writeTaskFile(taskId, {\n      name: 'questions.json',\n      content: JSON.stringify(data, null, 2),\n      type: 'artifact'\n    });\n\n    this.logger.info('Questions file written', { taskId });\n  }\n\n  async readQuestions(taskId: string): Promise<QuestionsFile | null> {\n    try {\n      const content = await this.readTaskFile(taskId, 'questions.json');\n      return content ? JSON.parse(content) as QuestionsFile : null;\n    } catch (error) {\n      this.logger.debug('Failed to parse questions.json', { error });\n      return null;\n    }\n  }\n\n  async getTaskFiles(taskId: string): Promise<SupportingFile[]> {\n    const fileNames = await this.listTaskFiles(taskId);\n    const files: SupportingFile[] = [];\n    \n    for (const fileName of fileNames) {\n      const content = await this.readTaskFile(taskId, fileName);\n      if (content !== null) {\n        // Determine type based on file name\n        let type: SupportingFile['type'] = 'reference';\n        if (fileName === 'plan.md') type = 'plan';\n        else if (fileName === 'context.md') type = 'context';\n        else if (fileName === 'requirements.md') type = 'reference';\n        else if (fileName.startsWith('output_')) type = 'output';\n        \n        files.push({\n          name: fileName,\n          content,\n          type,\n          created_at: new Date().toISOString() // Could be enhanced with file stats\n        });\n      }\n    }\n    \n    return files;\n  }\n\n  async ensureGitignore(): Promise<void> {\n    const gitignorePath = join(this.repositoryPath, '.posthog', '.gitignore');\n    const gitignoreContent = `# PostHog task artifacts - customize as needed\n# Exclude temporary files\n*/temp/\n*/cache/\n*/.env\n*/.secrets\n\n# Include plans and documentation by default\n!*/plan.md\n!*/context.md\n!*/requirements.md\n!*/README.md\n`;\n\n    try {\n      await fs.access(gitignorePath);\n    } catch {\n      await fs.mkdir(dirname(gitignorePath), { recursive: true });\n      await fs.writeFile(gitignorePath, gitignoreContent, 'utf8');\n    }\n  }\n}\n"],"names":["fs"],"mappings":"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"}