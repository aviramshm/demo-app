{"version":3,"file":"stage-executor.js","sources":["../../src/stage-executor.ts"],"sourcesContent":["import { query } from '@anthropic-ai/claude-agent-sdk';\nimport { Logger } from './utils/logger.js';\nimport { ClaudeAdapter } from './adapters/claude/claude-adapter.js';\nimport { AgentRegistry } from './agent-registry.js';\nimport type { AgentEvent, Task, McpServerConfig } from './types.js';\nimport type { WorkflowStage, WorkflowStageExecutionResult, WorkflowExecutionOptions } from './workflow-types.js';\nimport { RESEARCH_SYSTEM_PROMPT } from './agents/research.js';\nimport { PLANNING_SYSTEM_PROMPT } from './agents/planning.js';\nimport { EXECUTION_SYSTEM_PROMPT } from './agents/execution.js';\nimport { PromptBuilder } from './prompt-builder.js';\n\nexport class StageExecutor {\n  private registry: AgentRegistry;\n  private logger: Logger;\n  private adapter: ClaudeAdapter;\n  private promptBuilder: PromptBuilder;\n  private eventHandler?: (event: AgentEvent) => void;\n  private mcpServers?: Record<string, McpServerConfig>;\n\n  constructor(\n    registry: AgentRegistry,\n    logger: Logger,\n    promptBuilder?: PromptBuilder,\n    eventHandler?: (event: AgentEvent) => void,\n    mcpServers?: Record<string, McpServerConfig>,\n  ) {\n    this.registry = registry;\n    this.logger = logger.child('StageExecutor');\n    this.adapter = new ClaudeAdapter();\n    this.promptBuilder = promptBuilder || new PromptBuilder({\n      getTaskFiles: async () => [],\n      generatePlanTemplate: async () => '',\n      logger,\n    });\n    this.eventHandler = eventHandler;\n    this.mcpServers = mcpServers;\n  }\n\n  setEventHandler(handler?: (event: AgentEvent) => void): void {\n    this.eventHandler = handler;\n  }\n\n  async execute(task: Task, stage: WorkflowStage, options: WorkflowExecutionOptions): Promise<WorkflowStageExecutionResult> {\n    const isManual = stage.is_manual_only === true;\n    if (isManual) {\n      this.logger.info('Manual stage detected; skipping agent execution', { stage: stage.key });\n      return { results: [] };\n    }\n\n    const inferredAgent = stage.key.toLowerCase().includes('plan') ? 'planning_basic' : 'code_generation';\n    const agentName = stage.agent_name || inferredAgent;\n    const agent = this.registry.getAgent(agentName);\n    if (!agent) {\n      throw new Error(`Unknown agent '${agentName}' for stage '${stage.key}'`);\n    }\n\n    const permissionMode = (options.permissionMode as any) || 'acceptEdits';\n    const cwd = options.repositoryPath || process.cwd();\n\n    switch (agent.agent_type) {\n      case 'research':\n        return this.runResearch(task, cwd, options, stage.key);\n      case 'planning':\n        return this.runPlanning(task, cwd, options, stage.key);\n      case 'execution':\n        return this.runExecution(task, cwd, permissionMode, options, stage.key);\n      case 'review': // TODO: Implement review\n      case 'testing': // TODO: Implement testing\n      default:\n        // throw new Error(`Unsupported agent type: ${agent.agent_type}`);\n        console.warn(`Unsupported agent type: ${agent.agent_type}`);\n        return { results: [] };\n    }\n  }\n\n  private async runResearch(task: Task, cwd: string, options: WorkflowExecutionOptions, stageKey: string): Promise<WorkflowStageExecutionResult> {\n    const contextPrompt = await this.promptBuilder.buildResearchPrompt(task, cwd);\n    let prompt = RESEARCH_SYSTEM_PROMPT + '\\n\\n' + contextPrompt;\n\n    const stageOverrides = options.stageOverrides?.[stageKey] || options.stageOverrides?.['research'];\n    const mergedOverrides = {\n      ...(options.queryOverrides || {}),\n      ...(stageOverrides?.queryOverrides || {}),\n    } as Record<string, any>;\n\n    const baseOptions: Record<string, any> = {\n      model: 'claude-sonnet-4-5-20250929',\n      cwd,\n      permissionMode: 'plan',\n      settingSources: ['local'],\n      mcpServers: this.mcpServers\n    };\n\n    const response = query({\n      prompt,\n      options: { ...baseOptions, ...mergedOverrides },\n    });\n\n    let research = '';\n    for await (const message of response) {\n      // Emit raw SDK event first\n      this.eventHandler?.(this.adapter.createRawSDKEvent(message));\n\n      // Then emit transformed event\n      const transformed = this.adapter.transform(message);\n      if (transformed) {\n        if (transformed.type !== 'token') {\n          this.logger.debug('Research event', { type: transformed.type });\n        }\n        this.eventHandler?.(transformed);\n      }\n\n      if (message.type === 'assistant' && message.message?.content) {\n        for (const c of message.message.content) {\n          if (c.type === 'text' && c.text) research += c.text + '\\n';\n        }\n      }\n    }\n\n    return { plan: research.trim() }; // Return as 'plan' field to match existing interface\n  }\n\n  private async runPlanning(task: Task, cwd: string, options: WorkflowExecutionOptions, stageKey: string): Promise<WorkflowStageExecutionResult> {\n    const contextPrompt = await this.promptBuilder.buildPlanningPrompt(task, cwd);\n    let prompt = PLANNING_SYSTEM_PROMPT + '\\n\\n' + contextPrompt;\n\n    const stageOverrides = options.stageOverrides?.[stageKey] || options.stageOverrides?.['plan'];\n    const mergedOverrides = {\n      ...(options.queryOverrides || {}),\n      ...(stageOverrides?.queryOverrides || {}),\n    } as Record<string, any>;\n\n    const baseOptions: Record<string, any> = {\n      model: 'claude-sonnet-4-5-20250929',\n      cwd,\n      permissionMode: 'plan',\n      settingSources: ['local'],\n      mcpServers: this.mcpServers\n    };\n\n    const response = query({\n      prompt,\n      options: { ...baseOptions, ...mergedOverrides },\n    });\n\n    let plan = '';\n    for await (const message of response) {\n      // Emit raw SDK event first\n      this.eventHandler?.(this.adapter.createRawSDKEvent(message));\n\n      // Then emit transformed event\n      const transformed = this.adapter.transform(message);\n      if (transformed) {\n        if (transformed.type !== 'token') {\n          this.logger.debug('Planning event', { type: transformed.type });\n        }\n        this.eventHandler?.(transformed);\n      }\n\n      if (message.type === 'assistant' && message.message?.content) {\n        for (const c of message.message.content) {\n          if (c.type === 'text' && c.text) plan += c.text + '\\n';\n        }\n      }\n    }\n\n    return { plan: plan.trim() };\n  }\n\n  private async runExecution(task: Task, cwd: string, permissionMode: WorkflowExecutionOptions['permissionMode'], options: WorkflowExecutionOptions, stageKey: string): Promise<WorkflowStageExecutionResult> {\n    const contextPrompt = await this.promptBuilder.buildExecutionPrompt(task, cwd);\n    let prompt = EXECUTION_SYSTEM_PROMPT + '\\n\\n' + contextPrompt;\n\n    const stageOverrides = options.stageOverrides?.[stageKey];\n    const mergedOverrides = {\n      ...(options.queryOverrides || {}),\n      ...(stageOverrides?.queryOverrides || {}),\n    } as Record<string, any>;\n\n    const baseOptions: Record<string, any> = {\n      model: 'claude-sonnet-4-5-20250929',\n      cwd,\n      permissionMode,\n      settingSources: ['local'],\n      mcpServers: this.mcpServers\n    };\n\n    const response = query({\n      prompt,\n      options: { ...baseOptions, ...mergedOverrides },\n    });\n    const results: any[] = [];\n    for await (const message of response) {\n      // Emit raw SDK event first\n      this.eventHandler?.(this.adapter.createRawSDKEvent(message));\n\n      // Then emit transformed event\n      const transformed = this.adapter.transform(message);\n      if (transformed) {\n        if (transformed.type !== 'token') {\n          this.logger.debug('Execution event', { type: transformed.type });\n        }\n        this.eventHandler?.(transformed);\n      }\n\n      results.push(message);\n    }\n    return { results };\n  }\n}\n"],"names":[],"mappings":"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"}