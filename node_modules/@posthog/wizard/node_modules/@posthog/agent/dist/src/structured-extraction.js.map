{"version":3,"file":"structured-extraction.js","sources":["../../src/structured-extraction.ts"],"sourcesContent":["import OpenAI from 'openai';\nimport { Logger } from './utils/logger.js';\n\nexport interface ExtractedQuestion {\n  id: string;\n  question: string;\n  options: string[];\n}\n\nexport interface ExtractedQuestionWithAnswer extends ExtractedQuestion {\n  recommendedAnswer: string;\n  justification: string;\n}\n\nconst questionsOnlySchema = {\n  type: 'object',\n  properties: {\n    questions: {\n      type: 'array',\n      items: {\n        type: 'object',\n        properties: {\n          id: { type: 'string' },\n          question: { type: 'string' },\n          options: {\n            type: 'array',\n            items: { type: 'string' }\n          }\n        },\n        required: ['id', 'question', 'options'],\n        additionalProperties: false\n      }\n    }\n  },\n  required: ['questions'],\n  additionalProperties: false\n};\n\nconst questionsWithAnswersSchema = {\n  type: 'object',\n  properties: {\n    questions: {\n      type: 'array',\n      items: {\n        type: 'object',\n        properties: {\n          id: { type: 'string' },\n          question: { type: 'string' },\n          options: {\n            type: 'array',\n            items: { type: 'string' }\n          },\n          recommendedAnswer: { type: 'string' },\n          justification: { type: 'string' }\n        },\n        required: ['id', 'question', 'options', 'recommendedAnswer', 'justification'],\n        additionalProperties: false\n      }\n    }\n  },\n  required: ['questions'],\n  additionalProperties: false\n};\n\nexport interface StructuredExtractor {\n  extractQuestions(researchContent: string): Promise<ExtractedQuestion[]>;\n  extractQuestionsWithAnswers(researchContent: string): Promise<ExtractedQuestionWithAnswer[]>;\n}\n\nexport class OpenAIExtractor implements StructuredExtractor {\n  private client: OpenAI;\n  private logger: Logger;\n\n  constructor(logger?: Logger) {\n    const apiKey = process.env.OPENAI_API_KEY;\n    if (!apiKey) {\n      throw new Error('OPENAI_API_KEY environment variable is required for structured extraction');\n    }\n    \n    this.client = new OpenAI({ apiKey });\n    this.logger = logger || new Logger({ debug: false, prefix: '[OpenAIExtractor]' });\n  }\n\n  async extractQuestions(researchContent: string): Promise<ExtractedQuestion[]> {\n    this.logger.debug('Extracting questions from research content', {\n      contentLength: researchContent.length,\n    });\n\n    const completion = await this.client.chat.completions.create({\n      model: 'gpt-4o-mini',\n      messages: [\n        {\n          role: 'system',\n          content: 'Extract the research questions from the provided markdown. Return a JSON object matching the schema.',\n        },\n        {\n          role: 'user',\n          content: researchContent,\n        },\n      ],\n      response_format: {\n        type: 'json_schema',\n        json_schema: {\n          name: 'questions',\n          strict: true,\n          schema: questionsOnlySchema,\n        },\n      },\n    });\n\n    const content = completion.choices[0].message.content;\n    if (!content) {\n      throw new Error('No content in OpenAI response');\n    }\n\n    const parsed = JSON.parse(content) as { questions: ExtractedQuestion[] };\n    \n    this.logger.info('Successfully extracted questions', {\n      questionCount: parsed.questions.length,\n    });\n\n    return parsed.questions;\n  }\n\n  async extractQuestionsWithAnswers(\n    researchContent: string,\n  ): Promise<ExtractedQuestionWithAnswer[]> {\n    this.logger.debug('Extracting questions with recommended answers', {\n      contentLength: researchContent.length,\n    });\n\n    const completion = await this.client.chat.completions.create({\n      model: 'gpt-4o-mini',\n      messages: [\n        {\n          role: 'system',\n          content: 'Extract the research questions from the markdown and provide recommended answers based on the analysis. For each question, include a recommendedAnswer (the letter: a, b, c, etc.) and a brief justification. Return a JSON object matching the schema.',\n        },\n        {\n          role: 'user',\n          content: researchContent,\n        },\n      ],\n      response_format: {\n        type: 'json_schema',\n        json_schema: {\n          name: 'questions_with_answers',\n          strict: true,\n          schema: questionsWithAnswersSchema,\n        },\n      },\n    });\n\n    const content = completion.choices[0].message.content;\n    if (!content) {\n      throw new Error('No content in OpenAI response');\n    }\n\n    const parsed = JSON.parse(content) as { questions: ExtractedQuestionWithAnswer[] };\n    \n    this.logger.info('Successfully extracted questions with answers', {\n      questionCount: parsed.questions.length,\n    });\n\n    return parsed.questions;\n  }\n}\n"],"names":[],"mappings":"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"}