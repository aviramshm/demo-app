{"version":3,"file":"task-progress-reporter.js","sources":["../../src/task-progress-reporter.ts"],"sourcesContent":["import type { Logger } from './utils/logger.js';\nimport type { PostHogAPIClient, TaskRunUpdate } from './posthog-api.js';\nimport type { AgentEvent, TaskRun } from './types.js';\n\ninterface ProgressMetadata {\n  totalSteps?: number;\n}\n\n/**\n * Persists task execution progress to PostHog so clients can poll for updates.\n *\n * The reporter is intentionally best-effort – failures are logged but never\n * allowed to break the agent execution flow.\n */\nexport class TaskProgressReporter {\n  private posthogAPI?: PostHogAPIClient;\n  private logger: Logger;\n  private taskRun?: TaskRun;\n  private taskId?: string;\n  private outputLog: string[] = [];\n  private totalSteps?: number;\n  private lastLogEntry?: string;\n\n  constructor(posthogAPI: PostHogAPIClient | undefined, logger: Logger) {\n    this.posthogAPI = posthogAPI;\n    this.logger = logger.child('TaskProgressReporter');\n  }\n\n  get runId(): string | undefined {\n    return this.taskRun?.id;\n  }\n\n  async start(taskId: string, metadata: ProgressMetadata = {}): Promise<void> {\n    if (!this.posthogAPI) {\n      return;\n    }\n\n    this.taskId = taskId;\n    this.totalSteps = metadata.totalSteps;\n\n    try {\n      const run = await this.posthogAPI.createTaskRun(taskId, {\n        status: 'started',\n        log: [],\n      });\n      this.taskRun = run;\n      this.outputLog = [];\n      this.logger.debug('Created task run', { taskId, runId: run.id });\n    } catch (error) {\n      this.logger.warn('Failed to create task run', { taskId, error: (error as Error).message });\n    }\n  }\n\n  async stageStarted(stageKey: string, stageIndex: number): Promise<void> {\n    await this.update({\n      status: 'in_progress',\n    }, `Stage started: ${stageKey}`);\n  }\n\n  async stageCompleted(stageKey: string, completedStages: number): Promise<void> {\n    await this.update({\n      status: 'in_progress',\n    }, `Stage completed: ${stageKey}`);\n  }\n\n  async branchCreated(stageKey: string, branchName: string): Promise<void> {\n    await this.appendLog(`Branch created (${stageKey}): ${branchName}`);\n  }\n\n  async commitMade(stageKey: string, kind: 'plan' | 'implementation'): Promise<void> {\n    await this.appendLog(`Commit made (${stageKey}, ${kind})`);\n  }\n\n  async pullRequestCreated(stageKey: string, prUrl: string): Promise<void> {\n    await this.appendLog(`Pull request created (${stageKey}): ${prUrl}`);\n  }\n\n  async noNextStage(stageKey?: string): Promise<void> {\n    await this.appendLog(\n      stageKey\n        ? `No next stage available after '${stageKey}'. Execution halted.`\n        : 'No next stage available. Execution halted.'\n    );\n  }\n\n  async complete(): Promise<void> {\n    await this.update({ status: 'completed' }, 'Workflow execution completed');\n  }\n\n  async fail(error: Error | string): Promise<void> {\n    const message = typeof error === 'string' ? error : error.message;\n    await this.update({ status: 'failed', error_message: message }, `Workflow execution failed: ${message}`);\n  }\n\n  async appendLog(line: string): Promise<void> {\n    await this.update({}, line);\n  }\n\n  async recordEvent(event: AgentEvent): Promise<void> {\n    if (!this.posthogAPI || !this.runId || !this.taskId) {\n      return;\n    }\n\n    switch (event.type) {\n      case 'token':\n      case 'message_delta':\n      case 'content_block_start':\n      case 'content_block_stop':\n      case 'compact_boundary':\n      case 'message_start':\n      case 'message_stop':\n      case 'metric':\n      case 'artifact':\n      case 'raw_sdk_event':\n        // Skip verbose streaming artifacts from persistence\n        return;\n\n      case 'tool_call': {\n        const logLine = this.formatToolCallEvent(event);\n        if (logLine) {\n          await this.appendLog(logLine);\n        }\n        return;\n      }\n\n      case 'tool_result': {\n        const logLine = this.formatToolResultEvent(event);\n        if (logLine) {\n          await this.appendLog(logLine);\n        }\n        return;\n      }\n\n      case 'status':\n        // Status events are covered by dedicated progress updates\n        return;\n\n      case 'error':\n        await this.appendLog(`[error] ${event.message}`);\n        return;\n\n      case 'done': {\n        const cost = event.totalCostUsd !== undefined ? ` cost=$${event.totalCostUsd.toFixed(2)}` : '';\n        await this.appendLog(\n          `[done] duration=${event.durationMs ?? 'unknown'}ms turns=${event.numTurns ?? 'unknown'}${cost}`\n        );\n        return;\n      }\n\n      case 'init':\n        // Omit verbose init messages from persisted log\n        return;\n\n      case 'user_message': {\n        const summary = this.summarizeUserMessage(event.content);\n        if (summary) {\n          await this.appendLog(summary);\n        }\n        return;\n      }\n\n      default:\n        // For any unfamiliar event types, avoid spamming the log.\n        return;\n    }\n  }\n\n  private async update(update: TaskRunUpdate, logLine?: string): Promise<void> {\n    if (!this.posthogAPI || !this.runId || !this.taskId) {\n      return;\n    }\n\n    // If there's a log line, append it separately using the append_log endpoint\n    if (logLine && logLine !== this.lastLogEntry) {\n      try {\n        await this.posthogAPI.appendTaskRunLog(this.taskId, this.runId, [\n          { type: 'info', message: logLine }\n        ]);\n        this.lastLogEntry = logLine;\n      } catch (error) {\n        this.logger.warn('Failed to append log entry', {\n          taskId: this.taskId,\n          runId: this.runId,\n          error: (error as Error).message,\n        });\n      }\n    }\n\n    // Update other fields if provided\n    if (Object.keys(update).length > 0) {\n      try {\n        const run = await this.posthogAPI.updateTaskRun(this.taskId, this.runId, update);\n        this.taskRun = run;\n      } catch (error) {\n        this.logger.warn('Failed to update task run', {\n          taskId: this.taskId,\n          runId: this.runId,\n          error: (error as Error).message,\n        });\n      }\n    }\n  }\n\n  private summarizeUserMessage(content?: string): string | null {\n    if (!content) {\n      return null;\n    }\n    const trimmed = content.trim();\n    if (!trimmed) {\n      return null;\n    }\n\n    const fileUpdateMatch = trimmed.match(/The file\\s+([^\\s]+)\\s+has been updated/i);\n    if (fileUpdateMatch) {\n      return `[user] file updated: ${fileUpdateMatch[1]}`;\n    }\n\n    if (/Todos have been modified/i.test(trimmed)) {\n      return '[todo] list updated';\n    }\n\n    const diffMatch = trimmed.match(/diff --git a\\/([^\\s]+) b\\/([^\\s]+)/);\n    if (diffMatch) {\n      return `[diff] ${diffMatch[2] ?? diffMatch[1]}`;\n    }\n\n    const gitStatusMatch = trimmed.match(/^On branch ([^\\n]+)/);\n    if (gitStatusMatch) {\n      return `[git] status ${gitStatusMatch[1]}`;\n    }\n\n    if (/This Bash command contains multiple operations/i.test(trimmed)) {\n      return '[approval] multi-step command pending';\n    }\n\n    if (/This command requires approval/i.test(trimmed)) {\n      return '[approval] command awaiting approval';\n    }\n\n    if (/^Exit plan mode\\?/i.test(trimmed)) {\n      return null;\n    }\n\n    if (trimmed.includes('node_modules')) {\n      return null;\n    }\n\n    if (trimmed.includes('total ') && trimmed.includes('drwx')) {\n      return null;\n    }\n\n    if (trimmed.includes('→')) {\n      return null;\n    }\n\n    if (trimmed.split('\\n').length > 2) {\n      return null;\n    }\n\n    const normalized = trimmed.replace(/\\s+/g, ' ');\n    const maxLen = 120;\n    if (!normalized) {\n      return null;\n    }\n    const preview = normalized.length > maxLen ? `${normalized.slice(0, maxLen)}…` : normalized;\n    return `[user] ${preview}`;\n  }\n\n\n  private truncateMultiline(text: string, max = 160): string {\n    if (!text) {\n      return '';\n    }\n    const compact = text.replace(/\\s+/g, ' ').trim();\n    return compact.length > max ? `${compact.slice(0, max)}…` : compact;\n  }\n\n  private formatToolCallEvent(event: Extract<AgentEvent, { type: 'tool_call' }>): string | null {\n    // File operations to track\n    const fileOps = ['read_file', 'write', 'search_replace', 'delete_file', 'glob_file_search', 'file_search', 'list_dir', 'edit_notebook'];\n    // Terminal commands to track\n    const terminalOps = ['run_terminal_cmd', 'bash', 'shell'];\n\n    if (fileOps.includes(event.toolName)) {\n      // Extract file path from args\n      const path = event.args?.target_file || event.args?.file_path || event.args?.target_notebook || event.args?.target_directory || '';\n      return `[tool] ${event.toolName}${path ? `: ${path}` : ''}`;\n    } else if (terminalOps.includes(event.toolName)) {\n      // Extract command from args\n      const cmd = event.args?.command || '';\n      const truncated = cmd.length > 80 ? `${cmd.slice(0, 80)}…` : cmd;\n      return `[cmd] ${truncated}`;\n    }\n\n    // Skip other tools from persistence\n    return null;\n  }\n\n  private formatToolResultEvent(event: Extract<AgentEvent, { type: 'tool_result' }>): string | null {\n    // We don't need to log tool results separately - tool calls are sufficient\n    // This keeps the log concise\n    return null;\n  }\n}\n"],"names":[],"mappings":"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"}