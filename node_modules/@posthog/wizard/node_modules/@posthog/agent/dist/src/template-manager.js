import { existsSync, promises } from 'fs';
import { dirname, join } from 'path';
import { fileURLToPath } from 'url';

class TemplateManager {
    templatesDir;
    constructor() {
        const __filename = fileURLToPath(import.meta.url);
        const __dirname = dirname(__filename);
        const candidateDirs = [
            join(__dirname, 'templates'),
            join(__dirname, '..', 'templates'),
            join(__dirname, '..', '..', 'templates'),
            join(__dirname, '..', '..', 'src', 'templates')
        ];
        const resolvedDir = candidateDirs.find((dir) => existsSync(dir));
        this.templatesDir = resolvedDir ?? candidateDirs[0];
    }
    async loadTemplate(templateName) {
        try {
            const templatePath = join(this.templatesDir, templateName);
            return await promises.readFile(templatePath, 'utf8');
        }
        catch (error) {
            throw new Error(`Failed to load template ${templateName}: ${error}`);
        }
    }
    substituteVariables(template, variables) {
        let result = template;
        for (const [key, value] of Object.entries(variables)) {
            if (value !== undefined) {
                const placeholder = new RegExp(`{{${key}}}`, 'g');
                result = result.replace(placeholder, value);
            }
        }
        result = result.replace(/{{[^}]+}}/g, '[PLACEHOLDER]');
        return result;
    }
    async generatePlan(variables) {
        const template = await this.loadTemplate('plan-template.md');
        return this.substituteVariables(template, {
            ...variables,
            date: variables.date || new Date().toISOString().split('T')[0]
        });
    }
    async generateCustomFile(templateName, variables) {
        const template = await this.loadTemplate(templateName);
        return this.substituteVariables(template, {
            ...variables,
            date: variables.date || new Date().toISOString().split('T')[0]
        });
    }
    async createTaskStructure(taskId, taskTitle, options) {
        const files = [];
        const variables = {
            task_id: taskId,
            task_title: taskTitle,
            date: new Date().toISOString().split('T')[0]
        };
        // Generate plan file if requested
        if (options?.includePlan !== false) {
            const planContent = await this.generatePlan(variables);
            files.push({
                name: 'plan.md',
                content: planContent,
                type: 'plan'
            });
        }
        if (options?.additionalFiles) {
            for (const file of options.additionalFiles) {
                let content;
                if (file.template) {
                    content = await this.generateCustomFile(file.template, variables);
                }
                else if (file.content) {
                    content = this.substituteVariables(file.content, variables);
                }
                else {
                    content = `# ${file.name}\n\nPlaceholder content for ${file.name}`;
                }
                files.push({
                    name: file.name,
                    content,
                    type: file.name.includes('context') ? 'context' : 'reference'
                });
            }
        }
        return files;
    }
    generatePostHogReadme() {
        return `# PostHog Task Files

This directory contains task-related files generated by the PostHog Agent.

## Structure

Each task has its own subdirectory: \`.posthog/{task-id}/\`

### Common Files

- **plan.md** - Implementation plan generated during planning phase
- **Supporting files** - Any additional files added for task context
- **artifacts/** - Generated files, outputs, and temporary artifacts

### Usage

These files are:
- Version controlled alongside your code
- Used by the PostHog Agent for context
- Available for review in pull requests
- Organized by task ID for easy reference

### Gitignore

Customize \`.posthog/.gitignore\` to control which files are committed:
- Include plans and documentation by default
- Exclude temporary files and sensitive data
- Customize based on your team's workflow

---

*Generated by PostHog Agent*
`;
    }
}

export { TemplateManager };
//# sourceMappingURL=template-manager.js.map
