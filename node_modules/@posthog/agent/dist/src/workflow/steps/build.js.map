{"version":3,"file":"build.js","sources":["../../../../src/workflow/steps/build.ts"],"sourcesContent":["import { query } from '@anthropic-ai/claude-agent-sdk';\nimport { EXECUTION_SYSTEM_PROMPT } from '../../agents/execution.js';\nimport { PermissionMode } from '../../types.js';\nimport type { WorkflowStepRunner } from '../types.js';\nimport { finalizeStepGitActions } from '../utils.js';\nimport { TodoManager } from '../../todo-manager.js';\n\nexport const buildStep: WorkflowStepRunner = async ({ step, context }) => {\n    const {\n        task,\n        cwd,\n        options,\n        logger,\n        promptBuilder,\n        adapter,\n        mcpServers,\n        gitManager,\n        emitEvent,\n    } = context;\n\n    const stepLogger = logger.child('BuildStep');\n\n    const latestRun = task.latest_run;\n    const prExists =\n        latestRun?.output && typeof latestRun.output === 'object'\n            ? (latestRun.output as any).pr_url\n            : null;\n\n    if (prExists) {\n        stepLogger.info('PR already exists, skipping build phase', { taskId: task.id });\n        return { status: 'skipped' };\n    }\n\n    stepLogger.info('Starting build phase', { taskId: task.id });\n    emitEvent(adapter.createStatusEvent('phase_start', { phase: 'build' }));\n\n    const executionPrompt = await promptBuilder.buildExecutionPrompt(task, cwd);\n    const fullPrompt = `${EXECUTION_SYSTEM_PROMPT}\\n\\n${executionPrompt}`;\n\n    const configuredPermissionMode =\n        options.permissionMode ??\n        (typeof step.permissionMode === 'string'\n            ? (step.permissionMode as PermissionMode)\n            : step.permissionMode) ??\n        PermissionMode.ACCEPT_EDITS;\n\n    const baseOptions: Record<string, any> = {\n        model: step.model,\n        cwd,\n        permissionMode: configuredPermissionMode,\n        settingSources: ['local'],\n        mcpServers,\n        // Allow all tools for build phase - full read/write access needed for implementation\n        allowedTools: [\n            'Task',\n            'Bash',\n            'BashOutput',\n            'KillBash',\n            'Edit',\n            'Read',\n            'Write',\n            'Glob',\n            'Grep',\n            'NotebookEdit',\n            'WebFetch',\n            'WebSearch',\n            'ListMcpResources',\n            'ReadMcpResource',\n            'TodoWrite',\n        ],\n    };\n\n    // Add fine-grained permission hook if provided\n    if (options.canUseTool) {\n        baseOptions.canUseTool = options.canUseTool;\n    }\n\n    const response = query({\n        prompt: fullPrompt,\n        options: { ...baseOptions, ...(options.queryOverrides || {}) },\n    });\n\n    // Track commits made during Claude Code execution\n    const commitTracker = await gitManager.trackCommitsDuring();\n\n    // Track todos from TodoWrite tool calls\n    const todoManager = new TodoManager(context.fileManager, stepLogger);\n\n    for await (const message of response) {\n        emitEvent(adapter.createRawSDKEvent(message));\n        const transformedEvents = adapter.transform(message);\n        for (const event of transformedEvents) {\n            emitEvent(event);\n        }\n\n        const todoList = await todoManager.checkAndPersistFromMessage(message, task.id);\n        if (todoList) {\n            emitEvent(adapter.createArtifactEvent('todos', todoList));\n        }\n    }\n\n    // Finalize: commit any remaining changes and optionally push\n    const { commitCreated, pushedBranch } = await commitTracker.finalize({\n        commitMessage: `Implementation for ${task.title}`,\n        push: step.push,\n    });\n\n    context.stepResults[step.id] = { commitCreated };\n\n    if (!commitCreated) {\n        stepLogger.warn('No changes to commit in build phase', { taskId: task.id });\n    } else {\n        stepLogger.info('Build commits finalized', {\n            taskId: task.id,\n            pushedBranch\n        });\n    }\n\n    emitEvent(adapter.createStatusEvent('phase_complete', { phase: 'build' }));\n    return { status: 'completed' };\n};\n"],"names":[],"mappings":"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"}