{"version":3,"file":"finalize.js","sources":["../../../../src/workflow/steps/finalize.ts"],"sourcesContent":["import type { LocalArtifact } from '../../file-manager.js';\nimport type { Task, TaskRunArtifact } from '../../types.js';\nimport type { WorkflowStepRunner } from '../types.js';\nimport { finalizeStepGitActions } from '../utils.js';\n\nconst MAX_SNIPPET_LENGTH = 1200;\n\nexport const finalizeStep: WorkflowStepRunner = async ({ step, context }) => {\n    const {\n        task,\n        logger,\n        fileManager,\n        gitManager,\n        posthogAPI,\n        progressReporter,\n    } = context;\n\n    const stepLogger = logger.child('FinalizeStep');\n    const artifacts = await fileManager.collectTaskArtifacts(task.id);\n    let uploadedArtifacts: TaskRunArtifact[] | undefined;\n\n    if (artifacts.length && posthogAPI && progressReporter.runId) {\n        try {\n            const payload = artifacts.map((artifact) => ({\n                name: artifact.name,\n                type: artifact.type,\n                content: artifact.content,\n                content_type: artifact.contentType,\n            }));\n            uploadedArtifacts = await posthogAPI.uploadTaskArtifacts(task.id, progressReporter.runId, payload);\n            stepLogger.info('Uploaded task artifacts to PostHog', {\n                taskId: task.id,\n                uploadedCount: uploadedArtifacts.length,\n            });\n        } catch (error) {\n            stepLogger.warn('Failed to upload task artifacts', {\n                taskId: task.id,\n                error: error instanceof Error ? error.message : String(error),\n            });\n        }\n    } else {\n        stepLogger.debug('Skipping artifact upload', {\n            hasArtifacts: artifacts.length > 0,\n            hasPostHogApi: Boolean(posthogAPI),\n            runId: progressReporter.runId,\n        });\n    }\n\n    const prBody = buildPullRequestBody(task, artifacts, uploadedArtifacts);\n    await fileManager.cleanupTaskDirectory(task.id);\n    await gitManager.addAllPostHogFiles();\n    \n    // Commit the deletion of artifacts\n    await finalizeStepGitActions(context, step, {\n        commitMessage: `Cleanup task artifacts for ${task.title}`,\n        allowEmptyCommit: true\n    });\n\n    context.stepResults[step.id] = {\n        prBody,\n        uploadedArtifacts,\n        artifactCount: artifacts.length,\n    };\n\n    return { status: 'completed' };\n};\n\nfunction buildPullRequestBody(task: Task, artifacts: LocalArtifact[], uploaded?: TaskRunArtifact[]): string {\n    const lines: string[] = [];\n    const taskSlug = (task as any).slug || task.id;\n\n    lines.push('## Task context');\n    lines.push(`- **Task**: ${taskSlug}`);\n    lines.push(`- **Title**: ${task.title}`);\n    lines.push(`- **Origin**: ${task.origin_product}`);\n\n    if (task.description) {\n        lines.push('');\n        lines.push('> ' + task.description.trim().split('\\n').join('\\n> '));\n    }\n\n    const usedFiles = new Set<string>();\n\n    const contextArtifact = artifacts.find((artifact) => artifact.name === 'context.md');\n    if (contextArtifact) {\n        lines.push('');\n        lines.push('### Task prompt');\n        lines.push(contextArtifact.content);\n        usedFiles.add(contextArtifact.name);\n    }\n\n    const researchArtifact = artifacts.find((artifact) => artifact.name === 'research.json');\n    if (researchArtifact) {\n        usedFiles.add(researchArtifact.name);\n        const researchSection = formatResearchSection(researchArtifact.content);\n        if (researchSection) {\n            lines.push('');\n            lines.push(researchSection);\n        }\n    }\n\n    const planArtifact = artifacts.find((artifact) => artifact.name === 'plan.md');\n    if (planArtifact) {\n        lines.push('');\n        lines.push('### Implementation plan');\n        lines.push(planArtifact.content);\n        usedFiles.add(planArtifact.name);\n    }\n\n    const todoArtifact = artifacts.find((artifact) => artifact.name === 'todos.json');\n    if (todoArtifact) {\n        const summary = summarizeTodos(todoArtifact.content);\n        if (summary) {\n            lines.push('');\n            lines.push('### Todo list');\n            lines.push(summary);\n        }\n        usedFiles.add(todoArtifact.name);\n    }\n\n    const remainingArtifacts = artifacts.filter((artifact) => !usedFiles.has(artifact.name));\n    if (remainingArtifacts.length) {\n        lines.push('');\n        lines.push('### Additional artifacts');\n        for (const artifact of remainingArtifacts) {\n            lines.push(`#### ${artifact.name}`);\n            lines.push(renderCodeFence(artifact.content));\n        }\n    }\n\n    const artifactList = uploaded ?? artifacts.map((artifact) => ({\n        name: artifact.name,\n        type: artifact.type,\n    }));\n\n    if (artifactList.length) {\n        lines.push('');\n        lines.push('### Uploaded artifacts');\n        for (const artifact of artifactList) {\n            const rawStoragePath = 'storage_path' in artifact ? (artifact as any).storage_path : undefined;\n            const storagePath = typeof rawStoragePath === 'string' ? rawStoragePath : undefined;\n            const storage = storagePath && storagePath.trim().length > 0 ? ` – \\`${storagePath.trim()}\\`` : '';\n            lines.push(`- ${artifact.name} (${artifact.type})${storage}`);\n        }\n    }\n\n    return lines.join('\\n\\n');\n}\n\nfunction renderCodeFence(content: string): string {\n    const snippet = truncate(content, MAX_SNIPPET_LENGTH);\n    return ['```', snippet, '```'].join('\\n');\n}\n\nfunction truncate(value: string, maxLength: number): string {\n    if (value.length <= maxLength) {\n        return value;\n    }\n    return `${value.slice(0, maxLength)}\\n…`;\n}\n\nfunction formatResearchSection(content: string): string | null {\n    try {\n        const parsed = JSON.parse(content);\n        const sections: string[] = [];\n\n        if (parsed.context) {\n            sections.push('### Research summary');\n            sections.push(parsed.context);\n        }\n\n        if (parsed.questions && parsed.questions.length) {\n            sections.push('');\n            sections.push('### Questions needing answers');\n            for (const question of parsed.questions) {\n                sections.push(`- ${question.question ?? question}`);\n            }\n        }\n\n        if (parsed.answers && parsed.answers.length) {\n            sections.push('');\n            sections.push('### Answers provided');\n            for (const answer of parsed.answers) {\n                const questionId = answer.questionId ? ` (Q: ${answer.questionId})` : '';\n                sections.push(`- ${answer.selectedOption || answer.customInput || 'answer'}${questionId}`);\n            }\n        }\n\n        return sections.length ? sections.join('\\n') : null;\n    } catch {\n        return null;\n    }\n}\n\nfunction summarizeTodos(content: string): string | null {\n    try {\n        const data = JSON.parse(content);\n        const total = data?.metadata?.total ?? data?.items?.length;\n        const completed = data?.metadata?.completed ?? data?.items?.filter((item: any) => item.status === 'completed').length;\n\n        const lines = [\n            `Progress: ${completed}/${total} completed`,\n        ];\n\n        if (data?.items?.length) {\n            for (const item of data.items) {\n                lines.push(`- [${item.status}] ${item.content}`);\n            }\n        }\n\n        return lines.join('\\n');\n    } catch {\n        return null;\n    }\n}\n\n"],"names":[],"mappings":"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"}