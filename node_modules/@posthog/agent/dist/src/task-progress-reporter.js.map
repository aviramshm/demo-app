{"version":3,"file":"task-progress-reporter.js","sources":["../../src/task-progress-reporter.ts"],"sourcesContent":["import type { Logger } from './utils/logger.js';\nimport type { PostHogAPIClient, TaskRunUpdate } from './posthog-api.js';\nimport type { AgentEvent, TaskRun, LogEntry } from './types.js';\n\ninterface ProgressMetadata {\n  totalSteps?: number;\n}\n\n/**\n * Persists task execution progress to PostHog so clients can poll for updates.\n *\n * The reporter is intentionally best-effort â€“ failures are logged but never\n * allowed to break the agent execution flow.\n */\nexport class TaskProgressReporter {\n  private posthogAPI?: PostHogAPIClient;\n  private logger: Logger;\n  private taskRun?: TaskRun;\n  private taskId?: string;\n  private outputLog: string[] = [];\n  private totalSteps?: number;\n  private lastLogEntry?: string;\n  private tokenBuffer: string = '';\n  private tokenCount: number = 0;\n  private tokenFlushTimer?: NodeJS.Timeout;\n  private readonly TOKEN_BATCH_SIZE = 100;\n  private readonly TOKEN_FLUSH_INTERVAL_MS = 1000;\n  private logWriteQueue: Promise<void> = Promise.resolve();\n  private readonly LOG_APPEND_MAX_RETRIES = 3;\n  private readonly LOG_APPEND_RETRY_BASE_DELAY_MS = 200;\n\n  constructor(posthogAPI: PostHogAPIClient | undefined, logger: Logger) {\n    this.posthogAPI = posthogAPI;\n    this.logger = logger.child('TaskProgressReporter');\n  }\n\n  get runId(): string | undefined {\n    return this.taskRun?.id;\n  }\n\n  async start(taskId: string, metadata: ProgressMetadata = {}): Promise<void> {\n    if (!this.posthogAPI) {\n      return;\n    }\n\n    this.taskId = taskId;\n    this.totalSteps = metadata.totalSteps;\n\n    try {\n      const run = await this.posthogAPI.createTaskRun(taskId, {\n        status: 'started',\n      });\n      this.taskRun = run;\n      this.outputLog = [];\n      this.logger.debug('Created task run', { taskId, runId: run.id });\n    } catch (error) {\n      this.logger.warn('Failed to create task run', { taskId, error: (error as Error).message });\n    }\n  }\n\n  async complete(): Promise<void> {\n    await this.flushTokens(); // Flush any remaining tokens before completion\n    try {\n      await this.logWriteQueue;\n    } catch (error) {\n      this.logger.debug('Pending logs failed to write during completion', { error });\n    }\n\n    if (this.tokenFlushTimer) {\n      clearTimeout(this.tokenFlushTimer);\n      this.tokenFlushTimer = undefined;\n    }\n    await this.update({ status: 'completed' }, 'Task execution completed');\n  }\n\n  async fail(error: Error | string): Promise<void> {\n    try {\n      await this.logWriteQueue;\n    } catch (logError) {\n      this.logger.debug('Pending logs failed to write during fail', { error: logError });\n    }\n\n    const message = typeof error === 'string' ? error : error.message;\n    await this.update({ status: 'failed', error_message: message }, `Task execution failed: ${message}`);\n  }\n\n  async appendLog(line: string): Promise<void> {\n    await this.update({}, line);\n  }\n\n  private async flushTokens(): Promise<void> {\n    if (!this.tokenBuffer || this.tokenCount === 0) {\n      return;\n    }\n\n    const buffer = this.tokenBuffer;\n    this.tokenBuffer = '';\n    this.tokenCount = 0;\n\n    await this.appendLogEntry({\n      type: 'token',\n      message: buffer,\n    });\n  }\n\n  private scheduleTokenFlush(): void {\n    if (this.tokenFlushTimer) {\n      return;\n    }\n\n    this.tokenFlushTimer = setTimeout(() => {\n      this.tokenFlushTimer = undefined;\n      this.flushTokens().catch((err) => {\n        this.logger.warn('Failed to flush tokens', { error: err });\n      });\n    }, this.TOKEN_FLUSH_INTERVAL_MS);\n  }\n\n  private appendLogEntry(entry: LogEntry): Promise<void> {\n    if (!this.posthogAPI || !this.runId || !this.taskId) {\n      return Promise.resolve();\n    }\n\n    const taskId = this.taskId;\n    const runId = this.runId;\n\n    this.logWriteQueue = this.logWriteQueue\n      .catch((error) => {\n        this.logger.debug('Previous log append failed', {\n          taskId,\n          runId,\n          error: error instanceof Error ? error.message : String(error),\n        });\n      })\n      .then(() => this.writeLogEntry(taskId, runId, entry));\n\n    return this.logWriteQueue;\n  }\n\n  private async writeLogEntry(\n    taskId: string,\n    runId: string,\n    entry: LogEntry,\n  ): Promise<void> {\n    if (!this.posthogAPI) {\n      return;\n    }\n\n    for (let attempt = 1; attempt <= this.LOG_APPEND_MAX_RETRIES; attempt++) {\n      try {\n        await this.posthogAPI.appendTaskRunLog(taskId, runId, [entry]);\n        return;\n      } catch (error) {\n        this.logger.warn('Failed to append log entry', {\n          taskId,\n          runId,\n          attempt,\n          maxAttempts: this.LOG_APPEND_MAX_RETRIES,\n          error: (error as Error).message,\n        });\n\n        if (attempt === this.LOG_APPEND_MAX_RETRIES) {\n          return;\n        }\n\n        const delayMs =\n          this.LOG_APPEND_RETRY_BASE_DELAY_MS * Math.pow(2, attempt - 1);\n        await new Promise((resolve) => setTimeout(resolve, delayMs));\n      }\n    }\n  }\n\n  async recordEvent(event: AgentEvent): Promise<void> {\n    if (!this.posthogAPI || !this.runId || !this.taskId) {\n      return;\n    }\n\n    switch (event.type) {\n      case 'token': {\n        // Batch tokens for efficiency\n        this.tokenBuffer += event.content;\n        this.tokenCount++;\n\n        if (this.tokenCount >= this.TOKEN_BATCH_SIZE) {\n          await this.flushTokens();\n          if (this.tokenFlushTimer) {\n            clearTimeout(this.tokenFlushTimer);\n            this.tokenFlushTimer = undefined;\n          }\n        } else {\n          this.scheduleTokenFlush();\n        }\n        return;\n      }\n\n      case 'content_block_start': {\n        await this.appendLogEntry({\n          type: 'content_block_start',\n          message: JSON.stringify({\n            index: event.index,\n            contentType: event.contentType,\n            toolName: event.toolName,\n            toolId: event.toolId,\n            ts: event.ts,\n          }),\n        });\n        return;\n      }\n\n      case 'content_block_stop': {\n        await this.appendLogEntry({\n          type: 'content_block_stop',\n          message: JSON.stringify({\n            index: event.index,\n            ts: event.ts,\n          }),\n        });\n        return;\n      }\n\n      case 'message_start': {\n        await this.appendLogEntry({\n          type: 'message_start',\n          message: JSON.stringify({\n            messageId: event.messageId,\n            model: event.model,\n            ts: event.ts,\n          }),\n        });\n        return;\n      }\n\n      case 'message_delta': {\n        await this.appendLogEntry({\n          type: 'message_delta',\n          message: JSON.stringify({\n            stopReason: event.stopReason,\n            stopSequence: event.stopSequence,\n            usage: event.usage,\n            ts: event.ts,\n          }),\n        });\n        return;\n      }\n\n      case 'message_stop': {\n        await this.appendLogEntry({\n          type: 'message_stop',\n          message: JSON.stringify({ ts: event.ts }),\n        });\n        return;\n      }\n\n      case 'status': {\n        await this.appendLogEntry({\n          type: 'status',\n          message: JSON.stringify({\n            phase: event.phase,\n            kind: event.kind,\n            branch: event.branch,\n            prUrl: event.prUrl,\n            taskId: event.taskId,\n            messageId: event.messageId,\n            model: event.model,\n            ts: event.ts,\n          }),\n        });\n        return;\n      }\n\n      case 'artifact': {\n        await this.appendLogEntry({\n          type: 'artifact',\n          message: JSON.stringify({\n            kind: event.kind,\n            content: event.content,\n            ts: event.ts,\n          }),\n        });\n        return;\n      }\n\n      case 'init': {\n        await this.appendLogEntry({\n          type: 'init',\n          message: JSON.stringify({\n            model: event.model,\n            tools: event.tools,\n            permissionMode: event.permissionMode,\n            cwd: event.cwd,\n            apiKeySource: event.apiKeySource,\n            ts: event.ts,\n          }),\n        });\n        return;\n      }\n\n      case 'metric': {\n        await this.appendLogEntry({\n          type: 'metric',\n          message: JSON.stringify({\n            key: event.key,\n            value: event.value,\n            unit: event.unit,\n            ts: event.ts,\n          }),\n        });\n        return;\n      }\n\n      case 'compact_boundary': {\n        await this.appendLogEntry({\n          type: 'compact_boundary',\n          message: JSON.stringify({\n            trigger: event.trigger,\n            preTokens: event.preTokens,\n            ts: event.ts,\n          }),\n        });\n        return;\n      }\n\n      case 'tool_call': {\n        await this.appendLogEntry({\n          type: 'tool_call',\n          message: JSON.stringify({\n            toolName: event.toolName,\n            callId: event.callId,\n            args: event.args,\n            parentToolUseId: event.parentToolUseId,\n            ts: event.ts,\n          }),\n        });\n        return;\n      }\n\n      case 'tool_result': {\n        await this.appendLogEntry({\n          type: 'tool_result',\n          message: JSON.stringify({\n            toolName: event.toolName,\n            callId: event.callId,\n            result: event.result,\n            isError: event.isError,\n            parentToolUseId: event.parentToolUseId,\n            ts: event.ts,\n          }),\n        });\n        return;\n      }\n\n      case 'error': {\n        await this.appendLogEntry({\n          type: 'error',\n          message: JSON.stringify({\n            message: event.message,\n            errorType: event.errorType,\n            context: event.context,\n            ts: event.ts,\n          }),\n        });\n        return;\n      }\n\n      case 'done': {\n        await this.appendLogEntry({\n          type: 'done',\n          message: JSON.stringify({\n            result: event.result,\n            durationMs: event.durationMs,\n            durationApiMs: event.durationApiMs,\n            numTurns: event.numTurns,\n            totalCostUsd: event.totalCostUsd,\n            usage: event.usage,\n            modelUsage: event.modelUsage,\n            permissionDenials: event.permissionDenials,\n            ts: event.ts,\n          }),\n        });\n        return;\n      }\n\n      case 'user_message': {\n        await this.appendLogEntry({\n          type: 'user_message',\n          message: JSON.stringify({\n            content: event.content,\n            isSynthetic: event.isSynthetic,\n            ts: event.ts,\n          }),\n        });\n        return;\n      }\n\n      case 'raw_sdk_event': {\n        // Skip raw SDK events - too verbose for persistence\n        return;\n      }\n\n      default:\n        // For any unfamiliar event types, log them as-is\n        this.logger.debug('Unknown event type', { type: (event as any).type });\n        return;\n    }\n  }\n\n  private async update(update: TaskRunUpdate, logLine?: string): Promise<void> {\n    if (!this.posthogAPI || !this.runId || !this.taskId) {\n      return;\n    }\n\n    // If there's a log line, append it separately using the append_log endpoint\n    if (logLine && logLine !== this.lastLogEntry) {\n      try {\n        await this.posthogAPI.appendTaskRunLog(this.taskId, this.runId, [\n          { type: 'info', message: logLine }\n        ]);\n        this.lastLogEntry = logLine;\n      } catch (error) {\n        this.logger.warn('Failed to append log entry', {\n          taskId: this.taskId,\n          runId: this.runId,\n          error: (error as Error).message,\n        });\n      }\n    }\n\n    // Update other fields if provided\n    if (Object.keys(update).length > 0) {\n      try {\n        const run = await this.posthogAPI.updateTaskRun(this.taskId, this.runId, update);\n        this.taskRun = run;\n      } catch (error) {\n        this.logger.warn('Failed to update task run', {\n          taskId: this.taskId,\n          runId: this.runId,\n          error: (error as Error).message,\n        });\n      }\n    }\n  }\n\n}\n"],"names":[],"mappings":"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"}