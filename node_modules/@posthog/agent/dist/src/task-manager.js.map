{"version":3,"file":"task-manager.js","sources":["../../src/task-manager.ts"],"sourcesContent":["import { randomBytes } from 'crypto';\n\nexport interface TaskExecutionState {\n  taskId: string;\n  status: 'running' | 'completed' | 'failed' | 'canceled' | 'timeout';\n  mode: 'plan_only' | 'plan_and_build' | 'build_only';\n  result?: any;\n  startedAt: number;\n  completedAt?: number;\n  abortController?: AbortController;\n}\n\nexport class TaskManager {\n  private executionStates = new Map<string, TaskExecutionState>();\n  private defaultTimeout = 10 * 60 * 1000; // 10 minutes\n\n  generateExecutionId(): string {\n    return randomBytes(16).toString('hex');\n  }\n\n  startExecution(\n    taskId: string, \n    mode: 'plan_only' | 'plan_and_build' | 'build_only',\n    executionId: string = this.generateExecutionId()\n  ): TaskExecutionState {\n    const executionState: TaskExecutionState = {\n      taskId,\n      status: 'running',\n      mode,\n      startedAt: Date.now(),\n      abortController: new AbortController(),\n    };\n\n    this.executionStates.set(executionId, executionState);\n    this.scheduleTimeout(executionId);\n    \n    return executionState;\n  }\n\n  async waitForCompletion(executionId: string): Promise<any> {\n    const execution = this.executionStates.get(executionId);\n    if (!execution) {\n      throw new Error(`Execution ${executionId} not found`);\n    }\n\n    if (execution.result && execution.status === 'completed') {\n      return execution.result;\n    }\n\n    return new Promise((resolve, reject) => {\n      const checkInterval = setInterval(() => {\n        const currentExecution = this.executionStates.get(executionId);\n        if (!currentExecution) {\n          clearInterval(checkInterval);\n          reject(new Error(`Execution ${executionId} disappeared`));\n          return;\n        }\n\n        if (currentExecution.status === 'completed' && currentExecution.result) {\n          clearInterval(checkInterval);\n          resolve(currentExecution.result);\n        } else if (\n          currentExecution.status === 'failed' || \n          currentExecution.status === 'canceled' || \n          currentExecution.status === 'timeout'\n        ) {\n          clearInterval(checkInterval);\n          reject(new Error(`Execution ${executionId} ${currentExecution.status}`));\n        }\n      }, 100);\n    });\n  }\n\n  completeExecution(executionId: string, result: any): void {\n    const execution = this.executionStates.get(executionId);\n    if (!execution) {\n      throw new Error(`Execution ${executionId} not found`);\n    }\n\n    execution.status = 'completed';\n    execution.result = result;\n    execution.completedAt = Date.now();\n  }\n\n  failExecution(executionId: string, error: Error): void {\n    const execution = this.executionStates.get(executionId);\n    if (!execution) {\n      throw new Error(`Execution ${executionId} not found`);\n    }\n\n    execution.status = 'failed';\n    execution.completedAt = Date.now();\n    execution.result = {\n      error: error.message,\n      status: 'failed',\n    };\n  }\n\n  cancelExecution(executionId: string): void {\n    const execution = this.executionStates.get(executionId);\n    if (!execution) {\n      throw new Error(`Execution ${executionId} not found`);\n    }\n\n    execution.status = 'canceled';\n    execution.completedAt = Date.now();\n    execution.abortController?.abort();\n    \n    if (!execution.result) {\n      execution.result = {\n        status: 'canceled',\n        message: 'Execution was canceled',\n      };\n    }\n  }\n\n  getExecution(executionId: string): TaskExecutionState | undefined {\n    return this.executionStates.get(executionId);\n  }\n\n  getAbortSignal(executionId: string): AbortSignal | undefined {\n    return this.executionStates.get(executionId)?.abortController?.signal;\n  }\n\n  getAbortController(executionId: string): AbortController | undefined {\n    return this.executionStates.get(executionId)?.abortController;\n  }\n\n  private scheduleTimeout(executionId: string, timeout: number = this.defaultTimeout): void {\n    setTimeout(() => {\n      const execution = this.executionStates.get(executionId);\n      if (execution && execution.status === 'running') {\n        execution.status = 'timeout';\n        execution.completedAt = Date.now();\n        execution.abortController?.abort();\n        \n        if (!execution.result) {\n          execution.result = {\n            status: 'timeout',\n            message: 'Execution timed out',\n          };\n        }\n      }\n    }, timeout);\n  }\n\n  cleanup(olderThan: number = 60 * 60 * 1000): void {\n    const cutoff = Date.now() - olderThan;\n    for (const [executionId, execution] of this.executionStates) {\n      if (execution.completedAt && execution.completedAt < cutoff) {\n        this.executionStates.delete(executionId);\n      }\n    }\n  }\n}"],"names":[],"mappings":";;MAYa,WAAW,CAAA;AACd,IAAA,eAAe,GAAG,IAAI,GAAG,EAA8B;IACvD,cAAc,GAAG,EAAE,GAAG,EAAE,GAAG,IAAI,CAAC;IAExC,mBAAmB,GAAA;QACjB,OAAO,WAAW,CAAC,EAAE,CAAC,CAAC,QAAQ,CAAC,KAAK,CAAC;IACxC;IAEA,cAAc,CACZ,MAAc,EACd,IAAmD,EACnD,WAAA,GAAsB,IAAI,CAAC,mBAAmB,EAAE,EAAA;AAEhD,QAAA,MAAM,cAAc,GAAuB;YACzC,MAAM;AACN,YAAA,MAAM,EAAE,SAAS;YACjB,IAAI;AACJ,YAAA,SAAS,EAAE,IAAI,CAAC,GAAG,EAAE;YACrB,eAAe,EAAE,IAAI,eAAe,EAAE;SACvC;QAED,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,WAAW,EAAE,cAAc,CAAC;AACrD,QAAA,IAAI,CAAC,eAAe,CAAC,WAAW,CAAC;AAEjC,QAAA,OAAO,cAAc;IACvB;IAEA,MAAM,iBAAiB,CAAC,WAAmB,EAAA;QACzC,MAAM,SAAS,GAAG,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,WAAW,CAAC;QACvD,IAAI,CAAC,SAAS,EAAE;AACd,YAAA,MAAM,IAAI,KAAK,CAAC,aAAa,WAAW,CAAA,UAAA,CAAY,CAAC;QACvD;QAEA,IAAI,SAAS,CAAC,MAAM,IAAI,SAAS,CAAC,MAAM,KAAK,WAAW,EAAE;YACxD,OAAO,SAAS,CAAC,MAAM;QACzB;QAEA,OAAO,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,MAAM,KAAI;AACrC,YAAA,MAAM,aAAa,GAAG,WAAW,CAAC,MAAK;gBACrC,MAAM,gBAAgB,GAAG,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,WAAW,CAAC;gBAC9D,IAAI,CAAC,gBAAgB,EAAE;oBACrB,aAAa,CAAC,aAAa,CAAC;oBAC5B,MAAM,CAAC,IAAI,KAAK,CAAC,aAAa,WAAW,CAAA,YAAA,CAAc,CAAC,CAAC;oBACzD;gBACF;gBAEA,IAAI,gBAAgB,CAAC,MAAM,KAAK,WAAW,IAAI,gBAAgB,CAAC,MAAM,EAAE;oBACtE,aAAa,CAAC,aAAa,CAAC;AAC5B,oBAAA,OAAO,CAAC,gBAAgB,CAAC,MAAM,CAAC;gBAClC;AAAO,qBAAA,IACL,gBAAgB,CAAC,MAAM,KAAK,QAAQ;oBACpC,gBAAgB,CAAC,MAAM,KAAK,UAAU;AACtC,oBAAA,gBAAgB,CAAC,MAAM,KAAK,SAAS,EACrC;oBACA,aAAa,CAAC,aAAa,CAAC;AAC5B,oBAAA,MAAM,CAAC,IAAI,KAAK,CAAC,CAAA,UAAA,EAAa,WAAW,CAAA,CAAA,EAAI,gBAAgB,CAAC,MAAM,CAAA,CAAE,CAAC,CAAC;gBAC1E;YACF,CAAC,EAAE,GAAG,CAAC;AACT,QAAA,CAAC,CAAC;IACJ;IAEA,iBAAiB,CAAC,WAAmB,EAAE,MAAW,EAAA;QAChD,MAAM,SAAS,GAAG,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,WAAW,CAAC;QACvD,IAAI,CAAC,SAAS,EAAE;AACd,YAAA,MAAM,IAAI,KAAK,CAAC,aAAa,WAAW,CAAA,UAAA,CAAY,CAAC;QACvD;AAEA,QAAA,SAAS,CAAC,MAAM,GAAG,WAAW;AAC9B,QAAA,SAAS,CAAC,MAAM,GAAG,MAAM;AACzB,QAAA,SAAS,CAAC,WAAW,GAAG,IAAI,CAAC,GAAG,EAAE;IACpC;IAEA,aAAa,CAAC,WAAmB,EAAE,KAAY,EAAA;QAC7C,MAAM,SAAS,GAAG,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,WAAW,CAAC;QACvD,IAAI,CAAC,SAAS,EAAE;AACd,YAAA,MAAM,IAAI,KAAK,CAAC,aAAa,WAAW,CAAA,UAAA,CAAY,CAAC;QACvD;AAEA,QAAA,SAAS,CAAC,MAAM,GAAG,QAAQ;AAC3B,QAAA,SAAS,CAAC,WAAW,GAAG,IAAI,CAAC,GAAG,EAAE;QAClC,SAAS,CAAC,MAAM,GAAG;YACjB,KAAK,EAAE,KAAK,CAAC,OAAO;AACpB,YAAA,MAAM,EAAE,QAAQ;SACjB;IACH;AAEA,IAAA,eAAe,CAAC,WAAmB,EAAA;QACjC,MAAM,SAAS,GAAG,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,WAAW,CAAC;QACvD,IAAI,CAAC,SAAS,EAAE;AACd,YAAA,MAAM,IAAI,KAAK,CAAC,aAAa,WAAW,CAAA,UAAA,CAAY,CAAC;QACvD;AAEA,QAAA,SAAS,CAAC,MAAM,GAAG,UAAU;AAC7B,QAAA,SAAS,CAAC,WAAW,GAAG,IAAI,CAAC,GAAG,EAAE;AAClC,QAAA,SAAS,CAAC,eAAe,EAAE,KAAK,EAAE;AAElC,QAAA,IAAI,CAAC,SAAS,CAAC,MAAM,EAAE;YACrB,SAAS,CAAC,MAAM,GAAG;AACjB,gBAAA,MAAM,EAAE,UAAU;AAClB,gBAAA,OAAO,EAAE,wBAAwB;aAClC;QACH;IACF;AAEA,IAAA,YAAY,CAAC,WAAmB,EAAA;QAC9B,OAAO,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,WAAW,CAAC;IAC9C;AAEA,IAAA,cAAc,CAAC,WAAmB,EAAA;AAChC,QAAA,OAAO,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,WAAW,CAAC,EAAE,eAAe,EAAE,MAAM;IACvE;AAEA,IAAA,kBAAkB,CAAC,WAAmB,EAAA;QACpC,OAAO,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,WAAW,CAAC,EAAE,eAAe;IAC/D;AAEQ,IAAA,eAAe,CAAC,WAAmB,EAAE,OAAA,GAAkB,IAAI,CAAC,cAAc,EAAA;QAChF,UAAU,CAAC,MAAK;YACd,MAAM,SAAS,GAAG,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,WAAW,CAAC;YACvD,IAAI,SAAS,IAAI,SAAS,CAAC,MAAM,KAAK,SAAS,EAAE;AAC/C,gBAAA,SAAS,CAAC,MAAM,GAAG,SAAS;AAC5B,gBAAA,SAAS,CAAC,WAAW,GAAG,IAAI,CAAC,GAAG,EAAE;AAClC,gBAAA,SAAS,CAAC,eAAe,EAAE,KAAK,EAAE;AAElC,gBAAA,IAAI,CAAC,SAAS,CAAC,MAAM,EAAE;oBACrB,SAAS,CAAC,MAAM,GAAG;AACjB,wBAAA,MAAM,EAAE,SAAS;AACjB,wBAAA,OAAO,EAAE,qBAAqB;qBAC/B;gBACH;YACF;QACF,CAAC,EAAE,OAAO,CAAC;IACb;AAEA,IAAA,OAAO,CAAC,SAAA,GAAoB,EAAE,GAAG,EAAE,GAAG,IAAI,EAAA;QACxC,MAAM,MAAM,GAAG,IAAI,CAAC,GAAG,EAAE,GAAG,SAAS;QACrC,KAAK,MAAM,CAAC,WAAW,EAAE,SAAS,CAAC,IAAI,IAAI,CAAC,eAAe,EAAE;YAC3D,IAAI,SAAS,CAAC,WAAW,IAAI,SAAS,CAAC,WAAW,GAAG,MAAM,EAAE;AAC3D,gBAAA,IAAI,CAAC,eAAe,CAAC,MAAM,CAAC,WAAW,CAAC;YAC1C;QACF;IACF;AACD;;;;"}