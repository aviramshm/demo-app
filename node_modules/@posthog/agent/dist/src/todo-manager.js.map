{"version":3,"file":"todo-manager.js","sources":["../../src/todo-manager.ts"],"sourcesContent":["import type { PostHogFileManager } from './file-manager.js';\nimport { Logger } from './utils/logger.js';\n\nexport interface TodoItem {\n  content: string;\n  status: 'pending' | 'in_progress' | 'completed';\n  activeForm: string;\n}\n\nexport interface TodoList {\n  items: TodoItem[];\n  metadata: {\n    total: number;\n    pending: number;\n    in_progress: number;\n    completed: number;\n    last_updated: string;\n  };\n}\n\nexport class TodoManager {\n  private fileManager: PostHogFileManager;\n  private logger: Logger;\n\n  constructor(fileManager: PostHogFileManager, logger?: Logger) {\n    this.fileManager = fileManager;\n    this.logger = logger || new Logger({ debug: false, prefix: '[TodoManager]' });\n  }\n\n  async readTodos(taskId: string): Promise<TodoList | null> {\n    try {\n      const content = await this.fileManager.readTaskFile(taskId, 'todos.json');\n      if (!content) {\n        return null;\n      }\n\n      const parsed = JSON.parse(content) as TodoList;\n      this.logger.debug('Loaded todos', {\n        taskId,\n        total: parsed.metadata.total,\n        pending: parsed.metadata.pending,\n        in_progress: parsed.metadata.in_progress,\n        completed: parsed.metadata.completed,\n      });\n\n      return parsed;\n    } catch (error) {\n      this.logger.debug('Failed to read todos.json', {\n        taskId,\n        error: error instanceof Error ? error.message : String(error),\n      });\n      return null;\n    }\n  }\n\n  async writeTodos(taskId: string, todos: TodoList): Promise<void> {\n    this.logger.debug('Writing todos', {\n      taskId,\n      total: todos.metadata.total,\n      pending: todos.metadata.pending,\n      in_progress: todos.metadata.in_progress,\n      completed: todos.metadata.completed,\n    });\n\n    await this.fileManager.writeTaskFile(taskId, {\n      name: 'todos.json',\n      content: JSON.stringify(todos, null, 2),\n      type: 'artifact',\n    });\n\n    this.logger.info('Todos saved', {\n      taskId,\n      total: todos.metadata.total,\n      completed: todos.metadata.completed,\n    });\n  }\n\n  parseTodoWriteInput(toolInput: any): TodoList {\n    const items: TodoItem[] = [];\n\n    if (toolInput.todos && Array.isArray(toolInput.todos)) {\n      for (const todo of toolInput.todos) {\n        items.push({\n          content: todo.content || '',\n          status: todo.status || 'pending',\n          activeForm: todo.activeForm || todo.content || '',\n        });\n      }\n    }\n\n    const metadata = this.calculateMetadata(items);\n\n    return { items, metadata };\n  }\n\n  private calculateMetadata(items: TodoItem[]): TodoList['metadata'] {\n    const total = items.length;\n    const pending = items.filter((t) => t.status === 'pending').length;\n    const in_progress = items.filter((t) => t.status === 'in_progress').length;\n    const completed = items.filter((t) => t.status === 'completed').length;\n\n    return {\n      total,\n      pending,\n      in_progress,\n      completed,\n      last_updated: new Date().toISOString(),\n    };\n  }\n\n  async getTodoContext(taskId: string): Promise<string> {\n    const todos = await this.readTodos(taskId);\n    if (!todos || todos.items.length === 0) {\n      return '';\n    }\n\n    const lines: string[] = ['## Previous Todo List\\n'];\n    lines.push('You previously created the following todo list:\\n');\n\n    for (const item of todos.items) {\n      const statusIcon =\n        item.status === 'completed' ? '✓' : item.status === 'in_progress' ? '▶' : '○';\n      lines.push(`${statusIcon} [${item.status}] ${item.content}`);\n    }\n\n    lines.push(\n      `\\nProgress: ${todos.metadata.completed}/${todos.metadata.total} completed\\n`\n    );\n\n    return lines.join('\\n');\n  }\n\n  // check for TodoWrite tool call and persist if found\n  async checkAndPersistFromMessage(\n    message: any,\n    taskId: string\n  ): Promise<TodoList | null> {\n    if (message.type !== 'assistant' || !message.message?.content) {\n      return null;\n    }\n\n    for (const block of message.message.content) {\n      if (block.type === 'tool_use' && block.name === 'TodoWrite') {\n        try {\n          this.logger.info('TodoWrite detected, persisting todos', { taskId });\n\n          const todoList = this.parseTodoWriteInput(block.input);\n          await this.writeTodos(taskId, todoList);\n\n          this.logger.info('Persisted todos successfully', {\n            taskId,\n            total: todoList.metadata.total,\n            completed: todoList.metadata.completed,\n          });\n\n          return todoList;\n        } catch (error) {\n          this.logger.error('Failed to persist todos', {\n            taskId,\n            error: error instanceof Error ? error.message : String(error),\n          });\n          return null;\n        }\n      }\n    }\n\n    return null;\n  }\n}\n"],"names":[],"mappings":"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"}